Notebook[{

Cell[CellGroupData[{
Cell["Begin Package", \
"Section",ExpressionUUID->"39e9dbc5-5d7b-4441-82c6-0811eadac5b2"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", 
   RowBox[{"\"\<BipedalLocomotion`Model`\>\"", ",", " ", 
    RowBox[{"{", 
     RowBox[{
     "\"\<GlobalVariables`\>\"", ",", " ", "\"\<RigidBodyDynamics`\>\"", ",", 
      " ", "\"\<BipedalLocomotion`\>\""}], "}"}]}], "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"2b48c04c-aed4-40f4-8f8c-f7daa783cbb0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["TODO", "Section",ExpressionUUID->"8767b11c-fdff-4748-8e50-432d57835293"],

Cell["\<\
xT still doesn\[CloseCurlyQuote]t work.  code assumes in 3D that x, y, z hasn\
\[CloseCurlyQuote]t rotated. try floating base with values {rx, ry, rz} = \
{0.06, 0.3, -1.6} and all other values zero then call BLmxcp and BLmxc0.  It \
might help to view the base frame as being at the foot than where fb actually \
is.  The notion of x,y,z might have to be aligned with foot frame and not fb \
frame.\
\>", "Text",ExpressionUUID->"db1dd43a-a389-4a78-9727-8f0311f9b342"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Model", \
"Section",ExpressionUUID->"a37a045c-eda3-4c7a-b220-791d1c2a1f8d"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"comcon", "[", 
    RowBox[{"n_", ",", " ", "v_", ",", " ", 
     RowBox[{"p_:", "True"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"lnks", ",", " ", "mtot", ",", " ", "b", ",", " ", "N"}], "}"}],
      ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{"n", ",", " ", "v", ",", " ", 
        RowBox[{"Expand", " ", "\[Rule]", " ", "False"}], ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "p"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"lnks", " ", "=", " ", 
       RowBox[{"Rest", "@", 
        RowBox[{"RBDLinks", "[", "]"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"mtot", " ", "=", " ", 
       RowBox[{"Total", "@", 
        RowBox[{"lnks", "\[LeftDoubleBracket]", 
         RowBox[{"All", ",", " ", "10"}], "\[RightDoubleBracket]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{
        RowBox[{"\[DoubleStruckB]", "[", 
         RowBox[{
          RowBox[{
          "#1", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
          " ", 
          RowBox[{
           RowBox[{
            RowBox[{
            "#1", "\[LeftDoubleBracket]", "10", "\[RightDoubleBracket]"}], 
            "/", "mtot"}], " ", 
           RowBox[{
           "I6", "\[LeftDoubleBracket]", "#2", "\[RightDoubleBracket]"}]}], 
          ",", " ", 
          RowBox[{"#1", "\[LeftDoubleBracket]", 
           RowBox[{"14", ";;", "16"}], "\[RightDoubleBracket]"}]}], "]"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{"RBDVirtQ", "[", 
         RowBox[{"n", ",", " ", 
          RowBox[{"b", "[", 
           RowBox[{"i", ",", " ", "j"}], "]"}], ",", " ", 
          RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
           RowBox[{"j", "+", "1"}]}], ",", " ", 
          RowBox[{"Expand", " ", "\[Rule]", " ", "False"}], ",", " ", 
          RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "p"}]}], "]"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "lnks"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"j", ",", " ", 
          RowBox[{"{", 
           RowBox[{"4", ",", " ", "5"}], "}"}]}], "}"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"331ede6a-a05a-4b37-9f23-59aff396b140"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"rbdind", " ", "=", " ", 
    RowBox[{"Function", "[", 
     RowBox[{"x", ",", " ", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"IntegerQ", "@", "x"}], ",", " ", "x", ",", " ", 
        RowBox[{"RBDGetIndex", "@", "x"}]}], "]"}], ",", " ", "Listable"}], 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"regime", "[", 
    RowBox[{"name_", ",", " ", "data_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "P", ",", " ", "V", ",", " ", "B", ",", " ", "M", ",", " ", "\[Theta]", 
       ",", " ", "Pcon", ",", " ", "n\[Mu]T", ",", " ", "dt", ",", " ", "J", 
       ",", " ", "n", ",", " ", "m", ",", " ", "so\[Theta]", ",", " ", "PT", 
       ",", " ", "Pd", ",", " ", "Vd", ",", " ", "S", ",", " ", "I"}], "}"}], 
     ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"P", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<P\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"V", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<V\>\"", "]"}]}], ";", " ", 
      "\[IndentingNewLine]", 
      RowBox[{"B", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<B\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"I", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<I\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"M", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<M\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"\[Theta]", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<\[Theta]\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Pcon", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<Pcon\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"dt", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<dt\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"n\[Mu]T", " ", "=", " ", 
       RowBox[{
        RowBox[{"data", "[", "\"\<n\[Mu]\>\"", "]"}], " ", "+", " ", 
        RowBox[{"Length", "@", 
         RowBox[{"Select", "[", 
          RowBox[{
           RowBox[{"DeleteDuplicates", "@", "dt"}], ",", " ", 
           RowBox[{
            RowBox[{"#", "\[NotEqual]", " ", "0"}], "&"}]}], "]"}]}]}]}], ";",
       "\[IndentingNewLine]", 
      RowBox[{"J", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<J[p]\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"S", " ", "=", " ", 
       RowBox[{"data", "[", "\"\<S\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"stance", " ", "foot", " ", "constraints"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-p\>\""}], ",", " ", "P"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"virtual", " ", "constraints"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-v\>\""}], ",", " ", "V"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"transmission", " ", "matrix"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"RBDTranV", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-u\>\""}], ",", " ", "B"}], 
       "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "impacts", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-i\>\""}], ",", " ", "I"}], 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"trajectory", " ", "to", " ", "follow"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{
       "\[Theta]", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"so\[Theta]", " ", "=", " ", 
       RowBox[{
        RowBox[{"(", 
         RowBox[{
          RowBox[{"n", "\[LeftDoubleBracket]", 
           RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}], " ", "-", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
            "n", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], ",", 
            " ", "0"}], "}"}]}], ")"}], "/", 
        RowBox[{"(", 
         RowBox[{
          RowBox[{"n", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}],
           "-", 
          RowBox[{
          "n", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}]}], 
         ")"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"PT", " ", "=", " ", 
       RowBox[{"PolynomialTrajectory", "[", 
        RowBox[{"M", ",", " ", "so\[Theta]", ",", " ", 
         RowBox[{"\"\<c\>\"", " ", "\[Rule]", " ", 
          RowBox[{"nx", "+", "1"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Length", "[", "P", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Length", "[", "M", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Pd", " ", "=", " ", 
       RowBox[{"PT", "\[LeftDoubleBracket]", 
        RowBox[{"\"\<\[Eta]d\>\"", ",", " ", 
         RowBox[{"1", ";;", "n"}]}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Vd", " ", "=", " ", 
       RowBox[{"PT", "\[LeftDoubleBracket]", 
        RowBox[{"\"\<\[Eta]d\>\"", ",", " ", 
         RowBox[{
          RowBox[{"n", "+", "1"}], ";;", "m"}]}], "\[RightDoubleBracket]"}]}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"add", " ", "trajectories", " ", "as", " ", "constraints"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-b\>\""}], ",", " ", 
        RowBox[{"-", "Pd"}], ",", " ", 
        RowBox[{"Thread", "[", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Range", "[", "n", "]"}]}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-b\>\""}], ",", " ", 
        RowBox[{"-", "Vd"}], ",", " ", 
        RowBox[{"Thread", "[", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Range", "[", 
           RowBox[{
            RowBox[{"n", "+", "1"}], ",", " ", "m"}], "]"}]}], "]"}]}], "]"}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"\[Eta]", " ", "constraints"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"w", "/", " ", "no"}], " ", "coefficients"}], ",", " ", 
        RowBox[{"get", " ", 
         RowBox[{"(", 
          RowBox[{"h0", ",", " ", "h0dot"}], ")"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]0\>\""}], ",", " ", "P", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]0\>\""}], ",", " ", "V", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]T\>\""}], ",", " ", "P", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]T\>\""}], ",", " ", "V", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"w", "/", " ", "coefficients"}], ",", " ", 
        RowBox[{"get", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"h0", "-", "hd"}], ",", " ", 
           RowBox[{"h0dot", "-", "hddot"}]}], ")"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Length", "[", "P", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]p\>\""}], ",", " ", "P", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]p\>\""}], ",", " ", 
        RowBox[{"-", "Pd"}], ",", " ", 
        RowBox[{"Thread", "[", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Range", "[", "n", "]"}]}], "]"}], ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Length", "@", "V"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]v\>\""}], ",", " ", "V", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]v\>\""}], ",", " ", 
        RowBox[{"-", "Vd"}], ",", " ", 
        RowBox[{"Thread", "[", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", 
          RowBox[{"Range", "[", "n", "]"}]}], "]"}], ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"each", " ", "component", " ", "individually"}], ",", " ", 
        RowBox[{"get", " ", 
         RowBox[{"(", 
          RowBox[{"h0", ",", " ", "h0dot"}], ")"}], " ", "or", " ", 
         RowBox[{"(", 
          RowBox[{"hd", ",", " ", "hddot"}], ")"}]}]}], " ", "*)"}], 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]a\>\""}], ",", " ", "P", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]a\>\""}], ",", " ", "V", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]d\>\""}], ",", " ", "Pd", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"RBDVirtQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]d\>\""}], ",", " ", "Vd", 
        ",", " ", 
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "slopes", " ", "given", " ", "stance", " ", "and", " ", "swing", " ", 
        "foot", " ", "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"RBDConQ", "[", 
       RowBox[{
        RowBox[{"name", " ", "<>", " ", "\"\<-\[Sigma]\>\""}], ",", " ", 
        "S"}], "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "data", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"name", " ", "<>", " ", "\"\<-\>\"", " ", "<>", "  ", "#"}], 
         "&"}], " ", "/@", " ", 
        RowBox[{"{", 
         RowBox[{
         "\"\<p\>\"", ",", " ", "\"\<v\>\"", ",", " ", "\"\<u\>\"", ",", " ", 
          "\"\<b\>\"", ",", " ", "\"\<\[Eta]0\>\"", ",", " ", 
          "\"\<\[Eta]T\>\"", ",", " ", "\"\<\[Eta]p\>\"", ",", " ", 
          "\"\<\[Eta]v\>\""}], "}"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
        "\"\<\[Alpha]0\>\"", ",", " ", "\"\<\[Alpha]T\>\"", ",", " ", 
         "\"\<\[Alpha]f\>\""}], "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"<|", 
        RowBox[{"MapThread", "[", 
         RowBox[{"Rule", ",", " ", 
          RowBox[{"{", 
           RowBox[{"m", ",", " ", 
            RowBox[{"Values", "@", 
             RowBox[{"PT", "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                "\"\<\[Eta]0\>\"", ",", " ", "\"\<\[Eta]T\>\"", ",", " ", 
                 "\"\<\[Alpha]\>\""}], "}"}], ",", " ", "1"}], 
              "\[RightDoubleBracket]"}]}]}], "}"}]}], "]"}], "|>"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"RBDParameters", "[", 
       RowBox[{"nx", " ", "+", " ", "n\[Mu]T", " ", "+", " ", 
        RowBox[{"Length", "[", 
         RowBox[{"PT", "[", "\"\<c\>\"", "]"}], "]"}]}], "]"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"<|", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"\"\<f\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"n", "\[LeftDoubleBracket]", 
            RowBox[{"1", ";;", "4"}], "\[RightDoubleBracket]"}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<h\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-i\>\""}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]0\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]0\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]T\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]T\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]p\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]p\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]v\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]v\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]a\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]a\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Eta]d\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]d\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<J[p]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]p\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Sigma]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Sigma]\>\""}]}], "|>"}]}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<B0\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{
           "n", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}], " ", 
           "\[Rule]", " ", 
           RowBox[{"PT", "[", "\"\<B0\>\"", "]"}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Alpha]0\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{
           "n", "\[LeftDoubleBracket]", "5", "\[RightDoubleBracket]"}], " ", 
           "\[Rule]", " ", 
           RowBox[{
           "PT", "\[LeftDoubleBracket]", "\"\<\[Eta]0\>\"", 
            "\[RightDoubleBracket]"}]}], "|>"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<BT\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{
           "n", "\[LeftDoubleBracket]", "6", "\[RightDoubleBracket]"}], " ", 
           "\[Rule]", " ", 
           RowBox[{"PT", "[", "\"\<BT\>\"", "]"}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Alpha]T\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{
           "n", "\[LeftDoubleBracket]", "6", "\[RightDoubleBracket]"}], " ", 
           "\[Rule]", " ", 
           RowBox[{
           "PT", "\[LeftDoubleBracket]", "\"\<\[Eta]T\>\"", 
            "\[RightDoubleBracket]"}]}], "|>"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Alpha]\[Theta]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"name", " ", "<>", " ", "\"\<-i\>\""}], " ", "\[Rule]", 
           " ", 
           RowBox[{
           "\[Theta]", "\[LeftDoubleBracket]", "2", 
            "\[RightDoubleBracket]"}]}], "|>"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Alpha]J[p]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{"name", " ", "<>", " ", "\"\<-\[Eta]p\>\""}], " ", 
           "\[Rule]", " ", "J"}], "|>"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Theta]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"rbdind", "@", 
            RowBox[{"\[Theta]", "\[LeftDoubleBracket]", 
             RowBox[{"1", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", "3", ",", "4"}], "}"}]}], 
             "\[RightDoubleBracket]"}]}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<t\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", "dt"}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<nc\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", "nc"}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<np\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"Length", "[", "P", "]"}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<nv\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"Length", "[", "V", "]"}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<nu\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", 
           RowBox[{"Length", "[", "B", "]"}]}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<P\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{
           RowBox[{
           "n", "\[LeftDoubleBracket]", "3", "\[RightDoubleBracket]"}], " ", 
           "\[Rule]", " ", "Pcon"}], "|>"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{"\"\<\[Alpha]\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", "m"}], "|>"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"\"\<M\>\"", " ", "\[Rule]", " ", 
         RowBox[{"<|", 
          RowBox[{"name", " ", "\[Rule]", " ", "M"}], "|>"}]}]}], 
       "\[IndentingNewLine]", "|>"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"4d2ab6da-f0c0-4056-a30a-f20e5b00d6da"],

Cell["\<\
The goal of xT is given mode m at switching time t = t[i]+ (a post-impact \
time), compute the state of the robot xT at t = t[i+1]- before switching to \
the next mode algebraically.

We can compute xT without simulating the system using geometric arguments, \
periodicity conditions, and the fact that we are only switching between two \
modes that cause jumps, e.g., modes \[OpenCurlyDoubleQuote]right\
\[CloseCurlyDoubleQuote] and \[OpenCurlyDoubleQuote]left\
\[CloseCurlyDoubleQuote].  The routine works for 2D and 3D bipeds.  The key \
is knowing the pre-impact state at t = t[i]-, applying the flip operator A, \
and carefully updating the velocities of the floating base.\
\>", "Text",ExpressionUUID->"ba79f0bb-7ee5-4050-b8c3-31bbe71342a9"],

Cell[BoxData[
 RowBox[{
  RowBox[{"xT", "[", 
   RowBox[{"name_", ",", " ", "data_"}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
     "ST", ",", " ", "SW", ",", " ", "A", ",", " ", "\[Theta]T", ",", " ", 
      "n", ",", " ", "m", ",", " ", "qT", ",", " ", "vsw", ",", " ", "vst", 
      ",", " ", "o"}], "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"called", " ", "with", " ", "post"}], "-", 
      RowBox[{"impact", " ", "stance", " ", "but", " ", "pre"}], "-", 
      RowBox[{"impact", " ", "state"}]}], " ", "*)"}], "\[IndentingNewLine]", 
    
    RowBox[{"(*", " ", 
     RowBox[{
      RowBox[{"in", " ", "other", " ", "words"}], ",", " ", 
      RowBox[{
       RowBox[{"function", " ", "is", " ", "called", " ", "with", " ", "m"}], 
       " ", "=", " ", 
       RowBox[{"m", 
        RowBox[{"(", 
         RowBox[{"0", "^", "+"}], ")"}]}]}], ",", " ", 
      RowBox[{
       RowBox[{"but", " ", "c"}], " ", "=", " ", 
       RowBox[{"c", 
        RowBox[{"(", 
         RowBox[{"0", "^", "-"}], ")"}]}]}]}], " ", "*)"}], 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"ST", " ", "=", " ", 
      RowBox[{"data", "[", "\"\<ST\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"SW", " ", "=", " ", 
      RowBox[{"data", "[", "\"\<SW\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
     
     RowBox[{"A", " ", "=", " ", 
      RowBox[{"data", "[", "\"\<A\>\"", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"\[Theta]T", " ", "=", " ", 
      RowBox[{"data", "[", "\"\<\[Theta]T\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"o", " ", "=", " ", 
      RowBox[{"Sequence", "[", 
       RowBox[{
        RowBox[{"\"\<\[Phi]\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
        RowBox[{"\"\<Kp\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
        RowBox[{"\"\<Kv\>\"", " ", "\[Rule]", " ", "0"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"A", " ", "===", " ", 
        RowBox[{"{", "}"}]}], ",", " ", 
       RowBox[{"Throw", "@", "$Failed"}]}], "]"}], ";", "\[IndentingNewLine]",
      "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"compute", " ", "x", 
        RowBox[{"(", 
         RowBox[{"T", "-"}], ")"}]}], " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"A", ".", "x"}], 
         RowBox[{"(", 
          RowBox[{"0", "-"}], ")"}]}], " ", "+", " ", "b"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "the", " ", "configurations", " ", "are", " ", "straightforward"}], 
       ",", " ", 
       RowBox[{"just", " ", "apply", " ", 
        RowBox[{"A", ".", "q"}], 
        RowBox[{"(", 
         RowBox[{"0", "-"}], ")"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"qT", " ", "=", " ", 
      RowBox[{
       RowBox[{"A", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"1", ";;", "nq"}], ",", " ", 
         RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], ".", 
       RowBox[{"RBDGetValue", "[", 
        RowBox[{"1", ",", " ", "nq", ",", " ", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}]}]}], 
     ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "apparently", " ", "this", " ", "formula", " ", "is", " ", "just", " ", 
       "given", " ", "by", " ", "user", " ", "symbolically"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"\[Theta]", " ", "=", " ", "\[Theta]T"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"m", " ", "=", " ", 
      RowBox[{"RBDGetIndex", "[", 
       RowBox[{"\[DoubleStruckQ]", "[", 
        RowBox[{"\"\<\[Theta]\>\"", ",", " ", "1"}], "]"}], "]"}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"qT", "\[LeftDoubleBracket]", "m", "\[RightDoubleBracket]"}], 
      " ", "=", " ", "\[Theta]T"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"n", " ", "=", " ", 
      RowBox[{"name", " ", "<>", " ", "\"\<-xT\>\""}]}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"RBDConQ", "[", 
      RowBox[{"n", " ", ",", " ", "qT", ",", " ", "o"}], "]"}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{
      "will", " ", "also", " ", "generate", " ", "velocity", " ", 
       "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"is", " ", "\[Theta]T", " ", "a", " ", 
       RowBox[{
        RowBox[{"constant", "?", " ", "don"}], "'"}], "t", " ", "change", " ", 
       RowBox[{"velocity", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"PossibleZeroQ", "@", 
        RowBox[{"Norm", "@", 
         RowBox[{"D", "[", 
          RowBox[{"\[Theta]T", ",", " ", 
           RowBox[{"{", 
            RowBox[{"RBDGetValue", "[", 
             RowBox[{"1", ",", " ", "nq", ",", " ", 
              RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], "]"}], 
            "}"}]}], "]"}]}]}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{"RBDConV", "[", 
        RowBox[{"n", ",", " ", 
         RowBox[{"\[DoubleStruckV]", "[", 
          RowBox[{"\"\<\[Theta]\>\"", ",", " ", "1"}], "]"}], ",", " ", 
         RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "m"}], ",", " ", "o"}], 
        "]"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "the", " ", "following", " ", "is", " ", "meant", " ", "to", " ", 
       "address", " ", "3", "D", " ", "bipeds", " ", "using", " ", "the", " ",
        "vector", " ", "r"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "when", " ", "the", " ", "robot", " ", "walks", " ", "forward"}], ",", 
       " ", 
       RowBox[{"the", " ", "position", " ", "variables"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "in", " ", "the", " ", "sagittal", " ", "walking", " ", "plane", " ", 
        "translate", " ", "forward"}], ",", " ", "while"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "the", " ", "motion", " ", "perpendicular", " ", "to", " ", "the", " ", 
       "plane", " ", "is", " ", "reflected", " ", "about", " ", "the"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"walking", " ", "plane"}], " ", "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{
         RowBox[{"x", "[", 
          RowBox[{"T", "-"}], "]"}], ",", " ", 
         RowBox[{"y", "[", 
          RowBox[{"T", "-"}], "]"}], ",", " ", 
         RowBox[{"z", "[", 
          RowBox[{"T", "-"}], "]"}]}], ")"}], " ", "=", " ", 
       RowBox[{
        RowBox[{"swing", "[", 
         RowBox[{"0", "-"}], "]"}], " ", "+", " ", 
        RowBox[{"r", " ", 
         RowBox[{"(", 
          RowBox[{
           RowBox[{"p", "[", 
            RowBox[{"0", "-"}], "]"}], " ", "-", " ", 
           RowBox[{"stance", "[", 
            RowBox[{"0", "-"}], "]"}]}], ")"}]}]}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"1", ",", " ", 
           RowBox[{"-", "1"}], ",", " ", "1"}], "}"}], " ", "assuming", " ", 
         "walking", " ", "occurs", " ", "in", " ", "x"}], "-", 
        RowBox[{"z", " ", "plane"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"p", "[", 
        RowBox[{"0", "-"}], "]"}], " ", "=", " ", 
       RowBox[{"(", 
        RowBox[{
         RowBox[{"x", "[", 
          RowBox[{"0", "-"}], "]"}], ",", " ", 
         RowBox[{"y", "[", 
          RowBox[{"0", "-"}], "]"}], ",", " ", 
         RowBox[{"z", "[", 
          RowBox[{"0", "-"}], "]"}]}], ")"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "need", " ", "to", " ", "flip", " ", "sign", " ", "on", " ", "ST"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"ST", " ", "=!=", " ", 
        RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"m", " ", "=", " ", 
         RowBox[{"data", "[", "\"\<|_\>\"", "]"}]}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{"multiplier", " ", "for", " ", "r", " ", "in", " ", "ST"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"m", " ", "===", " ", "Automatic"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m", " ", "=", " ", 
            RowBox[{"BLIndices", "[", 
             RowBox[{
              RowBox[{"BLGetBipedBase", "[", "]"}], ",", " ", "\"\<p\>\""}], 
             "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"m", " ", "=", " ", 
            RowBox[{"Pick", "[", 
             RowBox[{
              RowBox[{"Range", "@", 
               RowBox[{"Length", "@", "m"}]}], ",", " ", 
              RowBox[{"Diagonal", "[", 
               RowBox[{"A", "\[LeftDoubleBracket]", 
                RowBox[{"m", " ", ",", "m"}], "\[RightDoubleBracket]"}], 
               "]"}], ",", " ", 
              RowBox[{"_", "?", "Positive"}]}], "]"}]}], ";"}]}], 
         "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "we", " ", "can", " ", "apply", " ", "math", " ", "operations", " ", 
          "with", " ", "resulting", " ", "Jacobians", " ", "using", " ", 
          "r"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"ST", "\[LeftDoubleBracket]", "m", "\[RightDoubleBracket]"}],
          " ", "=", " ", 
         RowBox[{
          RowBox[{
          "ST", "\[LeftDoubleBracket]", "m", "\[RightDoubleBracket]"}], " ", "/.",
           " ", 
          RowBox[{
           RowBox[{"\[DoubleStruckB]", "[", 
            RowBox[{"b_", ",", " ", "r_", ",", " ", "o___"}], "]"}], " ", 
           "\[RuleDelayed]", " ", 
           RowBox[{"\[DoubleStruckB]", "[", 
            RowBox[{"b", ",", " ", 
             RowBox[{"-", "r"}], ",", " ", "o"}], "]"}]}]}]}], ";"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "remove", " ", "velocities", " ", "due", " ", "to", " ", "ST", " ", 
       "and", " ", "SW"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"vsw", ",", " ", "vst"}], "}"}], " ", "=", " ", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"SW", ",", " ", "ST"}], "}"}], " ", "/.", " ", 
       RowBox[{
        RowBox[{"\[DoubleStruckB]", "[", 
         RowBox[{"b_", ",", " ", "r_", ",", " ", "o___"}], "]"}], " ", 
        "\[RuleDelayed]", " ", 
        RowBox[{
         RowBox[{"\[DoubleStruckB]", "'"}], "[", 
         RowBox[{"b", ",", " ", 
          RowBox[{"-", "r"}], ",", " ", "o"}], "]"}]}]}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"as", " ", "holonomic", " ", "constraints"}], ",", " ", 
       RowBox[{
       "ST", " ", "and", " ", "SW", " ", "add", " ", "their", " ", 
        "velocities"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "to", " ", "the", " ", "resulting", " ", "output", " ", "function", 
        " ", "\[Eta]"}], ",", " ", 
       RowBox[{
       "so", " ", "we", " ", "subtract", " ", "with", " ", "vsw", " ", "and", 
        " ", "vst"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "this", " ", "is", " ", "another", " ", "example", " ", "of", " ", 
       "performing", " ", "basic", " ", "math", " ", "with", " ", 
       "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"add", " ", "ST", " ", "and", " ", "SW", " ", "constraints"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"m", " ", "=", " ", 
      RowBox[{"BLIndices", "[", 
       RowBox[{
        RowBox[{"BLGetBipedBase", "[", "]"}], ",", " ", "\"\<p\>\""}], 
       "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"m", " ", "=", " ", 
      RowBox[{"Thread", "[", 
       RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "m"}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", "stance", " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "ST"}], " ", "\[NotEqual]", " ", 
        RowBox[{"Length", "@", "m"}]}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"RBDConQ", "[", 
          RowBox[{"n", ",", " ", "ST", ",", " ", "#", ",", " ", "o"}], "]"}], 
         "&"}], " ", "/@", " ", "m"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{"RBDConQ", "[", 
        RowBox[{"n", ",", " ", "ST", ",", " ", "m", ",", " ", "o"}], "]"}]}], 
      "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "vst"}], " ", "\[NotEqual]", " ", 
        RowBox[{"Length", "@", "m"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"RBDConV", "[", 
          RowBox[{"n", ",", " ", "vst", ",", " ", "#", ",", " ", "o"}], "]"}],
          "&"}], " ", "/@", " ", "m"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"RBDConV", "[", 
         RowBox[{"n", ",", " ", "vst", ",", " ", "m", ",", " ", "o"}], "]"}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", "swing", " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "SW"}], " ", "\[NotEqual]", " ", 
        RowBox[{"Length", "@", "m"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"RBDConQ", "[", 
          RowBox[{"n", ",", " ", "SW", ",", " ", "#", ",", " ", "o"}], "]"}], 
         "&"}], " ", "/@", " ", "m"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"RBDConQ", "[", 
         RowBox[{"n", ",", " ", "SW", ",", " ", "m", ",", " ", "o"}], "]"}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Length", "@", "vsw"}], " ", "\[NotEqual]", " ", 
        RowBox[{"Length", "@", "m"}]}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"RBDConV", "[", 
          RowBox[{"n", ",", " ", "vsw", ",", " ", "#", ",", " ", "o"}], "]"}],
          "&"}], " ", "/@", " ", "m"}], ",", " ", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"RBDConV", "[", 
         RowBox[{"n", ",", " ", "vsw", ",", " ", "m", ",", " ", "o"}], "]"}], 
        ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"<|", 
      RowBox[{"\"\<xT\>\"", " ", "\[Rule]", " ", 
       RowBox[{"<|", 
        RowBox[{"name", " ", "\[Rule]", " ", "n"}], "|>"}]}], "|>"}]}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"1e4e6e5c-fc85-48fa-b29a-57343d88467c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BLRegime", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<P\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<V\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<B\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<I\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<M\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<\[Theta]\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\[DoubleStruckQ]", "[", 
            RowBox[{"\"\<\[Theta]\>\"", ",", " ", "1"}], "]"}], ",", " ", 
           RowBox[{"\[DoubleStruckV]", "[", 
            RowBox[{"\"\<\[Theta]\>\"", ",", " ", "1"}], "]"}], ",", " ", "0",
            ",", " ", 
           RowBox[{"\[DoubleStruckC]", "[", 
            RowBox[{"-", "1"}], "]"}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"0", ",", " ", "0"}], "}"}]}], "}"}]}], ",", " ", 
      RowBox[{"\"\<Pcon\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<n\[Mu]\>\"", " ", "\[Rule]", " ", "0"}], ",", " ", 
      RowBox[{"\"\<dt\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", 
        RowBox[{"0", ",", " ", 
         RowBox[{"-", "1"}]}], "}"}]}], ",", " ", 
      RowBox[{"\"\<J[p]\>\"", " ", "\[RuleDelayed]", "  ", "Automatic"}], ",",
       " ", 
      RowBox[{"\"\<S\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"Association", " ", "\[Rule]", " ", 
       RowBox[{"<|", "|>"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"BLRegime", "[", 
     RowBox[{"name_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"r", ",", " ", "K"}], "}"}], ",", " ", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"defaults", " ", "for", " ", "\[Theta]"}], " ", "&"}], " ", 
         "dt", " ", "assume", " ", "one", " ", "switching", " ", "time"}], 
        ";", " ", 
        RowBox[{
         RowBox[{"J", "[", "p", "]"}], " ", "assumes", " ", "6", "D", " ", 
         RowBox[{"base", "."}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"r", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "Association", "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"K", " ", "=", " ", 
        RowBox[{"Select", "[", 
         RowBox[{
          RowBox[{"Keys", "@", 
           RowBox[{"Options", "@", "BLRegime"}]}], ",", " ", "StringQ"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"r", "[", "k", "]"}], " ", "=", " ", 
           RowBox[{"OptionValue", "[", "k", "]"}]}], ";"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"k", ",", " ", "K"}], "}"}]}], "]"}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"r", "[", "\"\<J[p]\>\"", "]"}], " ", "===", " ", 
          "Automatic"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"K", " ", "=", " ", 
           RowBox[{"BLIndices", "[", 
            RowBox[{
             RowBox[{"BLGetBipedBase", "[", "]"}], ",", " ", "\"\<p\>\""}], 
            "]"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"r", "[", "\"\<J[p]\>\"", "]"}], " ", "=", " ", 
           RowBox[{"{", 
            RowBox[{"K", ",", " ", 
             RowBox[{"Range", "@", 
              RowBox[{"Length", "@", "K"}]}]}], "}"}]}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"expand", " ", "constraints"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"r", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"r", ",", " ", 
          RowBox[{"BLConstraints", "[", 
           RowBox[{
            RowBox[{"r", "[", "\"\<P\>\"", "]"}], ",", " ", 
            RowBox[{"r", "[", "\"\<V\>\"", "]"}], ",", " ", 
            RowBox[{"r", "[", "\"\<S\>\"", "]"}], ",", " ", 
            RowBox[{"r", "[", "\"\<B\>\"", "]"}], ",", " ", 
            RowBox[{"r", "[", "\"\<I\>\"", "]"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"<|", 
        RowBox[{"name", " ", "\[Rule]", " ", "r"}], "|>"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLConstraints", "[", 
    RowBox[{"P_", ",", " ", "V_", ",", " ", "S_", ",", " ", 
     RowBox[{"B_:", "Automatic"}], ",", " ", 
     RowBox[{"I_:", "Automatic"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "p", ",", " ", "v", ",", " ", "b", ",", " ", "i", ",", 
       " ", "s", ",", " ", "M"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"MemberQ", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]", ",", " ", 
              "\[DoubleStruckB]", ",", " ", "Plus"}], "}"}], ",", " ", 
            RowBox[{"Head", "[", "#", "]"}]}], "]"}], ",", " ", "#", ",", " ",
           "\[IndentingNewLine]", 
          RowBox[{"VectorQ", "@", "#"}], ",", " ", 
          RowBox[{"BLValues", "@@", "#"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "[", "#", "]"}], " ", "\[Equal]", " ", "2"}], 
           " ", "&&", " ", 
           RowBox[{"StringQ", "[", 
            RowBox[{
            "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
            "]"}]}], ",", " ", 
          RowBox[{
           RowBox[{"BLFeet", "[", 
            RowBox[{"#", ",", " ", "Automatic"}], "]"}], "[", "1", "]"}], ",",
           "\[IndentingNewLine]", "True", ",", " ", 
          RowBox[{"BLValues", "@", "#"}]}], "]"}], "&"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "constraints", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{"KeySort", "@", "P"}], ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{"KeySort", "@", "V"}], ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Map", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{"KeySort", "@", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"I", " ", "===", " ", "Automatic"}], ",", " ", "P", ",", 
            " ", "I"}], "]"}]}], ",", " ", 
         RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"polynomial", " ", "degrees"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"Merge", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"p", ",", " ", "v"}], "}"}], ",", " ", 
         RowBox[{
          RowBox[{"Join", "@@", "#"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"M", " ", "=", " ", 
       RowBox[{"KeyValueMap", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"ConstantArray", "[", 
           RowBox[{"#1", ",", " ", 
            RowBox[{"Length", "@", 
             RowBox[{"Flatten", "@", "#2"}]}]}], "]"}], "&"}], ",", " ", 
         "b"}], "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "reshape", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Values", "@", "p"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Values", "@", "v"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Values", "@", "i"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"M", " ", "=", " ", 
       RowBox[{"Flatten", "@", "M"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"transmission", " ", "matrix"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"B", " ", "===", " ", "Automatic"}], ",", " ", 
         RowBox[{"v", " ", "/.", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
            "\[DoubleStruckQ]", " ", "\[Rule]", " ", "\[DoubleStruckV]"}], 
            ",", " ", 
            RowBox[{"\[DoubleStruckB]", " ", "\[Rule]", " ", 
             RowBox[{
              RowBox[{"Derivative", "[", "1", "]"}], "[", "\[DoubleStruckB]", 
              "]"}]}]}], "}"}]}], ",", " ", "B"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"s", " ", "=", " ", 
       RowBox[{"Range", "@", 
        RowBox[{"Length", "@", "S"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"s", " ", "=!=", " ", 
         RowBox[{"{", "}"}]}], ",", " ", 
        RowBox[{
         RowBox[{"s", " ", "=", " ", 
          RowBox[{"Flatten", "@", 
           RowBox[{"Values", "[", 
            RowBox[{
             RowBox[{"BLFeet", "[", 
              RowBox[{"S", ",", " ", "3"}], "]"}], "\[LeftDoubleBracket]", 
             RowBox[{"Thread", "@", 
              RowBox[{"Key", "@", "s"}]}], "\[RightDoubleBracket]"}], 
            "]"}]}]}], ";"}]}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"convert", " ", "to", " ", "indices", " ", "in", " ", "dof"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"MemberQ", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckB]", ",", " ", "Plus"}], "}"}], ",", " ", 
             RowBox[{"Head", "[", "x", "]"}]}], "]"}], ",", " ", "x", ",", 
           " ", 
           RowBox[{"RBDGetValue", "@", 
            RowBox[{"RBDGetIndex", "@", "x"}]}]}], "]"}], ",", " ", 
         "Listable"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "p", ",", " ", "v", ",", " ", "b", ",", " ", "s", ",", " ", "i"}], 
        "}"}], " ", "=", " ", 
       RowBox[{"f", "@", 
        RowBox[{"{", 
         RowBox[{
         "p", ",", " ", "v", ",", " ", "b", ",", " ", "s", ",", " ", "i"}], 
         "}"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Association", "@", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"\"\<P\>\"", " ", "\[Rule]", " ", "p"}], ",", " ", 
         RowBox[{"\"\<V\>\"", " ", "\[Rule]", "  ", "v"}], ",", " ", 
         RowBox[{"\"\<B\>\"", " ", "\[Rule]", " ", "b"}], ",", " ", 
         RowBox[{"\"\<M\>\"", "  ", "\[Rule]", " ", "M"}], ",", " ", 
         RowBox[{"\"\<I\>\"", " ", "\[Rule]", " ", "i"}], ",", " ", 
         RowBox[{"\"\<S\>\"", " ", "\[Rule]", " ", "s"}]}], "}"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"6581f980-0474-40b9-bc45-2a130b8935f0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "BLxT", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<ST\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<SW\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<A\>\"", " ", "\[Rule]", " ", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\"\<|_\>\"", " ", "\[Rule]", "  ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<\[Theta]T\>\"", " ", "\[Rule]", " ", 
       RowBox[{"\[DoubleStruckC]", "[", 
        RowBox[{"-", "1"}], "]"}]}], ",", " ", 
      RowBox[{"Association", " ", "\[Rule]", " ", 
       RowBox[{"<|", "|>"}]}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BLxT", "[", 
    RowBox[{"name_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"r", ",", " ", "K"}], "}"}], ",", " ", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "Association", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"K", " ", "=", " ", 
       RowBox[{"Select", "[", 
        RowBox[{
         RowBox[{"Keys", "@", 
          RowBox[{"Options", "@", "BLxT"}]}], ",", " ", "StringQ"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"r", "[", "k", "]"}], " ", "=", " ", 
          RowBox[{"OptionValue", "[", "k", "]"}]}], ";"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"k", ",", " ", "K"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"expand", " ", "constraints"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{"r", ",", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"Lookup", "[", 
            RowBox[{
             RowBox[{"BLFeet", "[", 
              RowBox[{"#", ",", " ", "Automatic"}], "]"}], ",", " ", "1", ",",
              " ", 
             RowBox[{"{", "}"}]}], "]"}], "&"}], " ", "/@", " ", 
          RowBox[{"r", "\[LeftDoubleBracket]", 
           RowBox[{"{", 
            RowBox[{"\"\<ST\>\"", ",", " ", "\"\<SW\>\""}], "}"}], 
           "\[RightDoubleBracket]"}]}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"<|", 
       RowBox[{"name", " ", "\[Rule]", " ", "r"}], "|>"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"91d3715c-87c3-4846-9a5c-26f771c4e56f"],

Cell[BoxData[
 RowBox[{
  RowBox[{"BLCreateBiped", "[", 
   RowBox[{
   "name_", ",", " ", "C_", ",", " ", "XT_", ",", " ", "draw_", ",", " ", 
    "feet_", ",", " ", 
    RowBox[{"init_:", 
     RowBox[{"<|", "|>"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{"c", ",", " ", "x", ",", " ", "A"}], "}"}], ",", 
    "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"BLbiped", " ", "=", " ", 
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"<|", 
         RowBox[{
          RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "name"}], ",", " ", 
          RowBox[{"\"\<draw\>\"", " ", "\[Rule]", " ", "draw"}], ",", " ", 
          RowBox[{"\"\<feet\>\"", " ", "\[Rule]", " ", "feet"}]}], "|>"}], 
        ",", " ", "init"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"c", " ", "=", " ", 
      RowBox[{"KeyValueMap", "[", 
       RowBox[{"regime", ",", " ", "C"}], "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"x", " ", "=", " ", 
      RowBox[{"KeyValueMap", "[", 
       RowBox[{"xT", ",", " ", "XT"}], "]"}]}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"A", " ", "=", " ", 
      RowBox[{"Merge", "[", 
       RowBox[{
        RowBox[{"Join", "[", 
         RowBox[{"c", ",", " ", "x"}], "]"}], ",", " ", 
        RowBox[{
         RowBox[{"Join", "@@", "#"}], "&"}]}], "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blmfCon", "[", 
      RowBox[{"A", "[", "\"\<f\>\"", "]"}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"blmhCon", "[", 
      RowBox[{"A", "[", "\"\<h\>\"", "]"}], "]"}], ";", "\[IndentingNewLine]", 
     RowBox[{"blmxTCon", "[", 
      RowBox[{"A", "[", "\"\<xT\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]0Con", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]0\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blmB0Con", "[", 
      RowBox[{"A", "[", "\"\<B0\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blm\[Alpha]0Con", "[", 
      RowBox[{"A", "[", "\"\<\[Alpha]0\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]TCon", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]T\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blmBTCon", "[", 
      RowBox[{"A", "[", "\"\<BT\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blm\[Alpha]TCon", "[", 
      RowBox[{"A", "[", "\"\<\[Alpha]T\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blm\[Alpha]\[Theta]Con", "[", 
      RowBox[{"A", "[", "\"\<\[Alpha]\[Theta]\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]pCon", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]p\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]vCon", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]v\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]aCon", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]a\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blm\[Eta]dCon", "[", 
      RowBox[{"A", "[", "\"\<\[Eta]d\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blmJpCon", "[", 
      RowBox[{"A", "[", "\"\<J[p]\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{"blm\[Alpha]JpCon", "[", 
      RowBox[{"A", "[", "\"\<\[Alpha]J[p]\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"blmPCon", "[", 
      RowBox[{"A", "[", "\"\<P\>\"", "]"}], "]"}], ";", "\[IndentingNewLine]",
      "\[IndentingNewLine]", 
     RowBox[{"blmDTCon", "[", 
      RowBox[{"A", "[", "\"\<t\>\"", "]"}], "]"}], ";", "\[IndentingNewLine]",
      "\[IndentingNewLine]", 
     RowBox[{"blm\[Sigma]Con", "[", 
      RowBox[{"A", "[", "\"\<\[Sigma]\>\"", "]"}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"RBDParameters", "[", 
      RowBox[{"Max", "@", 
       RowBox[{"A", "[", "\"\<nc\>\"", "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"A", "\[LeftDoubleBracket]", 
       RowBox[{"\"\<nc\>\"", ",", " ", "All"}], "\[RightDoubleBracket]"}], 
      " ", "=", " ", "nc"}], ";", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"BLbiped", "[", "\"\<\[Alpha]\>\"", "]"}], " ", "=", " ", 
      RowBox[{"A", "[", "\"\<\[Alpha]\>\"", "]"}]}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", "A"}]}], 
   "\[IndentingNewLine]", "]"}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"0fa93f29-786a-4cb0-908d-f271b346de9f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"89ca9acb-4053-4b62-ae07-011985e5c6d0"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"4658df9e-a842-4ee0-aa85-339f6974490e"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1244, 1376},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

