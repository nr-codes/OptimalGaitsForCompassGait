Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"DifferentiateFunction", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "A", " ", "list", " ", "of", " ", "routines", " ", "that", " ", "will", 
      " ", "differentiate", " ", "various", " ", "NLink", " ", "functions", 
      " ", "to", " ", "C", " ", 
      RowBox[{"code", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2016", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", "the", " ", "Free", " ", "Software", " ", 
      "Foundation"}]}]}], ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 CellLabel->
  "In[327]:=",ExpressionUUID->"285b5be0-4653-45f0-a326-77e4a9dd6480"],

Cell["\<\
Note: any subfunctions in CreateSymbolString should contain no states.  The \
Block in one of the functions can mess with the local variables in the \
subfunction.

Note: Functions passed to DifferentiateFunction and friends should not use \
set statements where the lhs appears in the rhs.  This will lead to a subtle \
bug that produces the wrong derivative.  For example, the original CRB code \
as written in Featherstone\[CloseCurlyQuote]s RBD book has a line similar to

f = X.f;

The line is correctly differentiated as

f = X.f;
df = dX.f + X.df;

but this leads to the wrong derivative as the value of f expected in df needs \
to be the value before the assignment of the previous line.  The correct \
order would be

df = dX.f + X.df;
f = X.f;

or an introduction of new variable, fTemp, for example

fTemp = f;
f = X.fTemp;\
\>", "Text",ExpressionUUID->"d9a0edb2-dcac-486c-bd2d-201209e38aec"],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"f09cea84-d87d-49ec-a40b-0d936b6fdb75"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", "\"\<Derivatives`\>\"", "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DerivativeOrder", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CreateSymbolString", "::", "usage"}], " ", "=", " ", "\"\<\>\""}],
   ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CreateSymbol", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"TransformExpression", "::", "usage"}], " ", "=", " ", 
   "\"\<\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BlockExpression", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateFunction", "::", "usage"}], " ", "=", " ", 
   "\"\<\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MergeFunctions", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CheckSetStatements", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[328]:=",ExpressionUUID->"f59f84c0-b48f-4372-8e17-5a1474dbdc4f"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Dummy Hold Variable", \
"Section",ExpressionUUID->"98efe4b4-e822-4290-8973-17108c3ad40b"],

Cell[BoxData[
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"\[FormalP]", ",", " ", "HoldAll"}], "]"}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->"In[338]:=",ExpressionUUID->"32288a83-7fe1-4da6-9175-2cefd97af4cb"]
}, Open  ]],

Cell[CellGroupData[{

Cell["derivative type operations", \
"Section",ExpressionUUID->"6198731d-17f5-4fa8-8990-0e6211c5bea0"],

Cell["\<\
fixed bug with d\[LeftDoubleBracket]i\[RightDoubleBracket], which should be \
zero-th derivative returning as 1st direvative;  issues was with StringTake \
always taking last (-1) entry as oppose to n^th entry (or last appearance of \
d in string).

Might still have bug with LetterCharacter not accepting full range of valid \
variable names\
\>", "Text",ExpressionUUID->"d6689f11-7a7a-4a66-9003-1ad16449248d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"DerivativeOrder", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DerivativeOrder", "[", "x_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"s", ",", " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"s", " ", "=", " ", 
       RowBox[{"ToString", "@", 
        RowBox[{"Unevaluated", "@", "x"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"s", " ", "=", " ", 
       RowBox[{"Last", "@", 
        RowBox[{"StringSplit", "[", 
         RowBox[{"s", ",", " ", "\"\<`\>\""}], "]"}]}]}], ";", " ", 
      RowBox[{"(*", " ", 
       RowBox[{"remove", " ", "context", " ", "path"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Max", "[", 
        RowBox[{"StringPosition", "[", 
         RowBox[{"s", ",", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"StartOfString", "~~", 
             RowBox[{"\"\<d\>\"", ".."}]}], ")"}], "~~", 
           "LetterCharacter"}]}], "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"n", " ", ">", " ", "0"}], ",", " ", 
        RowBox[{"n", " ", "-", " ", "1"}], ",", " ", "0"}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[339]:=",ExpressionUUID->"54921280-b6a3-4c55-8686-1fcca14196df"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Symbols", \
"Section",ExpressionUUID->"e43f368c-3e06-4444-a498-90e1c76fd7d5"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"enforce", " ", "derivative", " ", "naming", " ", "convention"}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"CreateSymbolString", "[", 
      RowBox[{"x_String", ",", " ", 
       RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"d", " ", ">", " ", "0"}], ",", " ", 
       RowBox[{"StringInsert", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"StringRepeat", "[", 
          RowBox[{"\"\<d\>\"", ",", " ", "d"}], "]"}], ",", " ", 
         RowBox[{"Last", "@", 
          RowBox[{"Last", "@", 
           RowBox[{"StringPosition", "[", 
            RowBox[{
             RowBox[{"\"\<`\>\"", " ", "<>", " ", "x"}], ",", " ", 
             "\"\<`\>\""}], "]"}]}]}]}], "]"}], ",", " ", "x"}], "]"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CreateSymbolString", "[", 
      RowBox[{"x_Symbol", ",", " ", 
       RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"CreateSymbolString", "[", 
      RowBox[{
       RowBox[{"ToString", "@", 
        RowBox[{"Unevaluated", "@", "x"}]}], ",", " ", "d"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"CreateSymbolString", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "d_", "]"}], "[", "x_", "]"}], ",", " ", 
       RowBox[{"e_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
     RowBox[{"CreateSymbolString", "[", 
      RowBox[{
       RowBox[{"Unevaluated", "@", "x"}], ",", " ", 
       RowBox[{"d", "+", "e"}]}], "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[341]:=",ExpressionUUID->"617be577-fd44-476e-9055-38b6624e59e3"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"CreateSymbol", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "default", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", "x_", "]"}], " ", ":=", " ", 
    RowBox[{"CreateSymbol", "[", 
     RowBox[{"x", ",", "0", ",", " ", "Hold"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "symbols", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{"x_Symbol", ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"If", "[", 
     RowBox[{
      RowBox[{"d", "  ", ">", " ", "0"}], ",", " ", 
      RowBox[{"Symbol", "[", 
       RowBox[{"CreateSymbolString", "[", 
        RowBox[{
         RowBox[{"Unevaluated", "@", "x"}], ",", " ", "d"}], "]"}], "]"}], 
      ",", " ", "x"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "functions", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"\[FormalP]", "[", "x_", "]"}], ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"CreateSymbol", "[", 
     RowBox[{"x", ",", " ", "d"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"HoldPattern", "@", 
       RowBox[{"Transpose", "[", 
        RowBox[{"x_", ",", " ", "y___"}], "]"}]}], ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Transpose", "[", 
     RowBox[{
      RowBox[{"CreateSymbol", "[", 
       RowBox[{"x", ",", " ", "d"}], "]"}], ",", " ", "y"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"HoldPattern", "@", 
       RowBox[{"Part", "[", 
        RowBox[{"x_", ",", " ", "y___"}], "]"}]}], ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{
     RowBox[{"Part", "[", 
      RowBox[{
       RowBox[{"CreateSymbol", "[", 
        RowBox[{"x", ",", " ", "d"}], "]"}], ",", " ", "y"}], "]"}], " ", "//.",
      " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", 
       RowBox[{"Part", "[", 
        RowBox[{
         RowBox[{"Part", "[", 
          RowBox[{"a_", ",", " ", "b__"}], "]"}], ",", " ", "c__"}], "]"}], 
       "]"}], " ", "\[RuleDelayed]", " ", 
      RowBox[{"Part", "[", 
       RowBox[{"a", ",", " ", "b", ",", " ", "c"}], "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"f_", "[", "x___", "]"}], ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
    RowBox[{
     RowBox[{"CreateSymbol", "[", 
      RowBox[{"f", ",", " ", "d"}], "]"}], "[", 
     RowBox[{"CreateArguments", "[", 
      RowBox[{
       RowBox[{"{", "x", "}"}], ",", " ", "d"}], "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"f_Symbol", "[", "x___", "]"}], ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
    RowBox[{
     RowBox[{"Symbol", "[", 
      RowBox[{"CreateSymbolString", "[", 
       RowBox[{
        RowBox[{"Unevaluated", "@", "f"}], ",", " ", "d"}], "]"}], "]"}], "[", 
     RowBox[{"CreateArguments", "[", 
      RowBox[{
       RowBox[{"{", "x", "}"}], ",", " ", "d"}], "]"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", "derivatives", " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", "d_", "]"}], "[", "x_", "]"}], ",", " ", 
      RowBox[{"e_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
    RowBox[{"CreateSymbol", "[", 
     RowBox[{"x", ",", " ", 
      RowBox[{"d", "+", "e"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"Derivative", "[", "d_", "]"}], "[", 
       RowBox[{"f_", "[", "x___", "]"}], "]"}], ",", " ", 
      RowBox[{"e_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"f", "[", "x", "]"}], ",", " ", 
      RowBox[{"d", "+", "e"}]}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "d_", "]"}], "[", "f_", "]"}], "[", "x___",
        "]"}], ",", " ", 
      RowBox[{"e_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
    RowBox[{"CreateSymbol", "[", 
     RowBox[{
      RowBox[{"f", "[", "x", "]"}], ",", " ", 
      RowBox[{"d", "+", "e"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"does", " ", "not", " ", "work", " ", "with", " ", "e"}], " ", 
    ">", " ", "0"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "solution", " ", "is", " ", "to", " ", "precall", " ", "or", " ", 
    "postcall", " ", "CreateSymbol", " ", "with", " ", "e"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "depending", " ", "on", " ", "what", " ", "it", " ", "means", " ", "to", 
    " ", "diff", " ", "by", " ", "e", " ", "only"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"CreateSymbol", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "d__", "]"}], "[", "x_", "]"}], ",", " ", 
       RowBox[{"e_Integer:", "0"}]}], "]"}], " ", ":=", "  ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n", ",", " ", "i"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"n", " ", "=", 
         RowBox[{"Plus", "[", "d", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"i", " ", "=", " ", 
         RowBox[{"List", "@", 
          RowBox[{"CreateIndices", "[", 
           RowBox[{"Length", "@", 
            RowBox[{"{", "d", "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
        
        RowBox[{
         RowBox[{"CreateSymbol", "[", 
          RowBox[{"x", ",", " ", "n"}], "]"}], " ", "/.", " ", 
         RowBox[{"Thread", "[", 
          RowBox[{
           RowBox[{"Take", "[", 
            RowBox[{"i", ",", " ", "n"}], "]"}], " ", "\[Rule]", " ", 
           RowBox[{"Pick", "[", 
            RowBox[{"i", ",", " ", 
             RowBox[{"{", "d", "}"}], ",", " ", "1"}], "]"}]}], "]"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}]}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[344]:=",ExpressionUUID->"8dbb65ed-a9ed-449d-9edf-9797baf27ea3"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "blocks", " ", "functions", " ", "and", " ", "variables", " ", "and", " ",
      "allows", " ", "for", " ", "post"}], "-", "processing"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"CreateSymbol", "[", 
     RowBox[{"x_", ",", " ", "d_Integer", ",", " ", "fcn_"}], "]"}], " ", ":=",
     " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "s", ",", " ", "f", ",", " ", "n", ",", " ", "v", ",", " ", "dv", ",", 
        " ", "b", ",", " ", "w"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"{", 
         RowBox[{"Part", ",", " ", "Transpose"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"\[FormalP]", " ", "/@", " ", "w"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"e", ",", " ", 
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "[", "e", "]"}]}], ",", " ", 
          RowBox[{"{", "HoldAll", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"ExtractVariables", "[", 
         RowBox[{"x", ",", " ", "w"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"e", ",", " ", 
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "[", "e", "]"}]}], ",", " ", 
          RowBox[{"{", "HoldAll", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"ExtractSubfunctions", "[", 
         RowBox[{"x", ",", " ", "w"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"find", " ", "max", " ", "derivative"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"e", ",", " ", 
          RowBox[{"\[FormalP]", "[", "e", "]"}], " ", ",", " ", 
          RowBox[{"{", "HoldAll", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"ExtractDerivatives", "[", 
         RowBox[{"x", ",", " ", "w"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"Max", "[", 
         RowBox[{
          RowBox[{"Cases", "[", 
           RowBox[{"n", ",", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"Derivative", "[", "n__", "]"}], "[", "___", "]"}], " ",
              "\[RuleDelayed]", " ", 
             RowBox[{"Plus", "[", "n", "]"}]}], ",", " ", "Infinity"}], "]"}],
           ",", " ", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"create", " ", "symbols"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"f", ",", " ", "True", ",", " ", 
          RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"Flatten", "@", 
         RowBox[{"Values", "@", "v"}]}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"e", ",", " ", 
          RowBox[{"CreateSymbolString", "[", 
           RowBox[{"e", ",", " ", "1"}], "]"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"DeleteDuplicates", "@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"NestList", "[", 
           RowBox[{"w", ",", " ", 
            RowBox[{"Join", "[", 
             RowBox[{"f", ",", " ", "v"}], "]"}], ",", " ", 
            RowBox[{"d", " ", "+", " ", "n"}]}], "]"}]}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"ToExpression", "[", 
         RowBox[{"v", ",", " ", "InputForm", ",", " ", "\[FormalP]"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"s", ",", " ", "v"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"apply", " ", "fcn"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"Hold", "[", 
         RowBox[{"Block", "[", 
          RowBox[{"b", ",", " ", 
           RowBox[{"fcn", "@", 
            RowBox[{"Evaluate", "@", 
             RowBox[{"CreateSymbol", "[", 
              RowBox[{"x", ",", " ", "d"}], "]"}]}]}]}], "]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ReleaseHold", "[", 
        RowBox[{
         RowBox[{"f", " ", "/.", " ", 
          RowBox[{"b", " ", "\[Rule]", " ", "v"}]}], " ", "/.", " ", 
         RowBox[{
          RowBox[{"\[FormalP]", "[", "e_", "]"}], " ", "\[RuleDelayed]", " ", 
          "e"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[355]:=",ExpressionUUID->"c77bcf6c-30c0-4f95-bf20-28ca0c182834"],

Cell["\<\
Be careful when calling RemoveSymbol;  it invalidates all functions that rely \
on that symbol\
\>", "Text",ExpressionUUID->"611f5969-6488-4995-a29c-842832a1ee0f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"RemoveSymbol", ",", " ", 
     RowBox[{"{", 
      RowBox[{"HoldFirst", ",", " ", "Listable"}], "}"}]}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RemoveSymbol", "[", "var_Symbol", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "v", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"ToString", "@", 
         RowBox[{"Unevaluated", "[", "var", "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"RemoveSymbol", "[", 
        RowBox[{"Evaluate", "@", "v"}], "]"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RemoveSymbol", "[", "var_String", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", ",", " ", "c", ",", " ", "v"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"separate", " ", "context", " ", "from", " ", "name"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"ctxt", ":", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{"___", " ", "~~", " ", "\"\<`\>\""}], ")"}], "..."}]}], 
         " ", "~~", " ", 
         RowBox[{"x", ":", 
          RowBox[{
           RowBox[{"(", "_", ")"}], ".."}]}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"{", 
         RowBox[{"ctxt", ",", " ", "x"}], "}"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"c", ",", " ", "n"}], "}"}], " ", "=", " ", 
       RowBox[{"First", "@", 
        RowBox[{"StringCases", "[", 
         RowBox[{"var", ",", " ", "v"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "all", " ", "variables", " ", "that", " ", "end", " ", 
        "in", " ", "var"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"c", " ", "<>", " ", "\"\<d*\>\"", " ", "<>", " ", "n"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Names", "@", "v"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "search", " ", "for", " ", "variables", " ", "with", " ", "derivative",
         " ", "naming", " ", "scheme"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"StringCases", "[", 
        RowBox[{"v", ",", " ", 
         RowBox[{"StartOfString", " ", "~~", " ", "c", " ", "~~", " ", 
          RowBox[{"\"\<d\>\"", ".."}], " ", "~~", " ", "n"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Flatten", "@", "v"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"remove", " ", "derivative", " ", "names"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Remove", " ", "/@", " ", "v"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "return", " ", "symbols", " ", "removed", " ", "as", " ", "list", " ", 
        "of", " ", "strings"}], " ", "*)"}], "\[IndentingNewLine]", "v"}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[356]:=",ExpressionUUID->"ddacbb74-b94a-47c8-a75e-54f0351aa4a3"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Helper Operation on Symbols", \
"Section",ExpressionUUID->"77f7d82a-a682-444d-bea1-c72489fedb32"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateIndices", "[", "d_Integer", "]"}], " ", ":=", " ", 
    RowBox[{"Sequence", "@@", 
     RowBox[{"Table", "[", 
      RowBox[{
       RowBox[{"Symbol", "[", 
        RowBox[{"\"\<\[FormalD]\>\"", " ", "<>", " ", 
         RowBox[{"ToString", "@", "i"}]}], "]"}], ",", " ", 
       RowBox[{"{", 
        RowBox[{"i", ",", " ", "d"}], "}"}]}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"CreateArguments", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateArguments", "[", 
     RowBox[{"x_List", ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Sequence", "@@", 
     RowBox[{"Flatten", "@", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"e", ",", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"CreateSymbol", "[", 
            RowBox[{"e", ",", " ", "j"}], "]"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", " ", "0", ",", " ", "d"}], "}"}]}], "]"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldFirst"}], "}"}]}], "]"}], "[", 
       "x", "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"CreateArgumentsString", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateArgumentsString", "[", 
     RowBox[{"x_List", ",", " ", 
      RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Sequence", "@@", 
     RowBox[{"Flatten", "@", 
      RowBox[{
       RowBox[{"Function", "[", 
        RowBox[{"e", ",", " ", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"CreateSymbolString", "[", 
            RowBox[{"e", ",", " ", "j"}], "]"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", " ", "0", ",", " ", "d"}], "}"}]}], "]"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldFirst"}], "}"}]}], "]"}], "[", 
       "x", "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"CreateFunctionArguments", ",", " ", "HoldFirst"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CreateFunctionArguments", "[", 
     RowBox[{
      RowBox[{"f_Symbol", "[", "x___", "]"}], ",", " ", 
      RowBox[{"d_Integer:", "0"}], ",", " ", 
      RowBox[{"fcn_:", "Identity"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"F", ",", " ", "a", ",", " ", "s"}], "}"}], ",", " ", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"s", " ", "=", " ", 
        RowBox[{
         RowBox[{"ToString", "@", 
          RowBox[{"Unevaluated", "@", "#"}]}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"F", " ", "=", " ", 
        RowBox[{"CreateSymbol", "[", 
         RowBox[{
          RowBox[{"f", "[", "]"}], ",", " ", "d", ",", " ", "s"}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Thread", "@", 
         RowBox[{"\[FormalP]", "[", 
          RowBox[{"{", "x", "}"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Flatten", "@", 
         RowBox[{"Table", "[", 
          RowBox[{
           RowBox[{"CreateSymbol", "[", 
            RowBox[{
             RowBox[{"Evaluate", "@", "i"}], ",", " ", "j", ",", " ", "s"}], 
            "]"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", " ", "a"}], "}"}], ",", " ", 
           RowBox[{"{", 
            RowBox[{"j", ",", " ", "0", ",", " ", "d"}], "}"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"StringRiffle", "[", 
         RowBox[{"a", ",", " ", "\"\<, \>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"F", " ", "=", " ", 
        RowBox[{"StringInsert", "[", 
         RowBox[{"F", ",", " ", "a", ",", " ", 
          RowBox[{"-", "2"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"ToExpression", "[", 
        RowBox[{"F", ",", " ", "InputForm", ",", " ", "fcn"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"SetAttributes", "[", 
  RowBox[{"CreateDerivative", ",", " ", "HoldFirst"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CreateDerivative", "[", 
    RowBox[{"x_", ",", " ", 
     RowBox[{"e_Integer:", " ", "0"}], ",", " ", 
     RowBox[{"d_Integer:", "0"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Which", "[", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"d", " ", "\[Equal]", " ", "0"}], ",", " ", "x", ",", 
     "\[IndentingNewLine]", 
     RowBox[{"e", " ", "<", " ", 
      RowBox[{"2", "^", "d"}]}], ",", "\[IndentingNewLine]", 
     RowBox[{"With", "[", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"Derivative", "[", 
          RowBox[{"Sequence", "@@", 
           RowBox[{"Reverse", "@", 
            RowBox[{"PadLeft", "[", 
             RowBox[{
              RowBox[{"IntegerDigits", "[", 
               RowBox[{"e", ",", " ", "2"}], "]"}], ",", " ", "d"}], 
             "]"}]}]}], "]"}]}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"CreateSymbol", "[", 
        RowBox[{
         RowBox[{"f", "[", "x", "]"}], ",", " ", "0"}], "]"}]}], 
      "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", "True", ",", 
     "\[IndentingNewLine]", 
     RowBox[{"Throw", "[", "$Failed", "]"}]}], "\[IndentingNewLine]", "]"}]}],
   ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[359]:=",ExpressionUUID->"eceb5adb-4596-401a-a23d-5cd3c1be4d9d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on a Function\[CloseCurlyQuote]s Argument List", \
"Section",ExpressionUUID->"5ac54457-d957-432d-8838-a2a044e372fd"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateFunctionArguments", "[", 
    RowBox[{"fcn_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "m", ",", " ", "a", ",", " ", "f", ",", " ", "g", ",", " ", "h"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"get", " ", "function", " ", "name"}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{
            RowBox[{"_", "[", 
             RowBox[{"f_", "[", "___", "]"}], "]"}], " ", "\[RuleDelayed]", 
            " ", "_"}], "]"}], " ", "\[RuleDelayed]", " ", 
          RowBox[{"HoldPattern", "[", 
           RowBox[{"f", "[", "___", "]"}], "]"}]}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "function", " ", "arguments"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Position", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{"First", "@", "f"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Extract", "[", 
        RowBox[{"fcn", ",", " ", "m", ",", " ", "Hold"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Level", "[", 
        RowBox[{"a", ",", " ", 
         RowBox[{"{", 
          RowBox[{"-", "1"}], "}"}], ",", " ", "Hold"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"List", "@", 
        RowBox[{"ReleaseHold", "[", 
         RowBox[{"ToString", " ", "/@", " ", 
          RowBox[{"Unevaluated", " ", "/@", " ", "a"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "derivatives", " ", "of", " ", "function", " ", 
        "arguments"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"g", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"e", ",", " ", 
         RowBox[{"CreateSymbolString", "[", 
          RowBox[{"e", ",", " ", "1"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Transpose", "@", 
         RowBox[{"NestList", "[", 
          RowBox[{"g", ",", " ", "a", ",", " ", "n"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"#", " ", "<>", " ", "\"\<_\>\""}], "&"}], " ", "/@", " ", 
        "a"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"ToExpression", "[", 
          RowBox[{"#", ",", " ", "InputForm", ",", " ", "\[FormalP]"}], "]"}],
          "&"}], " ", "/@", " ", "a"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "name", " ", "derivative", " ", "of", " ", "function"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", "\[LeftDoubleBracket]", 
        RowBox[{"1", ",", "1", ",", "0"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"ToExpression", "[", 
        RowBox[{
         RowBox[{"CreateSymbolString", "[", 
          RowBox[{"f", ",", " ", "n"}], "]"}], ",", " ", "InputForm", ",", 
         " ", "\[FormalP]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"apply", " ", "changes"}], " ", "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"ReplacePart", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{"m", " ", "\[Rule]", " ", 
          RowBox[{"h", "[", 
           RowBox[{"Sequence", "@@", "a"}], "]"}]}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "/.", " ", 
        RowBox[{"h", "  ", "\[Rule]", " ", "f"}]}], " ", "/.", " ", 
       RowBox[{
        RowBox[{"\[FormalP]", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
        "x"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->"In[368]:=",ExpressionUUID->"745e8d23-5e52-46b3-a28e-02053da667e3"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on a Function\[CloseCurlyQuote]s Local Argument List", \
"Section",ExpressionUUID->"9d2ec7fe-a6d4-4090-ad58-65224e83a383"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateLocalArguments", "[", 
    RowBox[{"fcn_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "a", ",", " ", "f"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "globally", " ", "inspect", " ", "function", " ", "and", " ", "extract",
        " ", "symbols"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"ToString", "@", 
          RowBox[{"Unevaluated", "@", "x"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldFirst"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{"Module", "[", 
            RowBox[{"x_", ",", " ", "y_"}], "]"}], "]"}], " ", 
          "\[RuleDelayed]", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"v", "[", "x", "]"}], ",", " ", 
            RowBox[{"ExtractVariables", "[", 
             RowBox[{"y", ",", " ", "v"}], "]"}]}], "}"}]}], ",", " ", 
         "Infinity"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"separate", " ", "variables", " ", "and", " ", "indices"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", "a"}], " ", ">", " ", "0"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"a", ",", " ", "v"}], "}"}], " ", "=", " ", 
          RowBox[{"First", "@", "a"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"a", " ", "=", " ", 
          RowBox[{"Thread", "@", "a"}]}], ";", " ", 
         RowBox[{"(*", " ", 
          RowBox[{"what", " ", "does", " ", "this", " ", 
           RowBox[{"do", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"GroupBy", "[", 
           RowBox[{"a", ",", " ", 
            RowBox[{
             RowBox[{"MemberQ", "[", 
              RowBox[{
               RowBox[{"v", "[", "True", "]"}], ",", " ", "#"}], "]"}], 
             "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"a", " ", "=", " ", 
          RowBox[{"Lookup", "[", 
           RowBox[{"v", ",", " ", "True", ",", " ", 
            RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"Lookup", "[", 
           RowBox[{"v", ",", " ", "False", ",", " ", 
            RowBox[{"{", "}"}]}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"differentiate", " ", "variables"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"e", ",", " ", 
         RowBox[{"CreateSymbolString", "[", 
          RowBox[{"e", ",", " ", "1"}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Transpose", "@", 
         RowBox[{"NestList", "[", 
          RowBox[{"f", ",", " ", "a", ",", " ", "n"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"ToExpression", "[", 
          RowBox[{"#", ",", " ", "InputForm", ",", " ", "\[FormalP]"}], "]"}],
          "&"}], " ", "/@", " ", 
        RowBox[{"Join", "[", 
         RowBox[{"a", ",", " ", "v"}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"modify", " ", "function"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"fcn", " ", "/.", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", 
          RowBox[{"Module", "[", 
           RowBox[{"_", ",", " ", "y_"}], "]"}], "]"}], " ", "\[RuleDelayed]",
          " ", 
         RowBox[{"Module", "[", 
          RowBox[{"a", ",", " ", "y"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", " ", "/.", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", "a", "]"}], " ", "\[Rule]", " ", "a"}]}],
        "  ", "/.", " ", 
       RowBox[{
        RowBox[{"\[FormalP]", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
        "x"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->"In[369]:=",ExpressionUUID->"f3805c01-9b62-4e37-b635-29b206040d55"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Subfunctions", \
"Section",ExpressionUUID->"48a5ef7a-a6c2-40a6-8601-37c9b1fafd6b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"ExtractSubfunctions", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExtractSubfunctions", "[", 
    RowBox[{"expr_", ",", " ", 
     RowBox[{"fcn_:", "Identity"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"h", ",", " ", "f"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "apply", " ", "fcn", " ", "and", " ", "convert", " ", "symbol", " ", 
       "to", " ", "string"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"fcn", "@", "x"}], ",", " ", 
           RowBox[{"ToString", "@", 
            RowBox[{"Unevaluated", "@", "x"}]}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"extract", " ", "all", " ", "functions"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"Hold", "@", "expr"}], ",", " ", 
         RowBox[{
          RowBox[{"f_Symbol", "[", "___", "]"}], " ", "\[RuleDelayed]", " ", 
          RowBox[{"h", "@", "f"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"1", ",", " ", 
           RowBox[{"-", "2"}]}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "[", "f", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "group", " ", "System", " ", "functions", " ", "under", " ", "False"}],
        " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"h", " ", "=", " ", 
       RowBox[{
        RowBox[{"StringFreeQ", "[", 
         RowBox[{
          RowBox[{"Context", "[", 
           RowBox[{"Evaluate", "@", 
            RowBox[{"Last", "@", "#"}]}], "]"}], ",", " ", 
          RowBox[{"StartOfString", "~~", "\"\<System`\>\""}]}], "]"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"GroupBy", "[", 
         RowBox[{"f", ",", " ", "h"}], "]"}], "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", "All", ",", " ", "1"}], 
        "\[RightDoubleBracket]"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"make", " ", "Part", " ", "safe"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Map", "[", 
       RowBox[{"First", ",", " ", 
        RowBox[{"GroupBy", "[", 
         RowBox[{"f", ",", " ", "h"}], "]"}], ",", " ", 
        RowBox[{"{", "2", "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[370]:=",ExpressionUUID->"31691d20-74ca-4af9-9018-9af0b2b1db87"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Derivatives", \
"Section",ExpressionUUID->"4a2eaecf-96d5-420e-8f03-e4ef5aa67060"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"ExtractDerivatives", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExtractDerivatives", "[", 
    RowBox[{"expr_", ",", " ", 
     RowBox[{"fcn_:", "Identity"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"h", ",", " ", "e", ",", " ", "f"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"fcn", "@", "x"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"Hold", "@", "expr"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Position", "[", 
        RowBox[{"e", ",", " ", 
         RowBox[{"HoldPattern", "[", 
          StyleBox[
           RowBox[{
            RowBox[{"Derivative", "[", "__", "]"}], "[", "_", "]"}],
           ShowSpecialCharacters->False,
           ShowStringCharacters->True,
           NumberMarks->True], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Extract", "[", 
        RowBox[{"e", ",", " ", "f", ",", " ", "h"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "[", "f", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"<|", " ", 
       RowBox[{"True", "\[Rule]", " ", "f"}], " ", "|>"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[372]:=",ExpressionUUID->"35f33b61-28e7-490c-b323-35582828e1d0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Variables", \
"Section",ExpressionUUID->"10569118-7b2d-4d09-83d1-12b5c7fabdf4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"ExtractVariables", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ExtractVariables", "[", 
    RowBox[{"expr_", ",", " ", 
     RowBox[{"fcn_:", "Identity"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"h", ",", " ", "v", ",", " ", "i"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "apply", " ", "fcn", " ", "and", " ", "convert", " ", "symbol", " ", 
       "to", " ", "string"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"fcn", "@", "x"}], ",", " ", 
           RowBox[{"ToString", "@", 
            RowBox[{"Unevaluated", "@", "x"}]}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "get", " ", "all", " ", "leaves", " ", "of", " ", "an", " ", 
        "expression"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"Hold", "@", "expr"}], ",", " ", 
         RowBox[{
          RowBox[{"Except", "[", 
           RowBox[{"Null", ",", " ", "x_Symbol"}], "]"}], " ", 
          "\[RuleDelayed]", " ", 
          RowBox[{"h", "@", "x"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"-", "1"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "[", "v", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"extract", " ", "all", " ", "indices"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{
         RowBox[{"Hold", "@", "expr"}], ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{
           "x_", "\[LeftDoubleBracket]", "y__", "\[RightDoubleBracket]"}], 
           "]"}], " ", "\[RuleDelayed]", " ", 
          RowBox[{"Hold", "[", 
           RowBox[{"{", "y", "}"}], "]"}]}], ",", " ", "Infinity"}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"i", ",", " ", 
         RowBox[{"x_Symbol", " ", "\[RuleDelayed]", " ", 
          RowBox[{"h", "@", "x"}]}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"-", "1"}], "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"i", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "@", 
        RowBox[{"Partition", "[", 
         RowBox[{
          RowBox[{"Flatten", "@", "i"}], ",", " ", "2"}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "group", " ", "indexing", " ", "variables", " ", "under", " ", 
        "False"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"h", " ", "=", " ", 
       RowBox[{
        RowBox[{"FreeQ", "[", 
         RowBox[{
          RowBox[{"i", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}], ",", 
          " ", 
          RowBox[{"Last", "@", "#"}]}], "]"}], "&"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"GroupBy", "[", 
         RowBox[{"v", ",", " ", "h"}], "]"}], "\[LeftDoubleBracket]", 
        RowBox[{"All", ",", " ", "All", ",", " ", "1"}], 
        "\[RightDoubleBracket]"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"make", " ", "Part", " ", "safe"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Map", "[", 
       RowBox[{"First", ",", " ", 
        RowBox[{"GroupBy", "[", 
         RowBox[{"v", ",", " ", "h"}], "]"}], ",", " ", 
        RowBox[{"{", "2", "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[374]:=",ExpressionUUID->"ce2a2e24-f88d-4fec-86dd-16658dfc7064"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Expressions (in Functions)", \
"Section",ExpressionUUID->"b82a2380-21b8-4b75-8ade-e02f475e0f4c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"TransformExpression", ",", " ", "HoldFirst"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TransformExpression", "[", "expr_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "s", ",", " ", "f", ",", " ", "v", ",", " ", "x", ",", " ", "w"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "wrap", " ", "hold", " ", "variable", " ", "\[FormalP]", " ", "around",
         " ", "variables", " ", "and", " ", "functions"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"{", 
         RowBox[{"Part", ",", " ", "Transpose"}], "}"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"s", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"HoldPattern", "[", 
            RowBox[{"Pattern", "[", 
             RowBox[{"x", ",", 
              RowBox[{"Blank", "[", "#", "]"}]}], "]"}], "]"}], " ", 
           "\[RuleDelayed]", "  ", 
           RowBox[{
            RowBox[{"\[FormalP]", "[", "x", "]"}], "[", "\[FormalR]", "]"}]}],
           "&"}], " ", "/@", " ", "w"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"x", ",", " ", 
          RowBox[{
           RowBox[{"HoldPattern", "[", "x", "]"}], " ", "\[RuleDelayed]", 
           "  ", 
           RowBox[{
            RowBox[{"\[FormalP]", "[", "x", "]"}], "[", "\[FormalR]", "]"}]}],
           ",", " ", 
          RowBox[{"{", "HoldAll", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"ExtractVariables", "[", 
         RowBox[{"expr", ",", " ", "w"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"w", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"h", ",", " ", 
          RowBox[{
           RowBox[{"HoldPattern", "[", "x_h", "]"}], " ", "\[RuleDelayed]", 
           "  ", 
           RowBox[{
            RowBox[{"\[FormalP]", "[", "x", "]"}], "[", "\[FormalR]", "]"}]}],
           ",", " ", 
          RowBox[{"{", "HoldAll", "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"ExtractSubfunctions", "[", 
         RowBox[{"expr", ",", " ", "w"}], "]"}]}], ";", "\[IndentingNewLine]",
        "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"f", ",", " ", "True", ",", " ", 
          RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"v", ",", " ", "True", ",", " ", 
          RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"ReleaseHold", "[", 
        RowBox[{
         RowBox[{"Hold", "[", "expr", "]"}], " ", "/.", " ", 
         RowBox[{"Join", "[", 
          RowBox[{"s", ",", " ", "f", ",", " ", "v"}], "]"}]}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RestoreExpression", "[", "expr_", "]"}], " ", ":=", " ", 
    RowBox[{"expr", " ", "/.", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", 
       RowBox[{"f_", "[", "\[FormalR]", "]"}], "]"}], " ", "\[RuleDelayed]", 
      " ", 
      RowBox[{"CreateSymbol", "[", "f", "]"}]}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateExpression", "[", 
    RowBox[{"expr_", ",", " ", "x_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "f", ",", " ", "e"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"x", " ", "===", " ", "\[FormalR]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "expression", " ", "has", " ", "prespecified", " ", "what", " ", 
          "to", " ", "differentiate"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"v", " ", "=", " ", "expr"}], ",", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"o", ".", "w", "."}], ",", " ", 
          RowBox[{
          "differentiate", " ", "with", " ", "respect", " ", "to", " ", 
           "variables", " ", "in", " ", "x"}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"f", " ", "=", " ", 
          RowBox[{"Function", "[", 
           RowBox[{"e", ",", " ", 
            RowBox[{"e", " ", "\[Rule]", " ", 
             RowBox[{"e", "[", "\[FormalR]", "]"}]}], ",", " ", 
            RowBox[{"{", "Listable", "}"}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"expr", " ", "/.", " ", 
           RowBox[{"Flatten", "[", 
            RowBox[{"f", "[", "x", "]"}], "]"}]}]}]}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"D", "[", 
          RowBox[{"v", ",", " ", 
           RowBox[{"{", 
            RowBox[{"\[FormalR]", ",", " ", "e"}], "}"}]}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"e", ",", " ", "0", ",", " ", "n"}], "}"}]}], "]"}], "*)"}],
       "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"VectorQ", "[", "n", "]"}], ",", "\[IndentingNewLine]", 
        RowBox[{"D", "[", 
         RowBox[{"v", ",", " ", 
          RowBox[{"{", 
           RowBox[{"\[FormalR]", ",", " ", 
            RowBox[{"First", "@", "n"}]}], "}"}]}], "]"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"NestList", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"D", "[", 
            RowBox[{"#", ",", " ", "\[FormalR]"}], "]"}], "&"}], ",", " ", 
          "v", ",", " ", "n"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[376]:=",ExpressionUUID->"f192004c-fde8-48eb-80a7-c0e956ff7ef4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"WrapExpression", ",", " ", "BlockExpression"}], "}"}], ",", 
     " ", "HoldAll"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"WrapExpression", "[", 
     RowBox[{"expr_", ",", " ", 
      RowBox[{"fcn_:", "Hold"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"v", ",", " ", "f", ",", " ", "h"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "returns", " ", "expr", " ", "with", " ", "all", " ", "symbols", " ", 
        "wrapped", " ", "in", " ", "fcn"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"h", " ", "=", " ", 
        RowBox[{"Function", "[", 
         RowBox[{"x", ",", " ", 
          RowBox[{
           RowBox[{"HoldPattern", "[", "x", "]"}], "\[RuleDelayed]", " ", 
           RowBox[{"fcn", "[", "x", "]"}]}], ",", " ", "HoldAll"}], "]"}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"v", " ", "=", " ", 
        RowBox[{"ExtractVariables", "[", 
         RowBox[{"expr", ",", " ", "h"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"f", " ", "=", " ", 
        RowBox[{"ExtractSubfunctions", "[", 
         RowBox[{"expr", ",", " ", "h"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"h", " ", "=", " ", 
        RowBox[{"Merge", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"v", ",", " ", "f"}], "}"}], ",", " ", "Flatten"}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"fcn", "[", "expr", "]"}], " ", "/.", " ", 
        RowBox[{"h", "[", "True", "]"}]}]}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"BlockExpression", "[", 
    RowBox[{"b_List", ",", " ", "expr_", ",", " ", 
     RowBox[{"e_List:", 
      RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "f", ",", " ", "h"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "get", " ", "all", " ", "variables", " ", "and", " ", "functions"}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"\[FormalP]", "[", "x", "]"}], ",", " ", "HoldAll"}], 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"ExtractVariables", "[", 
        RowBox[{"expr", ",", " ", "h"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"ExtractSubfunctions", "[", 
        RowBox[{"expr", ",", " ", "h"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Merge", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"v", ",", " ", "f"}], "}"}], ",", " ", "Flatten"}], "]"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"place", " ", "in", " ", "block", " ", "environment"}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Function", "[", 
        RowBox[{"x", ",", " ", 
         RowBox[{"\[FormalP]", "[", "x", "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"Listable", ",", " ", "HoldAll"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"h", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{
         RowBox[{"f", "@", "b"}], ",", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"h", ",", " ", "True", ",", " ", 
           RowBox[{"{", "}"}]}], "]"}], ",", " ", 
         RowBox[{"Lookup", "[", 
          RowBox[{"v", ",", " ", "False", ",", " ", 
           RowBox[{"{", "}"}]}], "]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"except", " ", "those", " ", "symbols", " ", "in", " ", "e"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Complement", "[", 
        RowBox[{"h", ",", 
         RowBox[{"f", "@", "e"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{"Hold", "[", 
         RowBox[{"Block", "[", 
          RowBox[{"v", ",", " ", "expr"}], "]"}], "]"}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", "v", "]"}], " ", "\[Rule]", " ", 
         "f"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"evaluate", " ", "expr"}], " ", "*)"}], "\[IndentingNewLine]", 
      
      RowBox[{"First", "[", 
       RowBox[{"v", " ", "/.", " ", 
        RowBox[{
         RowBox[{"\[FormalP]", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 
 InitializationCell->True,
 CellLabel->"In[380]:=",ExpressionUUID->"0fa1d158-6f0c-4b52-903e-e6082af646ca"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Set Expressions (in Functions)", \
"Section",ExpressionUUID->"a9f14c49-5306-4e56-95ae-8ef446213604"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"TransformExpression", "[", 
     RowBox[{"HoldPattern", "@", 
      RowBox[{"Set", "[", 
       RowBox[{"x_", ",", " ", "y_"}], "]"}]}], "]"}], " ", ":=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"TransformExpression", "[", "x", "]"}], ",", " ", 
      RowBox[{"TransformExpression", "[", "y", "]"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"FlattenCompoundExpressions", "[", "e_", "]"}], " ", ":=", " ", 
  RowBox[{
   RowBox[{"e", " ", "//.", " ", 
    RowBox[{
     RowBox[{"HoldPattern", "[", 
      RowBox[{"CompoundExpression", "[", 
       RowBox[{"x___", ",", " ", 
        RowBox[{"CompoundExpression", "[", "y__", "]"}], ",", " ", "z___"}], 
       "]"}], "]"}], " ", "\[RuleDelayed]", " ", 
     RowBox[{"CompoundExpression", "[", 
      RowBox[{"x", ",", " ", "y", ",", " ", "z"}], "]"}]}]}], " ", "//.", " ", 
   RowBox[{
    RowBox[{"HoldPattern", "[", 
     RowBox[{"CompoundExpression", "[", 
      RowBox[{"x__", ",", " ", "Null", ",", " ", "y__"}], "]"}], "]"}], " ", 
    "\[RuleDelayed]", " ", 
    RowBox[{"CompoundExpression", "[", 
     RowBox[{"x", ",", " ", "y"}], "]"}]}]}]}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[383]:=",ExpressionUUID->"e52a2af8-84ba-42b9-98a2-181e57398dae"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateSetStatements", "[", 
    RowBox[{"fcn_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "m", ",", " ", "d"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{
         RowBox[{"ExtractVariables", "[", 
          RowBox[{"fcn", ",", " ", "\[FormalP]"}], "]"}], ",", " ", "False", 
         ",", " ", 
         RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "extract", " ", "and", " ", "transform", " ", "all", " ", "set", " ", 
         "statements"}], ",", " ", 
        RowBox[{"adds", " ", "\[FormalR]", " ", "to", " ", "symbols"}]}], " ",
        "*)"}], "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Position", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{"HoldPattern", "[", 
          RowBox[{"Set", "[", 
           RowBox[{"_", ",", " ", "_"}], "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Extract", "[", 
        RowBox[{"fcn", ",", " ", "m", ",", " ", "TransformExpression"}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"remove", " ", "statements", " ", "x"}], " ", "=", " ", 
         "y"}], ",", " ", 
        RowBox[{
         RowBox[{
         "where", " ", "x", " ", "is", " ", "an", " ", "index", " ", "or", 
          " ", "x"}], " ", "=", " ", "IgnoreCase"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"d", " ", "=!=", " ", 
         RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"Append", "[", 
           RowBox[{
            RowBox[{"Through", "[", 
             RowBox[{"d", "[", "\[FormalR]", "]"}], "]"}], ",", " ", 
            "IgnoreCase"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"Select", "[", 
           RowBox[{
            RowBox[{"Range", "@", 
             RowBox[{"Length", "@", "m"}]}], ",", " ", 
            RowBox[{
             RowBox[{"FreeQ", "[", 
              RowBox[{"d", ",", " ", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"#", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
              "]"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{
          "m", "\[LeftDoubleBracket]", "d", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{
          "v", "\[LeftDoubleBracket]", "d", "\[RightDoubleBracket]"}]}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "drop", " ", "statements", " ", "with", " ", "zeros", " ", "as", " ", 
        "results"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"v", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{"#", ",", " ", 
             RowBox[{
              RowBox[{"!", 
               RowBox[{"PossibleZeroQ", "[", 
                RowBox[{"Last", "@", "#"}], "]"}]}], "&"}]}], "]"}], "&"}], 
          " ", "/@", " ", "v"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"differentiate", " ", "statements"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"DifferentiateExpression", "[", 
        RowBox[{"v", ",", " ", "\[FormalR]", ",", " ", "n"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"RestoreExpression", "[", 
        RowBox[{"v", "\[Transpose]"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"restore", " ", "set", " ", "statement"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{"Apply", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"\[FormalP]", "[", 
            RowBox[{"#1", " ", "=", " ", "#2"}], "]"}], "&"}], ",", " ", "v", 
          ",", " ", 
          RowBox[{"{", "2", "}"}]}], "]"}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "add", " ", "derivatives", " ", "to", " ", "extracted", " ", 
        "statements"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"#", " ", "/.", " ", 
          RowBox[{
           RowBox[{"{", "x__", "}"}], " ", "\[RuleDelayed]", " ", 
           RowBox[{"\[FormalP]", "[", 
            RowBox[{"CompoundExpression", "[", "x", "]"}], "]"}]}]}], "&"}], 
        " ", "/@", " ", "v"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{
        RowBox[{"ReplacePart", "[", 
         RowBox[{"fcn", ",", " ", 
          RowBox[{"Thread", "[", 
           RowBox[{"m", " ", "\[Rule]", " ", "v"}], "]"}]}], "]"}], "  ", "//.",
         " ", 
        RowBox[{
         RowBox[{"\[FormalP]", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
         "x"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "flatten", " ", "the", " ", "excessive", " ", "compound", " ", 
        "expressions"}], " ", "*)"}], " ", "\[IndentingNewLine]", 
      RowBox[{"FlattenCompoundExpressions", "[", "v", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[385]:=",ExpressionUUID->"258251b7-9b4c-4c39-a81d-70808e3f5d52"],

Cell["\<\
This is a quick test to see if there are potential issues.  To use call, for \
example,
\t
\tCheckSetStatements[DownValues@func]
\t
if called with a function.\
\>", "Text",ExpressionUUID->"36e7bc53-918c-426a-b2e9-96b18e3bfcc5"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"CheckSetStatements", "::", "ss"}], " ", "=", " ", 
    "\"\<Assignment with variable appearing in lhs and rhs.  Potential bug in \
computing derivative (e.g., if multiplication or dot products are involved).  \
See note in DifferentiateFunction.nb.  Check input function(s).\>\""}], ";"}],
   "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"CheckSetStatements", "[", "fcn_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"v", ",", " ", "m", ",", " ", "d"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{
         RowBox[{"ExtractVariables", "[", 
          RowBox[{"fcn", ",", " ", "\[FormalP]"}], "]"}], ",", " ", "False", 
         ",", " ", 
         RowBox[{"{", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "extract", " ", "and", " ", "transform", " ", "all", " ", "set", " ", 
         "statements"}], ",", " ", 
        RowBox[{"adds", " ", "\[FormalR]", " ", "to", " ", "symbols"}]}], " ",
        "*)"}], "\[IndentingNewLine]", 
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Position", "[", 
        RowBox[{"fcn", ",", " ", 
         RowBox[{"HoldPattern", "[", 
          RowBox[{"Set", "[", 
           RowBox[{"_", ",", " ", "_"}], "]"}], "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Extract", "[", 
        RowBox[{"fcn", ",", " ", "m", ",", " ", "TransformExpression"}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"remove", " ", "statements", " ", "x"}], " ", "=", " ", 
         "y"}], ",", " ", 
        RowBox[{
         RowBox[{
         "where", " ", "x", " ", "is", " ", "an", " ", "index", " ", "or", 
          " ", "x"}], " ", "=", " ", "IgnoreCase"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"d", " ", "=!=", " ", 
         RowBox[{"{", "}"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"Append", "[", 
           RowBox[{
            RowBox[{"Through", "[", 
             RowBox[{"d", "[", "\[FormalR]", "]"}], "]"}], ",", " ", 
            "IgnoreCase"}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"Select", "[", 
           RowBox[{
            RowBox[{"Range", "@", 
             RowBox[{"Length", "@", "m"}]}], ",", " ", 
            RowBox[{
             RowBox[{"FreeQ", "[", 
              RowBox[{"d", ",", " ", 
               RowBox[{"v", "\[LeftDoubleBracket]", 
                RowBox[{"#", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
              "]"}], "&"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{
          "m", "\[LeftDoubleBracket]", "d", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{
          "v", "\[LeftDoubleBracket]", "d", "\[RightDoubleBracket]"}]}], 
         ";"}]}], "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{"Outer", "|", "Times", "|", "Dot", "|", "Power"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"d", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"Count", "[", 
          RowBox[{
           RowBox[{
           "#", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",", 
           " ", 
           RowBox[{"d", "[", 
            RowBox[{"___", ",", " ", 
             RowBox[{
             "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",",
              " ", "___"}], "]"}], ",", " ", 
           RowBox[{"-", "2"}]}], "]"}], "&"}], " ", "/@", " ", "v"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Total", "[", "d", "]"}], " ", ">", " ", "0"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{"CheckSetStatements", "::", "ss"}], "]"}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"m", " ", "=", " ", 
          RowBox[{"Pick", "[", 
           RowBox[{"m", ",", " ", "d", ",", " ", 
            RowBox[{"i_", " ", "/;", " ", 
             RowBox[{"i", " ", ">", " ", "0"}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{"Pick", "[", 
           RowBox[{"v", ",", " ", "d", ",", " ", 
            RowBox[{"i_", " ", "/;", " ", 
             RowBox[{"i", " ", ">", " ", "0"}]}]}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"v", " ", "=", " ", 
          RowBox[{
           RowBox[{"MapThread", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Hold", "[", 
               RowBox[{"#1", " ", "=", " ", "#2"}], "]"}], "&"}], ",", " ", 
             RowBox[{"v", "\[Transpose]"}]}], "]"}], " ", "/.", " ", 
           RowBox[{
            RowBox[{
             RowBox[{"\[FormalP]", "[", "x_", "]"}], "[", "\[FormalR]", "]"}],
             " ", "\[RuleDelayed]", " ", "x"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"AssociationThread", "[", 
          RowBox[{"m", " ", "\[Rule]", " ", "v"}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"<|", "|>"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[386]:=",ExpressionUUID->"6e2e4f1f-a1e1-4410-ada1-1d2aac3a21f2"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Operations on Functions", \
"Section",ExpressionUUID->"c5917e7c-7ad6-425f-8be4-fbf24fb8b30c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"MergeFunctions", ",", " ", "HoldRest"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"MergeFunctions", "[", 
    RowBox[{"fcns_", ",", " ", "F_", ",", " ", 
     RowBox[{"lcls_:", 
      RowBox[{"{", "}"}]}], ",", " ", 
     RowBox[{"n_:", "0"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "p", ",", " ", "e", ",", " ", "g", ",", " ", "a", ",", 
       " ", "b"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DownValues", " ", "/@", " ", "fcns"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"Cases", "[", 
        RowBox[{"f", ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", 
           RowBox[{"Module", "[", 
            RowBox[{"x_", ",", " ", "y_"}], "]"}], "]"}], " ", 
          "\[RuleDelayed]", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"Hold", "[", "x", "]"}], ",", " ", 
            RowBox[{"Hold", "[", "y", "]"}]}], "}"}]}], ",", " ", 
         "Infinity"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"wrap", " ", "Hold", " ", "around", " ", "each", " ", "arg"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Prepend", "[", 
        RowBox[{
         RowBox[{"e", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"Hold", "[", "lcls", "]"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Join", "@@", 
        RowBox[{"(", 
         RowBox[{"Thread", " ", "/@", " ", "a"}], ")"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"DeleteDuplicates", "[", "a", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "combine", " ", "separate", " ", "expression", " ", "into", " ", 
        "one"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{
        RowBox[{"Join", "@@", 
         RowBox[{"e", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], " ", "/.",
         " ", 
        RowBox[{
         RowBox[{"Hold", "[", "x__", "]"}], " ", "\[RuleDelayed]", " ", 
         RowBox[{"Hold", "[", 
          RowBox[{"CompoundExpression", "[", "x", "]"}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"b", " ", "=", " ", 
       RowBox[{"FlattenCompoundExpressions", "[", "b", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"g", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{
          RowBox[{"HoldPattern", "[", "a", "]"}], " ", "\[Rule]", " ", "a"}], 
         ",", " ", 
         RowBox[{
          RowBox[{"HoldPattern", "[", "b", "]"}], " ", "\[Rule]", " ", 
          "b"}]}], "}"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"Head", "[", "F", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ReleaseHold", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Hold", "@", 
         RowBox[{"Block", "[", 
          RowBox[{
           RowBox[{"{", "\"\<F\>\"", "}"}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
             RowBox[{"DownValues", "[", "\"\<F\>\"", "]"}], " ", "=", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"{", 
                RowBox[{
                 RowBox[{"HoldPattern", "[", "F", "]"}], "\[RuleDelayed]", 
                 RowBox[{"Module", "[", 
                  RowBox[{"a", ",", " ", "b"}], "]"}]}], "}"}], " ", "/.", 
               " ", "g"}], " ", "/.", " ", 
              RowBox[{
               RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
               "x"}]}]}], ";", "\[IndentingNewLine]", 
            RowBox[{"DifferentiateFunction", "[", 
             RowBox[{"\"\<F\>\"", ",", " ", "n"}], "]"}]}]}], 
          "\[IndentingNewLine]", "]"}]}], " ", "/.", " ", 
        RowBox[{"\"\<F\>\"", " ", "\[Rule]", " ", "f"}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[388]:=",ExpressionUUID->"4ad40dc0-de4f-49c3-af92-d4c71df327d8"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"DifferentiateFunction", "[", 
    RowBox[{"fcn_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "f", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DownValues", "@", "fcn"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DifferentiateFunctionArguments", "[", 
        RowBox[{"f", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"DifferentiateLocalArguments", "[", 
        RowBox[{"f", ",", " ", "n"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"DifferentiateSetStatements", "[", 
       RowBox[{"f", ",", " ", "n"}], "]"}]}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->"In[390]:=",ExpressionUUID->"eb528a42-4da3-4674-a497-433f483745bb"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", "Section",
 InitializationCell->
  True,ExpressionUUID->"ebeb03c9-3e6c-4121-96fd-7d58fe43fec9"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\n", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[391]:=",ExpressionUUID->"a80dada4-e5be-492c-be27-5ebc88cfc74a"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1244, 1376},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

