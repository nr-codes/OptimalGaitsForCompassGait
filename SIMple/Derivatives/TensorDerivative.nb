Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"RigidBodyDerivatives", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{"High", "-", 
      RowBox[{
      "level", " ", "functions", " ", "used", " ", "to", " ", "define", " ", 
       "a", " ", "rigid", " ", 
       RowBox[{"body", ".", "\n", "Copyright"}], " ", 
       RowBox[{"(", "C", ")"}], " ", "2016", " ", "Nelson", " ", "Rosa", " ", 
       
       RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", 
       " ", "free", " ", "software"}]}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->True,
 CellLabel->
  "In[595]:=",ExpressionUUID->"36a9df72-93f1-4f0b-8886-624339e55a43"],

Cell[CellGroupData[{

Cell["TODO", "Section",ExpressionUUID->"1ca30525-235d-4b71-b266-347149e3d529"],

Cell["should expand linear solve to do least squares too.", \
"Text",ExpressionUUID->"19c9e19f-e54b-44a1-8a10-d336e88cf9ab"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"1f9a3370-6be5-493e-8b2a-43070650433e"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", "\"\<Derivatives`\>\"", "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"depth", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"FixDotProducts", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"FixLinearSolve", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[596]:=",ExpressionUUID->"3cf3e4b0-4a71-4941-9549-2d45368eddd0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor Rank", \
"Section",ExpressionUUID->"929b8b80-5e12-4e23-8a7b-c22106ff6344"],

Cell["\<\
depth =  {depth of original tensor, number of derivatives from original \
tensor};
tensor rank/depth = Total[depth]
With calls to depth, assumes all operations make sense, no error checking.\
\>", "Text",ExpressionUUID->"b0189633-d67b-450b-bf52-bd9f3ae0865a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"clear", " ", "previous", " ", "definitions"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"ClearAll", "@", "depth"}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"SetAttributes", "[", 
     RowBox[{"depth", ",", " ", 
      RowBox[{"{", 
       RowBox[{"HoldFirst", ",", " ", "Listable"}], "}"}]}], "]"}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "::", "undef"}], " ", "=", " ", 
     "\"\<`1` is not defined.\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", "x__", "]"}], " ", ":=", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"depth", "::", "undef"}], ",", " ", 
         RowBox[{"HoldForm", "@", "x"}]}], "]"}], ";", " ", 
       RowBox[{"{", 
        RowBox[{"\[Infinity]", ",", " ", "\[Infinity]"}], "}"}]}], ")"}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", "x_Real", "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", "x_Integer", "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", "x_Length", "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"Cos", "|", "Sin", "|", "Tan"}], ")"}], "[", "x_", "]"}], 
      "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"ArcTan", "[", 
       RowBox[{"x_", ",", " ", "y_"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Power", "[", 
       RowBox[{"x_", ",", " ", "y_"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"{", 
      RowBox[{"0", ",", " ", "0"}], "}"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Transpose", "[", 
       RowBox[{"x_", ",", " ", "___"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"HoldPattern", "@", 
       RowBox[{"Part", "[", 
        RowBox[{"x_", ",", " ", "i__"}], "]"}]}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"d", ",", " ", "c"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"d", " ", "=", " ", 
         RowBox[{"depth", "[", "x", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"_Span", " ", "\[Rule]", " ", "0"}], ",", " ", 
           RowBox[{"All", " ", "\[Rule]", " ", "0"}], ",", " ", 
           RowBox[{"a_", " ", "\[RuleDelayed]", " ", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"depth", "[", "a", "]"}], "]"}], " ", "===", " ", 
               "1"}], ",", " ", "0", ",", " ", "1"}], "]"}]}]}], "}"}]}], ";",
         "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Replace", "[", 
          RowBox[{
           RowBox[{"Hold", "[", "i", "]"}], ",", " ", "c", ",", " ", 
           RowBox[{"{", "1", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"List", "@", 
          RowBox[{"ReleaseHold", "@", "c"}]}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"Total", "[", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"1", ",", " ", "0"}], "}"}], " ", "d"}], "]"}], " ", 
          "stays", " ", "unevaluated", " ", "if", " ", "d", " ", "is", " ", 
          "not", " ", "a", " ", "list"}], " ", "*)"}], "\[IndentingNewLine]", 
        
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Total", "[", 
          RowBox[{
           RowBox[{"TakeDrop", "[", 
            RowBox[{"c", ",", " ", 
             RowBox[{"UpTo", "@", 
              RowBox[{"Total", "[", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"1", ",", " ", "0"}], "}"}], "d"}], "]"}]}]}], "]"}],
            ",", " ", 
           RowBox[{"{", "2", "}"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"d", " ", "-", " ", "c"}]}]}], "\[IndentingNewLine]", "]"}]}],
     ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"f_", "[", "___", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", "f", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{
       RowBox[{"Derivative", "[", "d__", "]"}], "[", "x_", "]"}], "]"}], " ", 
     ":=", " ", 
     RowBox[{
      RowBox[{"depth", "[", "x", "]"}], " ", "+", " ", 
      RowBox[{"{", 
       RowBox[{"0", ",", " ", "d"}], "}"}]}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"Derivative", "[", "d__", "]"}], "[", "f_", "]"}], "[", 
       "x___", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{
      RowBox[{"depth", "[", 
       RowBox[{"f", "[", "x", "]"}], "]"}], " ", "+", " ", 
      RowBox[{"{", 
       RowBox[{"0", ",", " ", "d"}], "}"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"HoldPattern", "@", 
       RowBox[{"Set", "[", 
        RowBox[{"y_", ",", " ", "x_"}], "]"}]}], "]"}], " ", ":=", " ", 
     RowBox[{
      RowBox[{"depth", "[", "y", "]"}], " ", "=", " ", 
      RowBox[{"depth", "[", "x", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"HoldPattern", "[", 
       RowBox[{"Set", "[", 
        RowBox[{"x_List", " ", ",", " ", "y_"}], "]"}], "]"}], "]"}], " ", ":=",
      " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"S", ",", " ", "d", ",", " ", "n"}], "}"}], ",", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"n", " ", "=", " ", 
         RowBox[{
          RowBox[{"depth", "[", "y", "]"}], " ", "-", " ", 
          RowBox[{"{", 
           RowBox[{"1", ",", " ", "0"}], "}"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"SetAttributes", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"S", ",", " ", "d"}], "}"}], ",", " ", "HoldAll"}], "]"}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"Fold", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"S", "[", 
              RowBox[{"#2", ",", " ", "#1"}], "]"}], "&"}], ",", " ", "n", 
            ",", " ", 
            RowBox[{"Thread", "@", 
             RowBox[{"d", "[", "x", "]"}]}]}], "]"}], " ", "/.", " ", 
          RowBox[{"d", " ", "\[Rule]", " ", "depth"}]}], " ", "/.", " ", 
         RowBox[{"S", " ", "\[Rule]", " ", "Set"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Dot", "[", "x__", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"d", ",", " ", "c"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"depth", "[", 
           RowBox[{"A", ".", "B"}], "]"}], " ", "=", " ", 
          RowBox[{
           RowBox[{"depth", "[", "A", "]"}], " ", "+", " ", 
           RowBox[{"depth", "[", "B", "]"}], " ", "-", " ", "2"}]}], ",", " ", 
         RowBox[{
          RowBox[{"for", " ", 
           RowBox[{"depth", "[", "*", "]"}]}], " ", ">", " ", "0"}]}], " ", 
        "*)"}], "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"update", " ", 
          RowBox[{"rule", ":", " ", 
           RowBox[{
            RowBox[{"d", "^", "n"}], 
            RowBox[{
             RowBox[{"(", "A", ")"}], ".", 
             RowBox[{"d", "^", "m"}]}], 
            RowBox[{"(", "B", ")"}]}]}]}], " ", "=", ">"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"depth", "[", 
           RowBox[{"A", ".", "B"}], "]"}], ",", " ", 
          RowBox[{
           RowBox[{"depth", "[", 
            RowBox[{
             RowBox[{"d", "^", "n"}], 
             RowBox[{
              RowBox[{"(", "A", ")"}], ".", 
              RowBox[{"d", "^", "m"}]}], 
             RowBox[{"(", "B", ")"}]}], "]"}], " ", "-", " ", 
           RowBox[{"depth", "[", 
            RowBox[{"A", ".", "B"}], "]"}]}]}], "}"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"d", " ", "=", " ", 
         RowBox[{"depth", "[", 
          RowBox[{"{", "x", "}"}], "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{
           RowBox[{
           "special", " ", "case", " ", "of", " ", "0", " ", "leads", " ", 
            "to"}], " ", "-", 
           RowBox[{"'", "ve", " ", "#s"}]}], ",", " ", 
          RowBox[{"map", " ", "-", 
           RowBox[{
           "'", "ve", " ", "#s", " ", "back", " ", "to", " ", "0"}]}]}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"c", " ", "=", " ", 
           RowBox[{"Count", "[", 
            RowBox[{
             RowBox[{"d", "\[LeftDoubleBracket]", 
              RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}], ",", 
             " ", 
             RowBox[{"_", "?", "Positive"}]}], "]"}]}], ";"}], "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"Count", "[", 
          RowBox[{
           RowBox[{"Flatten", "@", 
            RowBox[{"Take", "[", 
             RowBox[{"d", ",", " ", "All", ",", " ", "1"}], "]"}]}], ",", " ", 
           RowBox[{"_", "?", "Positive"}]}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"c", " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"c", " ", ">", " ", "0"}], ",", " ", 
           RowBox[{"c", " ", "-", " ", "1"}], ",", " ", "0"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Total", "[", "d", "]"}], " ", "-", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"2", " ", "c"}], ",", " ", "0"}], "}"}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Times", "[", "x__", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", 
      RowBox[{"Dot", "[", "x", "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Plus", "[", "x__", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"First", "@", 
      RowBox[{"Select", "[", 
       RowBox[{
        RowBox[{"depth", "[", 
         RowBox[{"{", "x", "}"}], "]"}], ",", " ", 
        RowBox[{
         RowBox[{"VectorQ", "[", 
          RowBox[{"#", ",", " ", "IntegerQ"}], "]"}], "&"}]}], "]"}]}]}], 
    ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Outer", "[", 
       RowBox[{"Times", ",", " ", "x_", ",", " ", "y_"}], "]"}], "]"}], " ", ":=",
      " ", 
     RowBox[{
      RowBox[{"depth", "[", "x", "]"}], " ", "+", " ", 
      RowBox[{"depth", "[", "y", "]"}]}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Join", "[", 
       RowBox[{"x_", ",", " ", "___"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{
    "arrived", " ", "by", " ", "setting", " ", "up", " ", "system", " ", "of",
      " ", "equations", " ", "from", " ", "Dot", " ", "rule"}], " ", "*)"}], 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"LinearSolve", "[", 
       RowBox[{"A_", ",", " ", "b_"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{
      RowBox[{"depth", "[", "b", "]"}], "-", 
      RowBox[{"depth", "[", "A", "]"}], " ", "+", " ", 
      RowBox[{"{", 
       RowBox[{"2", ",", " ", "0"}], "}"}]}]}], ";"}], "\[IndentingNewLine]", 
   
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"LeastSquares", "[", 
       RowBox[{"A_", ",", " ", "b_"}], "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", 
      RowBox[{"LinearSolve", "[", 
       RowBox[{"A", ",", " ", "b"}], "]"}], "]"}]}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"x_", ",", " ", "d_Integer", ",", " ", "n_Integer"}], "]"}], 
     " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"f", ",", " ", "X", ",", " ", "D", ",", " ", "T"}], "}"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"ToString", "@", 
          RowBox[{"Unevaluated", "@", "depth"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"X", " ", "=", " ", 
         RowBox[{"List", "@", 
          RowBox[{"ToString", "@", 
           RowBox[{"Unevaluated", "@", "x"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"X", " ", "=", " ", 
         RowBox[{"List", "@", 
          RowBox[{"CreateArgumentsString", "[", 
           RowBox[{
            RowBox[{"Evaluate", "@", "X"}], ",", " ", "n"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"D", " ", "=", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"{", 
            RowBox[{"d", ",", " ", "#"}], "}"}], "&"}], " ", "/@", " ", 
          RowBox[{"Range", "[", 
           RowBox[{"0", ",", " ", "n"}], "]"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"T", " ", "=", " ", 
         RowBox[{
          RowBox[{
          "f", " ", "<>", " ", "\"\<[\>\"", " ", "<>", " ", "#1", " ", "<>", 
           " ", "\"\<] = \>\"", " ", "<>", " ", 
           RowBox[{"ToString", "@", "#2"}], " ", "<>", " ", "\"\<;\>\""}], 
          "&"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"ToExpression", "@", 
         RowBox[{"StringJoin", "@", 
          RowBox[{"MapThread", "[", 
           RowBox[{"T", ",", " ", 
            RowBox[{"{", 
             RowBox[{"X", ",", " ", "D"}], "}"}]}], "]"}]}]}]}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"\[FormalP]", "[", "x__", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", 
      RowBox[{"Hold", "[", "x__", "]"}], "]"}], " ", ":=", " ", 
     RowBox[{"depth", "[", "x", "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"depth", "[", "Clear", "]"}], " ", ":=", " ", 
     RowBox[{"(", 
      RowBox[{
       RowBox[{
        RowBox[{"DownValues", "[", "depth", "]"}], " ", "=", " ", 
        "depthfuns"}], ";"}], ")"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{"(*", " ", 
    RowBox[{"store", " ", "all", " ", "default", " ", "definitions"}], " ", 
    "*)"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"depthfuns", " ", "=", " ", 
     RowBox[{"DownValues", "[", "depth", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"f298f11f-8fa9-4ca1-bc12-488fba247faa"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Tensor Product", \
"Section",ExpressionUUID->"3f140dd7-86bf-468e-a96f-55df75468544"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{"might", " ", "have", " ", "to", " ", "multiply", " ", "by", " ", 
    RowBox[{"1", "/", "2"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{"tensym", ",", " ", "HoldAll"}], "]"}], "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"tensym", "::", "hess"}], " ", "=", " ", 
     "\"\<Last@depth[`1`] = `2` != 2\>\""}], ";"}], "\[IndentingNewLine]", 
   RowBox[{"(*", 
    RowBox[{
     RowBox[{"tensym", "[", "X_", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m", ",", " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"m", ",", " ", "n"}], "}"}], " ", "=", " ", 
         RowBox[{"depth", "[", "X", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"m", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
           RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
          RowBox[{"X", " ", "+", " ", 
           RowBox[{"X", "\[Transpose]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
          RowBox[{"X", " ", "+", " ", 
           RowBox[{"Transpose", "[", 
            RowBox[{"X", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "3", ",", " ", "2"}], "}"}]}], "]"}]}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
          RowBox[{"X", " ", "+", " ", 
           RowBox[{"Transpose", "[", 
            RowBox[{"X", ",", " ", 
             RowBox[{"{", 
              RowBox[{"1", ",", " ", "2", ",", " ", "4", ",", " ", "3"}], 
              "}"}]}], "]"}]}], ",", "\[IndentingNewLine]", "True", ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"tensym", "::", "hess"}], ",", " ", "X", ",", " ", "n"}],
             "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"Throw", "[", "$Failed", "]"}]}]}], "\[IndentingNewLine]", 
         "]"}]}]}], "\[IndentingNewLine]", "]"}]}], "*)"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{"tensym", "[", "X_", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"m", ",", " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"{", 
         RowBox[{"m", ",", " ", "n"}], "}"}], " ", "=", " ", 
        RowBox[{"depth", "[", "X", "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"m", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
          RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
         RowBox[{"0.5", 
          RowBox[{"(", 
           RowBox[{"X", " ", "+", " ", 
            RowBox[{"X", "\[Transpose]"}]}], ")"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"m", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
          RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
         RowBox[{"0.5", 
          RowBox[{"(", 
           RowBox[{"X", " ", "+", " ", 
            RowBox[{"Transpose", "[", 
             RowBox[{"X", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "3", ",", " ", "2"}], "}"}]}], "]"}]}], 
           ")"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"m", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
          RowBox[{"n", " ", "\[Equal]", " ", "2"}]}], ",", " ", 
         RowBox[{"0.5", 
          RowBox[{"(", 
           RowBox[{"X", " ", "+", " ", 
            RowBox[{"Transpose", "[", 
             RowBox[{"X", ",", " ", 
              RowBox[{"{", 
               RowBox[{"1", ",", " ", "2", ",", " ", "4", ",", " ", "3"}], 
               "}"}]}], "]"}]}], ")"}]}], ",", "\[IndentingNewLine]", "True", 
         ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Message", "[", 
           RowBox[{
            RowBox[{"tensym", "::", "hess"}], ",", " ", "X", ",", " ", "n"}], 
           "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"Throw", "[", "$Failed", "]"}]}]}], "\[IndentingNewLine]", 
        "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[630]:=",ExpressionUUID->"513302b6-0cc6-4e8a-9c03-d8aa7ecf0637"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"assume", " ", "derivatives", " ", "are", " ", "vectors", " ", 
     RowBox[{"df", "/", "dvec"}], 
     RowBox[{"(", "x", ")"}]}], ",", " ", 
    RowBox[{"f", " ", "\[Element]", " ", 
     RowBox[{"{", 
      RowBox[{"scalar", ",", " ", "vector", ",", " ", "matrix"}], "}"}]}]}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{
     RowBox[{"tencon", "::", "args"}], " ", "=", " ", 
     "\"\<Unknown Tensor(s): `1` (`2`) and/or `3` (`4`)\>\""}], ";"}], 
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"tencon", "[", "C__", "]"}], " ", ":=", " ", 
     RowBox[{"Fold", "[", 
      RowBox[{"tencon", ",", " ", 
       RowBox[{"{", "C", "}"}]}], "]"}]}], ";"}], "\[IndentingNewLine]", 
   "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"tencon", "[", 
      RowBox[{"A_", ",", " ", "B_"}], "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"m0", ",", " ", "md", ",", " ", "n0", ",", " ", "nd"}], "}"}],
        ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"{", 
          RowBox[{"m0", ",", " ", "md"}], "}"}], " ", "=", " ", 
         RowBox[{"depth", "[", "A", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"n0", ",", " ", "nd"}], "}"}], " ", "=", " ", 
         RowBox[{"depth", "[", "B", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Which", "[", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", "scalar", " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{"A", " ", "B"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"n0", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{"B", " ", "A"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          RowBox[{"tensym", "[", 
           RowBox[{"Outer", "[", 
            RowBox[{"Times", ",", " ", "B", ",", " ", "A"}], "]"}], "]"}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"n0", " ", "\[Equal]", " ", "0"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          RowBox[{"tensym", "[", 
           RowBox[{"Outer", "[", 
            RowBox[{"Times", ",", " ", "A", ",", " ", "B"}], "]"}], "]"}], 
          ",", "\[IndentingNewLine]", 
          RowBox[{"m0", " ", "\[Equal]", " ", "0"}], ",", " ", 
          RowBox[{"Outer", "[", 
           RowBox[{"Times", ",", " ", "B", ",", " ", "A"}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"n0", " ", "\[Equal]", " ", "0"}], ",", " ", 
          RowBox[{"Outer", "[", 
           RowBox[{"Times", ",", " ", "A", ",", " ", "B"}], "]"}], ",", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{"vector", "/", "matrix"}], ",", " ", 
            RowBox[{
             RowBox[{"m0", " ", ">", " ", "0"}], " ", "&&", " ", 
             RowBox[{"n0", " ", ">", " ", "0"}]}], ",", " ", 
            RowBox[{
            "but", " ", "no", " ", "derivative", " ", "in", " ", "A"}]}], " ",
            "*)"}], "\[IndentingNewLine]", 
          RowBox[{"md", " ", "\[Equal]", " ", "0"}], ",", " ", 
          RowBox[{"A", ".", "B"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", "vector", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{"B", ".", "A"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{
           RowBox[{"B", "\[Transpose]"}], ".", "A"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          RowBox[{"tensym", "[", 
           RowBox[{
            RowBox[{"B", "\[Transpose]"}], ".", "A"}], "]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          RowBox[{"tensym", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"A", "\[Transpose]"}], ".", "B"}], ")"}], 
            "\[Transpose]"}], "]"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", "matrix", " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{"B", ".", 
           RowBox[{"A", "\[Transpose]"}]}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "0"}]}], ",", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"B", "\[Transpose]"}], ".", 
             RowBox[{"A", "\[Transpose]"}]}], ")"}], "\[Transpose]"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          RowBox[{"tensym", "[", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{"B", "\[Transpose]"}], ".", 
              RowBox[{"A", "\[Transpose]"}]}], ")"}], "\[Transpose]"}], "]"}],
           ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"m0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"md", " ", "\[Equal]", " ", "1"}], " ", "&&", " ", 
           RowBox[{"n0", " ", "\[Equal]", " ", "2"}], " ", "&&", " ", 
           RowBox[{"nd", " ", "\[Equal]", " ", "1"}]}], ",", " ", 
          "\[IndentingNewLine]", 
          RowBox[{"tensym", "[", 
           RowBox[{"Transpose", "[", 
            RowBox[{
             RowBox[{
              RowBox[{"Transpose", "[", 
               RowBox[{"A", ",", " ", 
                RowBox[{"{", 
                 RowBox[{"2", ",", " ", "3", ",", " ", "1"}], "}"}]}], "]"}], 
              ".", "B"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"3", ",", " ", "1", ",", " ", "2", ",", " ", "4"}], 
              "}"}]}], "]"}], "]"}], ",", "\[IndentingNewLine]", 
          "\[IndentingNewLine]", "True", ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"tencon", "::", "args"}], ",", " ", "A", ",", " ", 
             RowBox[{"{", 
              RowBox[{"m0", ",", " ", "md"}], "}"}], ",", " ", "B", ",", " ", 
             
             RowBox[{"{", 
              RowBox[{"n0", ",", " ", "nd"}], "}"}]}], "]"}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"Throw", "[", "$Failed", "]"}]}]}], "\[IndentingNewLine]", 
         "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}]}]], "Input",
 InitializationCell->True,
 CellLabel->"In[633]:=",ExpressionUUID->"e77d0fd8-b5cd-47ae-977c-25fccc85b566"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Common Post Processing Routines", \
"Section",ExpressionUUID->"0ce17bc5-d4a4-4d53-9686-996877cfb998"],

Cell["\<\
Notes: for FixDotProducts there is an issue with making sure we detect cases \
of potential tensor multiplication whether due to dot products, \
multiplication, or exponentiation in order to get the tensor multiplication \
correct.  When calling FixDotProducts, the issue it resolves with dot \
products and the tensor multiplication assumed in our work is relatively \
straightforward to understand.  We need to do (scalar) multiplication because \
the derivatives of a scalar become vectors and matrices, which puts us back \
into the case of dot products and tensor multiplication rules.

Ex. 1) Let depth[x] = {1, 0} and depth[a] = {0, 0}, then 
a*x
1st derivative: a dx + da x
2nd derivative: da dx + a ddx + dda x + da dx.

Ex. 2) Let depth[x] = {0, 0}, then 
x^2
1st derivative: 2x dx
2nd derivative: 2 dx^2 + 2 dx.

For both scalar multiplication and exponentiation the issue appears in the \
derivatives, where we have vector-vector multiplications that MMA \
symbolically still represents as scalar multiplications (see 1st derivative \
of Ex. 1 and 2nd derivative of Ex. 2).  The fix for scalar multiplication is \
straightforward, replace the head Times with Dot and proceed as normal.  The \
issue with exponentiation is similar in nature, but may potentially have edge \
cases that have not been considered.

For example, if we replace x^2 with x^(-2), is there anything different that \
needs to be done?  The prevailing thought is no because derivative terms \
cannot be in the denominator.  This implies that we can treat symbolics of \
the form x^(-i), i > 0 as scalars without worrying about vectors and matrices \
showing up in the denominator (which wouldn\[CloseCurlyQuote]t make sense \
mathematically).  Keep in mind that in general x can be any complicated \
scalar expression, including expressions with more exponents or vectors \
(e.g., 1/(1/(x*a.a))).  Regardless of the expression, the result has to be a \
scalar.  

For this, we assume that derivative terms can only appear with the head \
Power[d^i x, m] if m > 0.  The code uses m > 1, because MMA simplifies \
Power[d^i x, m] for m = 0 and m = 1.  If m < 0, then the expression cannot \
have any terms (derivatives or otherwise) that are not scalars and the result \
is a scalar, so we don\[CloseCurlyQuote]t have situations like Ex. 1 and 2.\
\>", "Text",ExpressionUUID->"1dee7448-1329-4181-84c7-f2875eaa8077"],

Cell[BoxData[{
 RowBox[{"SetAttributes", "[", 
  RowBox[{"FixDot", ",", " ", "HoldAll"}], "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FixDot", "[", "expr__", "]"}], " ", ":=", " ", 
   RowBox[{"BlockExpression", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"Outer", ",", " ", "Part"}], "}"}], ",", " ", 
     RowBox[{"Hold", "@", 
      RowBox[{"Evaluate", "@", 
       RowBox[{"tencon", "[", "expr", "]"}]}]}], ",", " ", 
     RowBox[{"{", 
      RowBox[{"FixDot", ",", " ", "tencon"}], "}"}]}], "]"}]}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"FixDotProducts", "[", "expr_", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "pos", ",", " ", "ex", ",", " ", "posd", ",", " ", "exd", ",", " ", 
         "p", ",", " ", "f"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"f", " ", "=", " ", "expr"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"first", " ", "pass"}], ",", " ", 
          RowBox[{"assign", " ", "depth", " ", "to", " ", "symbols"}]}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"pos", " ", "=", " ", 
         RowBox[{"Position", "[", 
          RowBox[{"f", ",", " ", "_Set"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"ex", " ", "=", " ", 
         RowBox[{"Extract", "[", 
          RowBox[{"f", ",", " ", "pos", ",", " ", "Hold"}], "]"}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"depth", "@@@", "ex"}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"second", " ", "pass"}], ",", " ", 
          RowBox[{
          "update", " ", "dot", " ", "products", " ", "and", " ", 
           "multiplications"}]}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"f", " ", "/.", " ", 
          RowBox[{"Times", " ", "\[Rule]", " ", "Dot"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"f", " ", "/.", " ", 
          RowBox[{"Dot", " ", "\[Rule]", " ", "FixDot"}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"f", " ", "=", " ", 
         RowBox[{"f", " ", "//.", " ", 
          RowBox[{"x_FixDot", " ", "\[RuleDelayed]", " ", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"a", " ", "=", " ", "x"}], "}"}], ",", " ", 
             RowBox[{"a", " ", "/;", " ", "True"}]}], "]"}]}]}]}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"f", " ", "//.", " ", 
         RowBox[{
          RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
          "x"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"FixDotProducts", "[", "expr_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "pos", ",", " ", "ex", ",", " ", "x", ",", " ", "i", ",", " ", "p", ",",
        " ", "f"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f", " ", "=", " ", "expr"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"first", " ", "pass"}], ",", " ", 
        RowBox[{"assign", " ", "depth", " ", "to", " ", "symbols"}]}], " ", 
       "*)"}], "\[IndentingNewLine]", 
      RowBox[{"pos", " ", "=", " ", 
       RowBox[{"Position", "[", 
        RowBox[{"f", ",", " ", "_Set"}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"ex", " ", "=", " ", 
       RowBox[{"Extract", "[", 
        RowBox[{"f", ",", " ", "pos", ",", " ", "Hold"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"depth", "@@@", "ex"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"second", " ", "pass"}], ",", " ", 
        RowBox[{"update", " ", "dot", " ", "products"}], ",", " ", "powers", 
        ",", " ", 
        RowBox[{"and", " ", "multiplications"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"for", " ", "Power"}], ",", " ", 
        RowBox[{
        "wrap", " ", "in", " ", "\[FormalP]", " ", "and", " ", "let", " ", 
         "FixDot", " ", "remove", " ", "it", " ", "later"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{
        RowBox[{"Power", "[", 
         RowBox[{"x_", ",", " ", 
          RowBox[{"i_Integer", " ", "/;", " ", 
           RowBox[{"i", " ", ">", " ", "1"}]}]}], "]"}], " ", 
        "\[RuleDelayed]", " ", 
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"a", " ", "=", " ", 
            RowBox[{"Dot", "@@", 
             RowBox[{"Table", "[", 
              RowBox[{
               RowBox[{"\[FormalP]", "[", "x", "]"}], ",", " ", "i"}], 
              "]"}]}]}], "}"}], ",", " ", 
          RowBox[{"a", " ", "/;", " ", "True"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "/.", " ", "p"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "/.", " ", 
        RowBox[{"Times", " ", "\[Rule]", " ", "Dot"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "/.", " ", 
        RowBox[{"Dot", " ", "\[Rule]", " ", "FixDot"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"f", " ", "//.", " ", 
        RowBox[{"x_FixDot", " ", "\[RuleDelayed]", " ", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"a", " ", "=", " ", "x"}], "}"}], ",", " ", 
           RowBox[{"a", " ", "/;", " ", "True"}]}], "]"}]}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "//.", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
        "x"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"88485869-8511-4b57-a463-a63347a6f277"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"FixLinearSolve", "[", "expr_", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "f", ",", " ", "h", ",", " ", "j", ",", " ", "pos", ",", " ", "ex", ",",
        " ", "r", ",", " ", "n"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "assumes", " ", "FixDotProducts", " ", "has", " ", "already", " ", 
       "been", " ", "called"}], " ", "*)"}], "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"get", " ", "max", " ", "derivative", " ", "order"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"r", " ", "=", " ", 
       RowBox[{
        RowBox[{"HoldPattern", "[", 
         RowBox[{"Set", "[", 
          RowBox[{"x_", ",", " ", "_"}], "]"}], "]"}], " ", "\[RuleDelayed]", 
        " ", 
        RowBox[{"DerivativeOrder", "[", "x", "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Max", "@", 
        RowBox[{"Cases", "[", 
         RowBox[{"expr", ",", " ", "r", ",", " ", "Infinity"}], "]"}]}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
        "assume", " ", "A", " ", "in", " ", "LinearSolve", " ", "has", " ", 
         RowBox[{"depth", "[", "A", "]"}]}], " ", "\[Equal]", " ", 
        RowBox[{"(", 
         RowBox[{"2", ",", " ", "0"}], ")"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"=", 
        RowBox[{
         RowBox[{">", " ", 
          RowBox[{"depth", "[", 
           RowBox[{"LinearSolve", "[", 
            RowBox[{"A", ",", " ", "b"}], "]"}], "]"}]}], " ", "=", " ", 
         RowBox[{"depth", "[", "b", "]"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "extract", " ", "LinearSolve", " ", "with", " ", "RHS", " ", "arg", 
          " ", "of", " ", "increasing", " ", "derivative", " ", "order"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"pos", " ", "=", " ", 
           RowBox[{"Position", "[", 
            RowBox[{"expr", ",", " ", 
             RowBox[{"x_LinearSolve", " ", "/;", " ", 
              RowBox[{
               RowBox[{"Total", "[", 
                RowBox[{"depth", "[", "x", "]"}], "]"}], " ", "\[Equal]", " ", 
               RowBox[{"i", "+", "2"}]}]}]}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"ex", " ", "=", " ", 
           RowBox[{"Extract", "[", 
            RowBox[{"expr", ",", " ", "pos", ",", " ", "Hold"}], "]"}]}], ";",
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{"d", " ", "=", " ", 
             RowBox[{"initial", " ", "transpose"}]}], ",", " ", 
            RowBox[{"b", " ", "=", " ", 
             RowBox[{"final", " ", "transpose"}]}], ",", " ", 
            RowBox[{"k", " ", "=", " ", 
             RowBox[{"Map", " ", "depth"}]}]}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{
            "k", " ", "has", " ", "Map", " ", "solve", " ", "matrix", " ", 
             "problems"}], ",", " ", 
            RowBox[{"since", " ", "LinearSolve", " ", 
             RowBox[{"can", "'"}], "t", " ", "do"}]}], " ", "*)"}], " ", 
          RowBox[{"(*", " ", 
           RowBox[{"higher", "-", 
            RowBox[{"order", " ", "tensors"}]}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"j", " ", "=", " ", 
           RowBox[{"Flatten", " ", "/@", " ", 
            RowBox[{"{", 
             RowBox[{
              RowBox[{"{", 
               RowBox[{
                RowBox[{"i", "+", "1"}], ",", " ", 
                RowBox[{"Range", "[", "i", "]"}], ",", " ", 
                RowBox[{"i", "+", "2"}]}], "}"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{
                RowBox[{"Range", "[", 
                 RowBox[{"2", ",", " ", 
                  RowBox[{"i", "+", "1"}]}], "]"}], ",", " ", "1", ",", " ", 
                RowBox[{"i", "+", "2"}]}], "}"}]}], "}"}]}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"h", " ", "=", " ", 
           RowBox[{"With", "[", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{
               RowBox[{"d", " ", "=", " ", 
                RowBox[{
                "j", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
                ",", " ", 
               RowBox[{"b", " ", "=", " ", 
                RowBox[{
                "j", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
                ",", " ", 
               RowBox[{"k", " ", "=", " ", "i"}]}], "}"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"HoldPattern", "[", 
               RowBox[{"LinearSolve", "[", 
                RowBox[{"A_", ",", " ", "B_"}], "]"}], "]"}], " ", 
              "\[RuleDelayed]", " ", 
              RowBox[{"Transpose", "[", 
               RowBox[{
                RowBox[{"Map", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"LinearSolve", "[", 
                    RowBox[{"A", ",", " ", "#"}], "]"}], "&"}], ",", " ", 
                  RowBox[{"Transpose", "[", 
                   RowBox[{"B", ",", " ", "d"}], "]"}], ",", " ", 
                  RowBox[{"{", "k", "}"}]}], "]"}], ",", " ", "b"}], 
               "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"accumulate", " ", "transformations"}], " ", "*)"}], 
          "\[IndentingNewLine]", 
          RowBox[{"ex", " ", "=", " ", 
           RowBox[{"ex", " ", "/.", " ", "h"}]}], ";", "\[IndentingNewLine]", 
          
          RowBox[{"Thread", "[", 
           RowBox[{"pos", " ", "\[Rule]", " ", "ex"}], "]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "n"}], "}"}]}], "\[IndentingNewLine]", 
        "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"apply", " ", "transformations"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{"ReplacePart", "[", 
        RowBox[{"expr", ",", " ", 
         RowBox[{"Join", "@@", "r"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "/.", " ", 
       RowBox[{
        RowBox[{"Hold", "[", "x_", "]"}], " ", "\[RuleDelayed]", " ", 
        "x"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->"In[639]:=",ExpressionUUID->"85801bc0-6a49-4704-89cc-69675840d288"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"1866561b-02c6-4da5-b1c8-799bbc39c0fe"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[640]:=",ExpressionUUID->"2143a952-ac86-44ce-80d6-af271244e104"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1244, 1376},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

