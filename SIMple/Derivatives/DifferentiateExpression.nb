Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"RigidBodyDerivatives", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{"High", "-", 
      RowBox[{
      "level", " ", "functions", " ", "used", " ", "to", " ", "define", " ", 
       "a", " ", "rigid", " ", 
       RowBox[{"body", ".", "\n", "Copyright"}], " ", 
       RowBox[{"(", "C", ")"}], " ", "2016", " ", "Nelson", " ", "Rosa", " ", 
       
       RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", 
       " ", "free", " ", "software"}]}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"36a9df72-93f1-4f0b-8886-624339e55a43"],

Cell["Notes", \
"Section",ExpressionUUID->"54dbf9c8-8ef1-4b5f-b90a-b2e70c033c9e"],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"aef2af04-1d60-4d36-b57f-64455d13a21c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"BeginPackage", "[", "\"\<Derivatives`\>\"", "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Df", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DfToFunction", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DfToCompiledFunction", "::", "usage"}], " ", "=", " ", 
    "\"\<\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"3cf3e4b0-4a71-4941-9549-2d45368eddd0"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Convert Expression into Function", \
"Section",ExpressionUUID->"3b0634af-914f-4e4a-a440-9581e0be479f"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DfToFunction", "[", 
     RowBox[{"f_", ",", " ", "v_"}], "]"}], " ", ":=", " ", 
    RowBox[{"MapIndexed", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"DfToFunction", "[", 
        RowBox[{"#1", ",", " ", "v", ",", " ", 
         RowBox[{
          RowBox[{
          "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], "-", 
          "1"}]}], "]"}], "&"}], ",", " ", "f"}], "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DfToFunction", "[", 
     RowBox[{"expr_", ",", " ", "v_List", ",", " ", "n_Integer"}], "]"}], " ",
     ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"a", ",", " ", "u", ",", " ", "m"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Flatten", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"List", "@", 
            RowBox[{"CreateArguments", "[", 
             RowBox[{
              RowBox[{"{", "#", "}"}], ",", " ", "n"}], "]"}]}], "&"}], " ", "/@",
           " ", 
          RowBox[{"v", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"u", " ", "=", " ", 
        RowBox[{"Dispatch", "@", 
         RowBox[{"Thread", "[", 
          RowBox[{"a", " ", "\[Rule]", " ", 
           RowBox[{"(", 
            RowBox[{"Slot", " ", "/@", " ", 
             RowBox[{"Range", "[", 
              RowBox[{"1", ",", " ", 
               RowBox[{"Length", "@", "a"}]}], "]"}]}], ")"}]}], "]"}]}]}], 
       ";", "\[IndentingNewLine]", 
       RowBox[{"a", " ", "=", " ", 
        RowBox[{"Dispatch", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#", "[", "i__", "]"}], " ", "\[RuleDelayed]", "  ", 
            RowBox[{
            "#", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
           "&"}], " ", "/@", " ", "a"}], "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"Function", "@", "expr"}], " ", "/.", "a"}], " ", "/.", 
          " ", "u"}], " ", "/.", " ", 
         RowBox[{
          RowBox[{"Hold", "[", "m_", "]"}], " ", "\[RuleDelayed]", " ", 
          "m"}]}], " ", "/.", "  ", 
        RowBox[{
         RowBox[{"C", "[", "m_", "]"}], " ", "\[RuleDelayed]", " ", 
         "m"}]}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DfToFunction", "[", 
    RowBox[{
    "expr_", ",", " ", "v_List", ",", " ", "n_Integer", ",", " ", "t_", ",", 
     " ", 
     RowBox[{"o", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"DfToCompiledFunction", "[", 
    RowBox[{
    "expr", ",", " ", "v", ",", " ", "n", ",", " ", "t", ",", " ", "o"}], 
    "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"c41b7053-c318-443f-a504-ba3f67ad84d0"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"DfToCompiledFunction", "[", 
     RowBox[{"f_", ",", " ", "v_", ",", " ", 
      RowBox[{"t_:", "_Real"}], ",", " ", 
      RowBox[{"o", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"MapIndexed", "[", 
     RowBox[{
      RowBox[{
       RowBox[{"DfToCompiledFunction", "[", 
        RowBox[{"#1", ",", " ", "v", ",", " ", 
         RowBox[{
          RowBox[{
          "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], "-", 
          "1"}], ",", " ", "t", ",", " ", "o"}], "]"}], "&"}], ",", " ", 
      "f"}], "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"DfToCompiledFunction", "[", 
    RowBox[{"expr_", ",", " ", "v_List", ",", " ", "n_Integer", ",", " ", 
     RowBox[{"t_:", "_Real"}], ",", " ", 
     RowBox[{"o", ":", 
      RowBox[{"OptionsPattern", "[", "Compile", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", " ", "f", ",", " ", "g", ",", " ", "e"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"get", " ", "args"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Flatten", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"List", "@", 
           RowBox[{"CreateArguments", "[", 
            RowBox[{
             RowBox[{"{", "#", "}"}], ",", " ", "n"}], "]"}]}], "&"}], " ", "/@",
          " ", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
        "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"replace", " ", 
        RowBox[{"x", "[", "]"}], " ", 
        RowBox[{"w", "/", " ", 
         RowBox[{"x", "\[LeftDoubleBracket]", "\[RightDoubleBracket]"}]}], 
        " ", "and", " ", "removes", " ", "Hold", " ", "and", " ", "C", " ", 
        "from", " ", 
        RowBox[{"Df", "[", 
         RowBox[{"...", ",", " ", "\"\<ch\>\""}], "]"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"Dispatch", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"#", "[", "i__", "]"}], " ", "\[RuleDelayed]", "  ", 
           RowBox[{
           "#", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
          "&"}], " ", "/@", " ", "a"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
          RowBox[{"\[FormalP]", "[", 
           RowBox[{"a", ",", " ", "expr", ",", " ", "o"}], "]"}], " ", "/.", 
          " ", "e"}], "  ", "/.", " ", 
         RowBox[{
          RowBox[{"Hold", "[", "m_", "]"}], " ", "\[RuleDelayed]", " ", 
          "m"}]}], " ", "/.", " ", 
        RowBox[{
         RowBox[{"C", "[", "m_", "]"}], " ", "\[RuleDelayed]", " ", "m"}]}]}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "args", " ", "for", " ", 
        RowBox[{"compile", ":", " ", 
         RowBox[{"{", 
          RowBox[{"{", 
           RowBox[{"vi", ",", " ", "ui", ",", " ", 
            RowBox[{"len", 
             RowBox[{"(", "vi", ")"}]}]}], "}"}], "}"}]}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"g", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"VectorQ", "[", 
            RowBox[{"v", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
              "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              ",", " ", "2"}], "\[RightDoubleBracket]"}], "]"}], ",", " ", 
           RowBox[{"Length", "@", 
            RowBox[{"v", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
              "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
              ",", " ", "2"}], "\[RightDoubleBracket]"}]}], ",", " ", "1"}], 
          "]"}], "+", 
         RowBox[{"#2", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}],
          "-", "1"}], "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"Join", "[", 
         RowBox[{"#1", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"VectorQ", "[", "t", "]"}], ",", " ", 
              RowBox[{"t", "\[LeftDoubleBracket]", 
               RowBox[{
               "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
               "\[RightDoubleBracket]"}], ",", " ", "t"}], "]"}], ",", " ", 
            RowBox[{"g", "[", "##", "]"}]}], "}"}]}], "]"}], "&"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"ArrayReshape", "[", 
        RowBox[{"a", ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"Length", "@", "v"}], ",", " ", 
           RowBox[{"n", "+", "1"}], ",", " ", "1"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"Join", "@@", 
        RowBox[{"MapIndexed", "[", 
         RowBox[{"f", ",", " ", "a", ",", " ", 
          RowBox[{"{", "2", "}"}]}], "]"}]}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", "compile", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "/.", " ", 
        RowBox[{
         RowBox[{"HoldPattern", "[", "a", "]"}], " ", "\[RuleDelayed]", " ", 
         RowBox[{"Evaluate", "@", "a"}]}]}], " ", "/.", " ", 
       RowBox[{"\[FormalP]", " ", "\[Rule]", " ", "Compile"}]}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"2785f515-8275-4f06-ba21-bed330550834"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Derivatives of Expressions & Pure Functions", \
"Section",ExpressionUUID->"f3602233-0ba7-4bf4-b85c-ea69048d7f3c"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "Df", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"D", " ", "\[Rule]", " ", "2"}], ",", " ", 
      RowBox[{"Simplify", " ", "\[Rule]", " ", "False"}], ",", " ", 
      RowBox[{"N", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], ";"}], " ", 
  
  RowBox[{"(*", " ", 
   RowBox[{"max", " ", "for", " ", "D", " ", "is", " ", "2"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Df", "::", "zero"}], " ", "=", " ", 
    "\"\<Cannot differentiate.  There exist variables with zero length: \
``\>\""}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Df", "[", 
     RowBox[{"f_Function", ",", " ", "x_", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "e", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"create", " ", "args", " ", "and", " ", "func"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"Df", "[", 
         RowBox[{"x", ",", " ", "\"\<args\>\"", ",", " ", 
          RowBox[{"D", "\[Rule]", " ", "0"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"e", " ", "=", " ", 
        RowBox[{"f", "[", 
         RowBox[{"Sequence", "@@", 
          RowBox[{"e", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Df", "[", 
        RowBox[{"e", ",", " ", "x", ",", " ", "opts"}], "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Df", "[", 
    RowBox[{"expr_", ",", " ", "x_", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "e", ",", " ", "f", ",", " ", "n", ",", " ", "v", ",", " ", "F", ",", 
       " ", "J", ",", " ", "H"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "D", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"if", " ", "x", " ", "has", " ", "a", " ", "var", " ", 
        RowBox[{"w", "/", " ", "zero"}], " ", "parameters", " ", "D", " ", 
        "crashes", " ", "MMA"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Or", "@@", 
        RowBox[{"PossibleZeroQ", "@", 
         RowBox[{"Flatten", "@", 
          RowBox[{"x", "\[LeftDoubleBracket]", 
           RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}]}]}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{"v", ",", " ", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"Df", "::", "zero"}], ",", " ", "x"}], "]"}], ";", " ", 
         RowBox[{"Throw", "[", "$Failed", "]"}], ";"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "regular", " ", "simplify", " ", "does", " ", "not", " ", "execute", 
        " ", "in", " ", "reasonable", " ", "amount", " ", "of", " ", "time"}],
        " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"expr", " ", "//.", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{
           RowBox[{"HoldPattern", "[", 
            RowBox[{"a___", " ", "+", " ", 
             RowBox[{"(", 
              RowBox[{"0.", "|", "0"}], ")"}], " ", "+", " ", "b___"}], "]"}],
            " ", "\[RuleDelayed]", " ", 
           RowBox[{"(", 
            RowBox[{"a", "+", "b"}], ")"}]}], ",", " ", 
          RowBox[{
           RowBox[{"HoldPattern", "[", 
            RowBox[{"a___", " ", "*", " ", 
             RowBox[{"(", 
              RowBox[{"1.", "|", "1"}], ")"}], " ", "*", " ", "b___"}], "]"}],
            " ", "\[RuleDelayed]", " ", 
           RowBox[{"(", 
            RowBox[{"a", "*", "b"}], ")"}]}]}], "}"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"get", " ", "vectorized", " ", "derivatives", " ", "v"}], " ",
         "=", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"x", "[", "1", "]"}], ",", " ", 
            RowBox[{"dx", "[", "1", "]"}], ",", " ", 
            RowBox[{"ddx", "[", "1", "]"}], ",", " ", ".."}], "}"}], ",", " ",
           ".."}], "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"v", " ", "=", " ", 
       RowBox[{"Df", "[", 
        RowBox[{"x", ",", " ", "\"\<vec\>\"", ",", " ", "opts"}], "]"}]}], 
      ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"compute", " ", "derivatives", " ", "1"}], ".."}], "n"}], 
       " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"F", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"D", "[", 
          RowBox[{"e", ",", " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", " ", "j"}], "}"}]}], "]"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", 
           RowBox[{"v", "\[LeftDoubleBracket]", 
            RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"j", ",", " ", "n"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"F", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{"F", ",", " ", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", 
           RowBox[{"2", ";;", 
            RowBox[{"n", "+", "1"}]}]}], "\[RightDoubleBracket]"}]}], "}"}]}],
       ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"J", " ", "=", " ", 
       RowBox[{"Df", "[", 
        RowBox[{"F", ",", " ", "\"\<J\>\"", ",", " ", "opts"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"H", " ", "=", " ", 
       RowBox[{"Df", "[", 
        RowBox[{"F", ",", " ", "\"\<H\>\"", ",", " ", "opts"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"F", " ", "=", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"e", ",", " ", "J", ",", " ", "H"}], "}"}], 
        "\[LeftDoubleBracket]", 
        RowBox[{"1", ";;", 
         RowBox[{"n", "+", "1"}]}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"OptionValue", "[", "Simplify", "]"}], ",", " ", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"v", " ", "=", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"Element", "[", 
             RowBox[{"#", ",", " ", "Reals"}], "]"}], "&"}], " ", "/@", " ", 
           RowBox[{"Flatten", "@", "v"}]}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"Simplify", "[", 
          RowBox[{"F", ",", " ", 
           RowBox[{"Assumptions", "\[Rule]", " ", "v"}]}], "]"}]}], ",", " ", 
        "\[IndentingNewLine]", "F"}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"5138e62a-d14c-48ed-98bb-ac1831fd9f7d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Helper Functions", \
"Section",ExpressionUUID->"f6194841-fa43-4082-bf8d-eb05d7a12951"],

Cell[CellGroupData[{

Cell["Parse N option", \
"Subsection",ExpressionUUID->"bd2438b2-d6ec-4235-9489-c1efaa780a19"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Df", "::", "D"}], " ", "=", " ", 
   "\"\<Maximum value for D is 2.  It's currently ``.  Errors are \
likely.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Df", "[", 
   RowBox[{"v_", ",", " ", "N", ",", " ", 
    RowBox[{"opts", ":", 
     RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
  RowBox[{"Module", "[", 
   RowBox[{
    RowBox[{"{", "n", "}"}], ",", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"n", " ", "=", " ", 
      RowBox[{"OptionValue", "[", "D", "]"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{
        RowBox[{"n", " ", ">", " ", "2"}], " ", "||", " ", 
        RowBox[{"n", " ", "<", " ", "0"}]}], ",", " ", 
       RowBox[{"Message", "[", 
        RowBox[{
         RowBox[{"Df", "::", "D"}], ",", " ", "n"}], "]"}]}], "]"}], ";", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"n", " ", "=", " ", 
      RowBox[{"OptionValue", "[", "N", "]"}]}], ";", " ", 
     RowBox[{"(*", " ", 
      RowBox[{"#", " ", "of", " ", "variables", " ", "to", " ", "diff", " ", 
       RowBox[{"w", ".", "r", ".", "t"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"If", "[", 
      RowBox[{
       RowBox[{"n", " ", "===", " ", "Automatic"}], ",", " ", 
       RowBox[{"Total", "[", 
        RowBox[{"Times", "@@@", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], "]"}], 
       ",", " ", "n"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"dff51cd6-db22-4b68-8450-e03149bffb88"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Derivative Directions, dx, dy, etc.", \
"Subsection",ExpressionUUID->"a4c29a68-3a40-49d1-84b6-2f35aca77f19"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Df", "[", 
     RowBox[{"v_", ",", " ", "\"\<args\>\"", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "n", ",", " ", "m", ",", " ", "d", ",", " ", "u", ",", " ", "nd"}], 
       "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"OptionValue", "[", "D", "]"}]}], ";", "\[IndentingNewLine]", 
       
       RowBox[{"nd", " ", "=", " ", 
        RowBox[{"Df", "[", 
         RowBox[{"v", ",", " ", "N", ",", " ", "opts"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"u", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"List", "@", 
           RowBox[{"CreateArguments", "[", 
            RowBox[{
             RowBox[{"{", "#", "}"}], ",", " ", "n"}], "]"}]}], "&"}], " ", "/@",
          " ", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "1"}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"d", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"VectorQ", "[", "#", "]"}], ",", " ", "#", ",", " ", 
            RowBox[{"{", "#", "}"}]}], "]"}], "&"}], " ", "/@", " ", 
         RowBox[{"v", "\[LeftDoubleBracket]", 
          RowBox[{"All", ",", " ", "2"}], "\[RightDoubleBracket]"}]}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"Table", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"m", " ", "=", " ", 
           RowBox[{"Length", "@", 
            RowBox[{
            "d", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"m", " ", "=", " ", 
           RowBox[{"PadRight", "[", 
            RowBox[{
             RowBox[{
             "d", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], ",",
              " ", 
             RowBox[{"{", 
              RowBox[{"m", "+", "j"}], "}"}], ",", " ", "nd"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"Array", "[", 
           RowBox[{
            RowBox[{"u", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", " ", 
              RowBox[{"j", "+", "1"}]}], "\[RightDoubleBracket]"}], ",", " ", 
            "m"}], "]"}]}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", 
           RowBox[{"Length", "@", "v"}]}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"j", ",", " ", "0", ",", " ", "n"}], "}"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Df", "[", 
    RowBox[{"v_", ",", " ", "\"\<vec\>\"", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "n", ",", " ", "m", ",", " ", "d", ",", " ", "u", ",", " ", "nd"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"m", " ", "=", " ", 
       RowBox[{"Length", "@", "v"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "D", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nd", " ", "=", " ", 
       RowBox[{"Df", "[", 
        RowBox[{"v", ",", " ", "N", ",", " ", "opts"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"u", " ", "=", " ", 
       RowBox[{"Df", "[", 
        RowBox[{"v", ",", " ", "\"\<args\>\"", ",", " ", "opts", ",", " ", 
         RowBox[{"N", " ", "\[Rule]", " ", "nd"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"vectorize", " ", "derivatives"}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"Table", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"Times", "@@", 
           RowBox[{"v", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", " ", "2"}], "\[RightDoubleBracket]"}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"d", " ", "=", " ", 
          RowBox[{"PadRight", "[", 
           RowBox[{
            RowBox[{"{", "d", "}"}], ",", " ", "j", ",", " ", "nd"}], "]"}]}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"ArrayReshape", "[", 
          RowBox[{
           RowBox[{"u", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], ",", " ",
            "d"}], "]"}]}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "m"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"j", ",", " ", 
          RowBox[{"n", "+", "1"}]}], "}"}]}], "\[IndentingNewLine]", 
       "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"b90534fc-6ac5-4fb9-b1f9-b53a072c3c5d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Chain rule for Jacobians and Hessians", \
"Subsection",ExpressionUUID->"a21b86bc-f87f-4cf8-8259-3c711b1ef6e1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Df", "[", 
     RowBox[{"F_", ",", " ", "\"\<J\>\"", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"J", ",", " ", "d"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"chain", " ", "rule", " ", 
        RowBox[{"Jacobian", ":", " ", 
         RowBox[{
          RowBox[{"df", "/", "dx"}], " ", 
          RowBox[{"dx", "/", "dc"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"F", " ", "=", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
            RowBox[{"df", "/", "dx1"}], ",", " ", "...", ",", " ", 
            RowBox[{"df", "/", "dxn"}]}], "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"dx1", "/", "dc"}], ",", " ", "...", ",", " ", 
            RowBox[{"dxn", "/", "dc"}]}], "}"}]}], "}"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"J", " ", "=", " ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"MemberQ", "[", 
            RowBox[{
             RowBox[{"Join", "[", 
              RowBox[{
               RowBox[{"#1", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
               RowBox[{"#2", "\[LeftDoubleBracket]", 
                RowBox[{"1", ";;", "1"}], "\[RightDoubleBracket]"}]}], "]"}], 
             ",", " ", 
             RowBox[{"{", "}"}]}], "]"}], ",", " ", 
           RowBox[{"{", "}"}], ",", " ", 
           RowBox[{
            RowBox[{
            "#1", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ".", 
            RowBox[{
            "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}], 
          "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"OptionValue", "[", "D", "]"}], " ", "\[GreaterEqual]", " ",
           "1"}], ",", " ", 
         RowBox[{"Plus", "@@", 
          RowBox[{"MapThread", "[", 
           RowBox[{"J", ",", " ", "F"}], "]"}]}], ",", 
         RowBox[{"{", "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Df", "[", 
    RowBox[{"F_", ",", " ", "\"\<H\>\"", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"H", ",", " ", "t", ",", " ", "d", ",", " ", "h"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"chain", " ", "rule", " ", 
       RowBox[{"Hessian", ":", " ", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{"dx", "/", "dc"}], ")"}], "\[Transpose]"}], ".", 
           RowBox[{"d", "^", "2"}]}], 
          RowBox[{"f", "/", 
           RowBox[{"dx", "^", "2."}]}], 
          RowBox[{"(", 
           RowBox[{"dx", "/", "dc"}], ")"}]}], " ", "+", " ", 
         RowBox[{
          RowBox[{
           RowBox[{"(", 
            RowBox[{"df", "/", "dx"}], ")"}], ".", 
           RowBox[{"d", "^", "2"}]}], 
          RowBox[{"x", "/", 
           RowBox[{"dc", "^", "2"}]}]}]}]}]}], "  ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"F", " ", "=", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"df", "/", "dx"}], ",", " ", 
             RowBox[{
              RowBox[{"d", "^", "2"}], 
              RowBox[{"f", "/", 
               RowBox[{"dx", "^", "2"}]}]}]}], "}"}], ",", " ", ".."}], "}"}],
          ",", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
             RowBox[{"dx", "/", "dc"}], ",", " ", 
             RowBox[{
              RowBox[{"d", "^", "2"}], 
              RowBox[{"x", "/", 
               RowBox[{"dc", "^", "2"}]}]}]}], "}"}], ",", " ", ".."}], 
          "}"}]}], "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"d", " ", "=", " ", "ArrayDepth"}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"t", " ", "=", " ", 
       RowBox[{
        RowBox[{"Transpose", "[", 
         RowBox[{"#1", ",", " ", 
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"Range", "[", 
             RowBox[{"1", ",", " ", 
              RowBox[{"#2", "-", "2"}]}], "]"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"#2", ",", " ", 
              RowBox[{"#2", " ", "-", " ", "1"}]}], "}"}]}], "]"}]}], "]"}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"h", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"t", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"t", "[", 
             RowBox[{
              RowBox[{
               RowBox[{
               "#1", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
               ".", 
               RowBox[{
               "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
               ",", " ", 
              RowBox[{"d", "[", 
               RowBox[{
               "#1", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
               "]"}]}], "]"}], ".", 
            RowBox[{
            "#2", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], 
           ",", " ", 
           RowBox[{"d", "[", 
            RowBox[{
            "#1", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], 
            "]"}]}], "]"}], "+", " ", 
         RowBox[{
          RowBox[{
          "#1", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ".", 
          RowBox[{
          "#2", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}]}], 
        "&"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"H", " ", "=", " ", 
       RowBox[{
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"MemberQ", "[", 
           RowBox[{
            RowBox[{"Join", "[", 
             RowBox[{
              RowBox[{"#1", "\[LeftDoubleBracket]", 
               RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}], ",", " ", 
              
              RowBox[{"#2", "\[LeftDoubleBracket]", 
               RowBox[{"1", ";;", "2"}], "\[RightDoubleBracket]"}]}], "]"}], 
            ",", " ", 
            RowBox[{"{", "}"}]}], "]"}], ",", " ", 
          RowBox[{"{", "}"}], ",", " ", 
          RowBox[{"h", "@", "##"}]}], "]"}], "&"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"OptionValue", "[", "D", "]"}], " ", "\[GreaterEqual]", " ", 
         "2"}], ",", " ", 
        RowBox[{"Plus", "@@", 
         RowBox[{"MapThread", "[", 
          RowBox[{"H", ",", " ", "F"}], "]"}]}], ",", " ", 
        RowBox[{"{", "}"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"942e65eb-b458-4a6c-8404-4e8275100524"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Chain rule", \
"Subsection",ExpressionUUID->"59470328-d6b2-4515-8923-505feb9dc60b"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"Df", "::", "i"}], " ", "=", " ", 
   "\"\<An index is out of bounds: `1` <= `2` \>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Df", "[", 
    RowBox[{"F_", ",", " ", "\"\<i\>\"", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", " ", ",", "N"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"multi", "-", 
       RowBox[{"index", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "j", ",", " ", ".."}], "}"}], " ", "into", 
        " ", "linear", " ", "index", " ", "k"}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"A", "[", 
        RowBox[{"i", ",", " ", "j", ",", " ", "..."}], "]"}], " ", "\[Rule]", 
       " ", 
       RowBox[{"vec", 
        RowBox[{
         RowBox[{"(", "A", ")"}], "[", "k", "]"}]}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"{", 
        RowBox[{"n", ",", " ", "N"}], "}"}], " ", "=", " ", "F"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"MemberQ", "[", 
         RowBox[{
          RowBox[{"Thread", "[", 
           RowBox[{
           "1", " ", "\[LessEqual]", " ", "n", " ", "\[LessEqual]", " ", 
            "N"}], "]"}], ",", " ", "False"}], "]"}], ",", " ", 
        RowBox[{
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"Df", "::", "i"}], ",", " ", "n", " ", ",", "N"}], "]"}], 
         ";", " ", 
         RowBox[{"Throw", "[", "$Failed", "]"}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Length", "@", "n"}], " ", "\[Equal]", " ", "0"}], ",", " ", 
        "n", ",", " ", "\[IndentingNewLine]", "True", ",", 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"Sum", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"(", 
             RowBox[{
              RowBox[{
              "n", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              "-", "1"}], ")"}], " ", 
            RowBox[{"Times", "@@", 
             RowBox[{"N", "\[LeftDoubleBracket]", 
              RowBox[{
               RowBox[{"i", "+", "1"}], ";;"}], "\[RightDoubleBracket]"}]}]}],
            ",", " ", 
           RowBox[{"{", 
            RowBox[{"i", ",", " ", 
             RowBox[{
              RowBox[{"Length", "[", "n", "]"}], "-", "1"}]}], "}"}]}], "]"}],
          " ", "+", " ", 
         RowBox[{"n", "\[LeftDoubleBracket]", 
          RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"3fea569c-10fb-4bdb-8141-e94c0f6e3907"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Df", "[", 
    RowBox[{"F_", ",", " ", "\"\<ch\>\"", ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "e", ",", " ", "f0", ",", " ", "f", ",", " ", "m", ",", " ", "u", ",", 
       " ", "d", ",", " ", "J", ",", " ", "H", ",", " ", "n", ",", " ", "r"}],
       "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"chain", " ", "rule", " ", "with", " ", "symbols"}], " ", 
      "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"F", " ", "=", " ", 
        RowBox[{"{", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"f1", ",", " ", "...", ",", " ", "fn"}], "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"v1", ",", " ", "...", ",", " ", "vm"}], "}"}]}], "}"}]}], 
       ",", " ", 
       RowBox[{"where", " ", "fi", " ", "is", " ", "a", " ", "vector"}]}], 
      " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"f0", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"First", "@", 
          RowBox[{"Df", "[", 
           RowBox[{"#", ",", " ", 
            RowBox[{
            "F", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}], ",", 
            " ", 
            RowBox[{"D", "\[Rule]", " ", "0"}], ",", " ", "opts"}], "]"}]}], 
         "&"}], " ", "/@", " ", 
        RowBox[{
        "F", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "D", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{"n", " ", ">", " ", "0"}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"f", " ", "=", " ", 
          RowBox[{"Total", "[", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Table", "[", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{"take", " ", "partial", " ", "derivative", " ", 
               RowBox[{"df", "/", "dv"}]}], " ", "*)"}], 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"m", " ", "=", " ", 
                RowBox[{"Times", "@@", 
                 RowBox[{
                 "v", "\[LeftDoubleBracket]", "2", 
                  "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"e", " ", "=", " ", 
                RowBox[{"Df", "[", 
                 RowBox[{"f", ",", " ", 
                  RowBox[{"{", "v", "}"}], ",", " ", 
                  RowBox[{"N", " ", "\[Rule]", " ", "m"}], ",", " ", "opts"}],
                  "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
               
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"we", " ", "now", " ", "have", " ", 
                  RowBox[{"df", "/", "dv"}], " ", 
                  RowBox[{"dv", "/", "dc"}]}], ",", " ", 
                 RowBox[{
                  RowBox[{"let", " ", 
                   RowBox[{"dv", "/", "dc"}]}], " ", "=", " ", 
                  RowBox[{"dv", "/", "dv"}]}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{
                 "do", " ", "this", " ", "by", " ", "declaring", " ", "rules",
                   " ", "to", " ", "zero", " ", "out", " ", "non"}], "-", 
                 RowBox[{"diagonal", " ", "terms"}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                "and", " ", "set", " ", "diagonal", " ", "terms", " ", "to", 
                 " ", "1"}], " ", "*)"}], "\[IndentingNewLine]", 
               RowBox[{"u", " ", "=", " ", 
                RowBox[{"List", "@", 
                 RowBox[{"CreateArguments", "[", 
                  RowBox[{
                   RowBox[{"Evaluate", "@", 
                    RowBox[{"{", 
                    RowBox[{
                    "v", "\[LeftDoubleBracket]", "1", 
                    "\[RightDoubleBracket]"}], "}"}]}], ",", " ", "n"}], 
                  "]"}]}]}], ";", "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"r", " ", "=", " ", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                   RowBox[{"#", "[", "__Integer", "]"}], " ", "\[Rule]", " ", 
                   "0"}], "&"}], " ", "/@", " ", 
                 RowBox[{"u", "\[LeftDoubleBracket]", 
                  RowBox[{"2", ";;", 
                   RowBox[{"n", "+", "1"}]}], "\[RightDoubleBracket]"}]}]}], 
               ";", "\[IndentingNewLine]", 
               RowBox[{"r", " ", "=", " ", 
                RowBox[{"Prepend", "[", 
                 RowBox[{"r", ",", " ", 
                  RowBox[{
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}], "[", 
                    RowBox[{"i__Integer", ",", " ", "j_Integer"}], "]"}], " ",
                     "/;", " ", 
                    RowBox[{
                    RowBox[{"Df", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", "i", "}"}], ",", " ", 
                    RowBox[{
                    "v", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}], "}"}], ",", " ", "\"\<i\>\"",
                     ",", " ", "opts"}], "]"}], " ", "\[Equal]", " ", "j"}]}],
                    " ", "\[Rule]", " ", "1"}]}], "]"}]}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"d", " ", "=", " ", 
                RowBox[{"{", 
                 RowBox[{
                  RowBox[{"{", 
                   RowBox[{
                    RowBox[{"e", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ";;", 
                    RowBox[{"n", "+", "1"}]}], "\[RightDoubleBracket]"}], " ",
                     "/.", " ", "r"}], "}"}], ",", " ", 
                  RowBox[{"{", 
                   RowBox[{"u", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ";;", 
                    RowBox[{"n", "+", "1"}]}], "\[RightDoubleBracket]"}], 
                   "}"}]}], "}"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                "hacky", " ", "workaround", " ", "to", " ", "avoid", " ", 
                 "errors", " ", "from", " ", "Partition", " ", "and", " ", 
                 "Flatten"}], " ", "*)"}], "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                "would", " ", "like", " ", "to", " ", "keep", " ", "these", 
                 " ", "functions", " ", "in", " ", "unevaluated", " ", 
                 "state", " ", "while"}], " ", "*)"}], "\[IndentingNewLine]", 
               
               RowBox[{"(*", " ", 
                RowBox[{
                "maintaining", " ", "rule", " ", "that", " ", "resulting", 
                 " ", "expressions", " ", 
                 RowBox[{"don", "'"}], "t", " ", "need", " ", "to", " ", "be",
                  " ", "held"}], " ", "*)"}], "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{"DfToFunction", " ", "removes", " ", 
                 RowBox[{"hold", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"J", " ", "=", " ", 
                RowBox[{"Df", "[", 
                 RowBox[{"d", ",", " ", "\"\<J\>\"", ",", " ", "opts"}], 
                 "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"H", " ", "=", " ", 
                RowBox[{"Df", "[", 
                 RowBox[{"d", ",", " ", "\"\<H\>\"", ",", " ", "opts"}], 
                 "]"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"Length", "@", 
                   RowBox[{
                   "v", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}], " ", ">", " ", "1"}], ",", 
                 " ", "\[IndentingNewLine]", 
                 RowBox[{"(*", " ", 
                  RowBox[{
                  "variable", " ", "C", " ", "has", " ", "attribute", " ", 
                   "NHoldAll"}], " ", "*)"}], "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"J", " ", "=", " ", 
                   RowBox[{"J", " ", "/.", " ", 
                    RowBox[{
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}], " ", "\[Rule]", " ", 
                    "\[FormalX]"}]}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"J", " ", "=", " ", 
                   RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"a", " ", "=", " ", "J"}], ",", " ", 
                    RowBox[{"b", " ", "=", " ", 
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}]}], "}"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Hold", "@", 
                    RowBox[{"Block", "[", 
                    RowBox[{
                    RowBox[{"{", "\[FormalX]", "}"}], ",", " ", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"\[FormalX]", " ", "=", " ", 
                    RowBox[{"Partition", "[", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "b", "]"}], ",", " ", 
                    RowBox[{
                    RowBox[{"Dimensions", "[", "b", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
                    ";", "\[IndentingNewLine]", "a"}]}], 
                    "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"n", " ", "\[GreaterEqual]", " ", "2"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"H", " ", "=", " ", 
                    RowBox[{"H", " ", "/.", " ", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}], " ", "\[Rule]", " ", 
                    "\[FormalX]"}], ",", " ", 
                    RowBox[{
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "3", 
                    "\[RightDoubleBracket]"}], " ", "\[Rule]", " ", 
                    "\[FormalY]"}]}], "}"}]}]}], ";", "\[IndentingNewLine]", 
                    RowBox[{"H", " ", "=", " ", 
                    RowBox[{"With", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"a", " ", "=", " ", "H"}], ",", " ", 
                    RowBox[{"b", " ", "=", " ", 
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "2", 
                    "\[RightDoubleBracket]"}]}], ",", " ", 
                    RowBox[{"c", " ", "=", " ", 
                    RowBox[{
                    "u", "\[LeftDoubleBracket]", "3", 
                    "\[RightDoubleBracket]"}]}]}], "}"}], ",", " ", 
                    "\[IndentingNewLine]", 
                    RowBox[{"Hold", "@", 
                    RowBox[{"Block", "[", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"\[FormalX]", ",", " ", "\[FormalY]"}], "}"}], 
                    ",", " ", "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"\[FormalX]", " ", "=", " ", 
                    RowBox[{"Partition", "[", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "c", "]"}], ",", " ", 
                    RowBox[{
                    RowBox[{"Dimensions", "[", "c", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"\[FormalY]", " ", "=", " ", 
                    RowBox[{"Partition", "[", 
                    RowBox[{"\[FormalX]", ",", " ", 
                    RowBox[{
                    RowBox[{"Dimensions", "[", "c", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "2"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
                    ";", "\[IndentingNewLine]", 
                    RowBox[{"\[FormalX]", " ", "=", " ", 
                    RowBox[{"Partition", "[", 
                    RowBox[{
                    RowBox[{"Flatten", "[", "b", "]"}], ",", " ", 
                    RowBox[{
                    RowBox[{"Dimensions", "[", "b", "]"}], 
                    "\[LeftDoubleBracket]", 
                    RowBox[{"-", "1"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
                    ";", "\[IndentingNewLine]", "a"}]}], 
                    "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", 
                    "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"{", 
                 RowBox[{"J", ",", " ", "H"}], "}"}], "\[LeftDoubleBracket]", 
                
                RowBox[{"1", ";;", "n"}], "\[RightDoubleBracket]"}]}], ",", 
              "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"f", ",", " ", "f0"}], "}"}], ",", " ", 
              RowBox[{"{", 
               RowBox[{"v", ",", " ", 
                RowBox[{
                "F", "\[LeftDoubleBracket]", "2", "\[RightDoubleBracket]"}]}],
                "}"}]}], "\[IndentingNewLine]", "]"}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"{", "2", "}"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"{", "f0", "}"}], ",", " ", 
            RowBox[{"f", "\[Transpose]"}]}], "]"}], "\[Transpose]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", "f0", "}"}], "\[Transpose]"}]}], "\[IndentingNewLine]", 
       "]"}]}]}], "\[IndentingNewLine]", 
    RowBox[{"(*", " ", 
     RowBox[{"returns", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"f1", ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"df1", "/", "dv1"}], " ", 
             RowBox[{"dv1", "/", "dc"}]}], " ", "+"}], " ", ".."}], ",", " ", 
          
          RowBox[{
           RowBox[{
            RowBox[{
             RowBox[{"d", "^", "2"}], 
             RowBox[{"f1", "/", 
              RowBox[{"dv1", "^", "2"}]}], " ", 
             RowBox[{"d", "^", "2"}], 
             RowBox[{"v1", "/", 
              RowBox[{"dc", "^", "2"}]}]}], " ", "+"}], " ", ".."}]}], "}"}], 
        ",", " ", ".."}], "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"51d94759-f40d-4089-b777-3f54d3415263"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"0ad6f41f-3a9f-42c2-bdf3-3fbee5af9367"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"2143a952-ac86-44ce-80d6-af271244e104"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1373, 1505},
WindowMargins->{{0, Automatic}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

