Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"PackageVariables", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "Lists", " ", "global", " ", "variables", " ", "used", " ", "by", " ", 
      "the", " ", "NLinks", " ", 
      RowBox[{"package", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"96f1530e-e5b4-45ee-9451-2118fe68c73c"],

Cell["TODO", "Section",ExpressionUUID->"b4a75db0-48b0-4e30-a12c-b22baf44dd9e"],

Cell[CellGroupData[{

Cell["Notes", \
"Section",ExpressionUUID->"d7a8226c-136d-4e4c-a45c-c34cc06d7e26"],

Cell["\<\
If code from functions used below is changed, then it is useful to check that \
no subtle differentiation bugs are introduced:

CheckSetStatements@DownValues@#& /@ \
DeleteDuplicates@Join[RigidBodyDynamics`Private`FMbJ[\[OpenCurlyDoubleQuote]f\
\[CloseCurlyDoubleQuote]], RigidBodyDynamics`Private`HMbJ[\
\[OpenCurlyDoubleQuote]f\[CloseCurlyDoubleQuote]],
RigidBodyDynamics`Private`\[Eta]MbJ[\[OpenCurlyDoubleQuote]f\
\[CloseCurlyDoubleQuote]]]\
\>", "Text",ExpressionUUID->"e5cff6b1-26c2-4052-994d-68a12eb3d91b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"09f8a0d7-89c9-43a0-8b39-721e60c15083"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{"\"\<RigidBodyDynamics`\>\"", ",", " ", 
   RowBox[{"{", 
    RowBox[{"\"\<GlobalVariables`\>\"", ",", " ", "\"\<Derivatives`\>\""}], 
    "}"}]}], "]"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"751af5ad-8043-4517-b9ef-40132f72aa50"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDMergeRecipes", "[", "x__", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"f", ",", " ", "a", ",", " ", "r", ",", " ", "X"}], "}"}], ",",
       "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"f", " ", "=", " ", 
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{"Length", "@", "#"}], " ", "\[LessEqual]", " ", "1"}], 
           ",", " ", 
           RowBox[{
           "#", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], ",", 
           " ", 
           RowBox[{"Join", "@@", "#"}]}], "]"}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"r", " ", "=", " ", 
        RowBox[{
         RowBox[{"Hold", "[", "a_", "]"}], " ", "\[RuleDelayed]", " ", 
         RowBox[{"With", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{"e", " ", "=", " ", 
             RowBox[{"f", "[", "a", "]"}]}], "}"}], ",", " ", 
           RowBox[{"e", " ", "/;", " ", "True"}]}], "]"}]}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"X", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "@", 
          RowBox[{"{", "x", "}"}]}], " ", "/.", " ", 
         RowBox[{"{", 
          RowBox[{
           RowBox[{"\"\<confun\>\"", " ", "\[Rule]", " ", "confun"}], ",", 
           " ", 
           RowBox[{"\"\<spatfun\>\"", " ", "\[Rule]", " ", "spatfun"}], ",", 
           " ", 
           RowBox[{"\"\<FMbJ\>\"", " ", "\[Rule]", " ", "FMbJ"}], ",", " ", 
           RowBox[{"\"\<HMbJ\>\"", " ", "\[Rule]", " ", "HMbJ"}], ",", " ", 
           RowBox[{"\"\<\[Eta]MbJ\>\"", " ", "\[Rule]", " ", "\[Eta]MbJ"}], 
           ",", " ", 
           RowBox[{"\"\<datrules\>\"", " ", "\[Rule]", " ", "datrules"}]}], 
          "}"}]}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"With", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"A", " ", "=", " ", "X"}], "}"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"BlockExpression", "[", 
          RowBox[{
           RowBox[{"{", "}"}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Merge", "[", 
             RowBox[{"A", ",", " ", "Hold"}], "]"}], " ", "/.", " ", "r"}], 
           ",", " ", "\[IndentingNewLine]", 
           RowBox[{"{", 
            RowBox[{"f", ",", " ", "r", ",", " ", "True"}], "}"}]}], 
          "\[IndentingNewLine]", "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetRecipe", "::", "n"}], " ", "=", " ", 
   "\"\<`` is an unknown recipe.\>\""}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetRecipe", "[", "name_", "]"}], " ", ":=", " ", 
   RowBox[{"Switch", "[", 
    RowBox[{"name", ",", " ", "\[IndentingNewLine]", "\"\<FMbJ\>\"", ",", " ", 
     RowBox[{"RBDMergeRecipes", "[", 
      RowBox[{"\"\<FMbJ\>\"", ",", " ", 
       RowBox[{"<|", 
        RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
         RowBox[{"{", "F", "}"}]}], "|>"}]}], "]"}], ",", 
     "\[IndentingNewLine]", "\"\<HMbJ\>\"", ",", " ", 
     RowBox[{"RBDMergeRecipes", "[", 
      RowBox[{"\"\<HMbJ\>\"", ",", " ", 
       RowBox[{"<|", 
        RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
         RowBox[{"{", "H", "}"}]}], "|>"}]}], "]"}], ",", 
     "\[IndentingNewLine]", "\"\<\[Eta]MbJ\>\"", ",", " ", 
     RowBox[{"RBDMergeRecipes", "[", 
      RowBox[{"\"\<\[Eta]MbJ\>\"", ",", " ", 
       RowBox[{"<|", 
        RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
         RowBox[{"{", "Eta", "}"}]}], "|>"}]}], "]"}], ",", 
     "\[IndentingNewLine]", "True", ",", " ", 
     RowBox[{
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"RBDGetRecipe", "::", "n"}], ",", " ", "name"}], "]"}], ";", 
      " ", 
      RowBox[{"<|", "|>"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"240b9f6a-7a87-4a7c-88dd-c612419e7448"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Inlined functions and data", \
"Section",ExpressionUUID->"2c5005e6-7196-4595-a709-0608eedea9a4"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"spatfun", " ", "=", " ", 
    RowBox[{"<|", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<I\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"ufun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"agfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"sfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"sdotfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"fext0fun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"\[DoubleStruckCapitalI]fun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"XLfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"z1", ",", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"z3", ",", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"z6", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"zq", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"zspat", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Z3", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"ZM", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}]}], "\[IndentingNewLine]", "}"}]}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<O\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", "|>"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"confun", " ", "=", " ", 
    RowBox[{"<|", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<I\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[Phi]fun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"rfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"rdotfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Jfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Tcbfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"\[Eta]fun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"Kfun", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}],
               "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "nc"}],
               "}"}]}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"zpos", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"ZAb", ",", " ", 
           RowBox[{"{", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "nx"}], 
             "}"}], "}"}]}], "}"}]}], "\[IndentingNewLine]", "}"}]}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<O\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", "|>"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"datrules", " ", "=", " ", 
   RowBox[{"{", 
    RowBox[{
     RowBox[{
      RowBox[{"HoldPattern", "[", "parent", "]"}], " ", "\[RuleDelayed]", 
      "  ", "parent"}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "bx", "]"}], " ", "\[RuleDelayed]", "  ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<bx\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "bs", "]"}], " ", "\[RuleDelayed]", " ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<bs\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "bo", "]"}], " ", "\[RuleDelayed]", "  ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<bo\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "ba", "]"}], " ", "\[RuleDelayed]", " ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<ba\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "pcons", "]"}], " ", "\[RuleDelayed]", "  ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<p\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "vcons", "]"}], " ", "\[RuleDelayed]", "  ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<v\>\""}], "]"}]}], ",", " ", 
     RowBox[{
      RowBox[{"HoldPattern", "[", "ucons", "]"}], " ", "\[RuleDelayed]", "  ", 
      RowBox[{"rb", "[", 
       RowBox[{"C", ",", " ", "\"\<u\>\""}], "]"}]}]}], "}"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"08e5aa60-2d1b-4b05-ae60-874b05f90a54"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Equations of motion for constrained mechanical systems", \
"Section",ExpressionUUID->"cdfa3874-2044-4a4e-a2a8-b18153c8459c"],

Cell[BoxData[
 RowBox[{
  RowBox[{"FMbJ", " ", "=", " ", 
   RowBox[{"<|", "\[IndentingNewLine]", 
    RowBox[{
     RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "\"\<f\>\""}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", 
       RowBox[{
       "MbJQtys", ",", " ", "RNEA", ",", " ", "CRB", ",", " ", "X0", ",", " ",
         "rs0", ",", " ", "JOSIM", ",", " ", "EOM"}], "}"}]}], ",", 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"\"\<lcls\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", 
       RowBox[{
       "q", ",", " ", "qd", ",", " ", "qdd", ",", " ", "u", ",", " ", "uJ", 
        ",", " ", "ag", ",", " ", "fext0", ",", " ", "\[Phi]", ",", " ", "s", 
        ",", " ", "sdot", ",", " ", "v", ",", " ", "a", ",", " ", "f", ",", 
        " ", "fext", ",", " ", "r", ",", " ", "rdot", ",", " ", "sj", ",", 
        " ", "ro", ",", " ", "sjdot", ",", " ", "rodot", ",", " ", "posXco", 
        ",", " ", "M", ",", " ", "\[DoubleStruckCapitalI]", ",", " ", "XL", 
        ",", " ", "Tcb", ",", " ", "XL0", ",", " ", "X0L", ",", " ", "RL0", 
        ",", " ", "R0L", ",", " ", "sj", ",", " ", "sjdot", ",", " ", "ro", 
        ",", " ", "rodot", ",", " ", "Xo0", ",", " ", "J", ",", " ", "\[Phi]",
         ",", " ", "\[Eta]", ",", " ", "K", ",", " ", "Ab", ",", " ", "b", 
        ",", " ", "o", ",", " ", "nq", ",", " ", "nx", ",", " ", "nf", ",", 
        " ", "nv", ",", " ", "nu"}], "}"}]}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"\"\<v\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "1"}], 
         "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "1"}], 
         "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"ufun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"agfun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"\[Phi]fun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"sfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"sdotfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"fext0fun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"rfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"rdotfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"Jfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"\[Eta]fun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"Kfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{
         "\[DoubleStruckCapitalI]fun", ",", " ", "_Real", ",", " ", "3"}], 
         "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"XLfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"Tcbfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"z1", ",", " ", "_Real", ",", " ", "0"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"z3", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"z6", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"zq", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"zpos", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"zspat", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"Z3", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"ZM", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"ZAb", ",", " ", "_Real", ",", " ", "2"}], "}"}]}], "}"}]}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"\"\<d\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"parent", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"bx", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"bs", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"bo", ",", " ", "_Integer", ",", " ", "2"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"ba", ",", " ", "_Integer", ",", " ", "3"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"pcons", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"vcons", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"ucons", ",", " ", "_Integer", ",", " ", "1"}], "}"}]}], 
       "}"}]}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"\"\<I\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"mxv", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
            " ", 
            RowBox[{"{", 
             RowBox[{"v", ",", " ", "_Real", ",", " ", "nm"}], "}"}]}], 
           "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"mxstarf", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
            " ", 
            RowBox[{"{", 
             RowBox[{"v", ",", " ", "_Real", ",", " ", "nm"}], "}"}]}], 
           "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"posX", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"X", ",", " ", "_Real", ",", " ", 
              RowBox[{"{", 
               RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"Y", ",", " ", "_Real", ",", " ", 
              RowBox[{"{", 
               RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}]}], "}"}]}], 
         "}"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"mxX", ",", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
            " ", 
            RowBox[{"{", 
             RowBox[{"X", ",", " ", "_Real", ",", " ", 
              RowBox[{"{", 
               RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}]}], "}"}]}], 
         "}"}]}], "\[IndentingNewLine]", "}"}]}], ",", "\[IndentingNewLine]", 
     "\[IndentingNewLine]", 
     RowBox[{"\"\<O\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"mxv", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"mxstarf", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", 
        " ", 
        RowBox[{"{", 
         RowBox[{"posX", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"mxX", ",", " ", "_Real", ",", " ", "2"}], "}"}]}], "}"}]}], 
     ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"\"\<C\>\"", " ", "\[RuleDelayed]", " ", 
      RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", "|>"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"b0034c89-3b4a-4125-9258-1b2f348bb876"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"MbJQtys", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"ag", " ", "=", " ", "agfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"s", " ", "=", " ", "sfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"sdot", " ", "=", " ", "sdotfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"XL", " ", "=", " ", "XLfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{
      "\[DoubleStruckCapitalI]", " ", "=", " ", 
       "\[DoubleStruckCapitalI]fun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"u", " ", "=", " ", "ufun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"fext0", " ", "=", " ", "fext0fun"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"r", " ", "=", " ", "rfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"rdot", " ", "=", " ", "rdotfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Tcb", " ", "=", " ", "Tcbfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"J", " ", "=", " ", "Jfun"}], ";", "\[IndentingNewLine]", 
      RowBox[{"\[Phi]", " ", "=", " ", "\[Phi]fun"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"\[Eta]", " ", "=", " ", "\[Eta]fun"}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"K", " ", "=", " ", "Kfun"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"nq", " ", "=", " ", 
       RowBox[{"Length", "[", "u", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nx", " ", "=", " ", 
       RowBox[{"2", "nq"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"nf", " ", "=", " ", 
       RowBox[{"Length", "@", "pcons"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nv", " ", "=", " ", 
       RowBox[{"Length", "@", "vcons"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nu", " ", "=", " ", 
       RowBox[{"Length", "@", "ucons"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"q", " ", "=", " ", 
       RowBox[{"\[DoubleStruckX]", "\[LeftDoubleBracket]", 
        RowBox[{"1", ";;", "nq"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"qd", " ", "=", " ", 
       RowBox[{"\[DoubleStruckX]", "\[LeftDoubleBracket]", 
        RowBox[{
         RowBox[{"nq", "+", "1"}], ";;", "nx"}], "\[RightDoubleBracket]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"qdd", " ", "=", " ", "zq"}], ";"}]}], "\[IndentingNewLine]", 
    "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"37c0a7a2-1e89-4a59-8302-20023054e4fe"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"EOM", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "nqfv", ",", " ", "nqfu", ",", " ", "nqfub", ",", " ", "pu", ",", " ", 
        "pv", ",", " ", "fosim", ",", " ", "xdot"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "set", " ", "up", " ", "lengths", " ", "of", " ", "the", " ", 
        "different", " ", "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nqfv", " ", "=", " ", 
        RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nv"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"nqfu", " ", "=", " ", 
        RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nu"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"nqfub", " ", "=", " ", 
        RowBox[{"nqfu", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"solves", " ", "for", " ", "qdd"}], ",", " ", "f", ",", " ", 
         "u"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Ab", " ", "=", " ", "ZAb"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"formulate", " ", 
           RowBox[{"M", ".", "qdd"}]}], " ", "+", " ", "uJ"}], " ", "=", " ", 
         RowBox[{
          RowBox[{"B", ".", "u"}], " ", "+", " ", "\[Tau]", " ", "+", " ", 
          RowBox[{
           RowBox[{"J", "\[Transpose]"}], ".", "f"}]}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Ab", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "nq"}], ",", " ", 
          RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], " ", "=", 
        " ", "M"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Ab", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "nq"}], ",", " ", "nqfub"}], 
         "\[RightDoubleBracket]"}], " ", "=", " ", 
        RowBox[{"u", "-", "uJ"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"nf", " ", ">", "0"}], " ", "||", " ", 
          RowBox[{"nv", " ", ">", " ", "0"}]}], ",", " ", 
         "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"pu", " ", "=", " ", 
           RowBox[{"Join", "[", 
            RowBox[{"pcons", ",", " ", "ucons"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"pv", " ", "=", " ", 
           RowBox[{"Join", "[", 
            RowBox[{"pcons", ",", " ", "vcons"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{"1", ";;", "nq"}], ",", " ", 
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfu"}]}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", 
           RowBox[{"-", 
            RowBox[{
             RowBox[{
             "J", "\[LeftDoubleBracket]", "pu", "\[RightDoubleBracket]"}], 
             "\[Transpose]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", 
             RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], " ", "=",
            " ", 
           RowBox[{
           "J", "\[LeftDoubleBracket]", "pv", "\[RightDoubleBracket]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", "nqfub"}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", 
           RowBox[{"-", 
            RowBox[{
            "\[Phi]", "\[LeftDoubleBracket]", "pv", 
             "\[RightDoubleBracket]"}]}]}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"UpperTriangularizeAb", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "Jpv", ",", " ", "JBb", ",", " ", "MJBb", ",", " ", "JMJBb", ",", " ", 
        "\[CapitalLambda]p", ",", " ", "\[CapitalLambda]v", ",", " ", "nub", 
        ",", " ", "nfv", ",", " ", "nfub", ",", " ", "nqf", ",", " ", "nqfv", 
        ",", " ", "nqfu", ",", " ", "nqfub", ",", " ", "xdot", ",", " ", 
        "fosim"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"If", "[", 
        RowBox[{"(*", 
         RowBox[{
          RowBox[{"nf", " ", ">", " ", "0"}], " ", "&&", " ", 
          RowBox[{"nv", " ", ">", " ", "0"}]}], "*)"}], 
        RowBox[{
         RowBox[{
          RowBox[{"nf", " ", ">", " ", "0"}], " ", "||", " ", 
          RowBox[{"nv", " ", ">", " ", "0"}]}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"nub", " ", "=", " ", 
           RowBox[{"nu", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"nfv", " ", "=", " ", 
           RowBox[{"nf", " ", "+", " ", "nv"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"nfub", " ", "=", " ", 
           RowBox[{"nf", " ", "+", " ", "nu", " ", "+", " ", "1"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"nqf", " ", "=", " ", 
           RowBox[{"nq", " ", "+", " ", "nf"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"nqfv", " ", "=", " ", 
           RowBox[{"nq", " ", "+", " ", "nfv"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"nqfu", " ", "=", " ", 
           RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nu"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"nqfub", " ", "=", " ", 
           RowBox[{"nqfu", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]",
           "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
           "extract", " ", "and", " ", "zero", " ", "Jp", " ", "and", " ", 
            "Jv"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"Jpv", " ", "=", " ", 
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", 
             RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", 
             RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], " ", "=",
            " ", 
           RowBox[{"ZAb", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", 
             RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{
            RowBox[{"solve", " ", "for", " ", "operational"}], "-", 
            RowBox[{"space", " ", "inertia", " ", "matrices", " ", 
             RowBox[{"J", ".", 
              RowBox[{"Inverse", "[", "M", "]"}], ".", 
              RowBox[{"[", 
               RowBox[{
                RowBox[{"J", "\[Transpose]"}], "|", "B", "|", "b"}], 
               "]"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"JBb", " ", "=", " ", 
           RowBox[{"-", 
            RowBox[{"Ab", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{"1", ";;", "nq"}], ",", " ", 
              RowBox[{
               RowBox[{"nq", "+", "1"}], ";;", "nqfub"}]}], 
             "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"MJBb", " ", "=", " ", 
           RowBox[{"LinearSolve", "[", 
            RowBox[{"M", ",", " ", "JBb"}], "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"JMJBb", " ", "=", " ", 
           RowBox[{"Jpv", ".", "MJBb"}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{"1", ";;", "nfv"}], ",", " ", "nfub"}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", 
           RowBox[{
            RowBox[{"Ab", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{
               RowBox[{"nq", "+", "1"}], ";;", "nqfv"}], ",", " ", "nqfub"}], 
             "\[RightDoubleBracket]"}], " ", "+", " ", 
            RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
             RowBox[{
              RowBox[{"1", ";;", "nfv"}], ",", " ", "nfub"}], 
             "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"fills", " ", "in", " ", "physical", " ", "equations"}], 
           " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqf"}], ",", " ", 
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqfub"}]}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", 
           RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{"1", ";;", "nf"}], ",", " ", 
             RowBox[{"1", ";;", "nfub"}]}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"nf", " ", ">", " ", "0"}], " ", "&&", " ", 
             RowBox[{"nv", " ", ">", " ", "0"}]}], ",", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
             "fills", " ", "in", " ", "virtual", " ", "constraint", " ", 
              "equations"}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"\[CapitalLambda]p", " ", "=", " ", 
              RowBox[{"LinearSolve", "[", 
               RowBox[{
                RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{"1", ";;", "nf"}], ",", " ", 
                  RowBox[{"1", ";;", "nf"}]}], "\[RightDoubleBracket]"}], ",",
                 " ", 
                RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{"1", ";;", "nf"}], ",", " ", 
                  RowBox[{
                   RowBox[{"nf", "+", "1"}], ";;", "nfub"}]}], 
                 "\[RightDoubleBracket]"}]}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"\[CapitalLambda]v", " ", "=", " ", 
              RowBox[{
               RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
                RowBox[{
                 RowBox[{
                  RowBox[{"nf", "+", "1"}], ";;", "nfv"}], ",", " ", 
                 RowBox[{
                  RowBox[{"nf", "+", "1"}], ";;", "nfub"}]}], 
                "\[RightDoubleBracket]"}], " ", "-", " ", 
               RowBox[{
                RowBox[{"JMJBb", "\[LeftDoubleBracket]", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"nf", "+", "1"}], ";;", "nfv"}], ",", " ", 
                  RowBox[{"1", ";;", "nf"}]}], "\[RightDoubleBracket]"}], ".",
                 "\[CapitalLambda]p"}]}]}], ";", "\[IndentingNewLine]", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Ab", "\[LeftDoubleBracket]", 
               RowBox[{
                RowBox[{
                 RowBox[{"nqf", "+", "1"}], ";;", "nqfv"}], ",", " ", 
                RowBox[{
                 RowBox[{"nqf", "+", "1"}], ";;", "nqfub"}]}], 
               "\[RightDoubleBracket]"}], " ", "=", " ", 
              RowBox[{"\[CapitalLambda]v", "\[LeftDoubleBracket]", 
               RowBox[{
                RowBox[{"1", ";;", "nv"}], ",", " ", 
                RowBox[{"1", ";;", "nub"}]}], "\[RightDoubleBracket]"}]}], 
             ";"}]}], "\[IndentingNewLine]", "]"}], ";"}]}], 
        "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}],
    ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"F", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "nqfv", ",", " ", "nqfu", ",", " ", "nqfub", ",", " ", "fosim", ",", 
       " ", "xdot"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nqfv", " ", "=", " ", 
       RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nv"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"nqfu", " ", "=", " ", 
       RowBox[{"nq", " ", "+", " ", "nf", " ", "+", " ", "nu"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"nqfub", " ", "=", " ", 
       RowBox[{"nqfu", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"fosim", " ", "=", " ", 
       RowBox[{"LinearSolve", "[", 
        RowBox[{
         RowBox[{"Ab", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"1", ";;", "nqfv"}], ",", " ", 
           RowBox[{"1", ";;", "nqfu"}]}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"Ab", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"1", ";;", "nqfv"}], ",", " ", "nqfub"}], 
          "\[RightDoubleBracket]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"qdd", " ", "=", " ", 
       RowBox[{"fosim", "\[LeftDoubleBracket]", 
        RowBox[{"1", ";;", "nq"}], "\[RightDoubleBracket]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"xdot", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{"qd", ",", " ", "qdd"}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"Flatten", "[", 
       RowBox[{"{", "xdot", "}"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"bbf7a297-3cb4-418c-95bf-035bb62a778b"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Impact equations for constrained mechanical systems", \
"Section",ExpressionUUID->"65496614-618e-4d77-9624-38a7aa71d685"],

Cell[BoxData[
 RowBox[{
  RowBox[{"HMbJ", " ", "=", " ", 
   RowBox[{"Join", "[", 
    RowBox[{"FMbJ", ",", " ", 
     RowBox[{"<|", 
      RowBox[{
       RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "\"\<h\>\""}], ",", " ", 
       RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
        RowBox[{"{", 
         RowBox[{
         "MbJQtys", ",", " ", "V", ",", " ", "CRB", ",", " ", "X0", ",", " ", 
          "rs0", ",", " ", "JOSIM", ",", " ", "IME"}], "}"}]}]}], "|>"}]}], 
    "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"3e2c055b-4882-4770-96da-57b848e06291"],

Cell["\<\
TODO:  Potential BUG
Be careful here, if nu isn\[CloseCurlyQuote]t 0 then ZAb is too large.\
\>", "Text",ExpressionUUID->"95491243-4b39-48be-9424-069fbba8ec9d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"IME", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"nqf", ",", " ", "nqfb", ",", " ", "fosim", ",", " ", "xdot"}],
        "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "set", " ", "up", " ", "lengths", " ", "of", " ", "the", " ", 
        "different", " ", "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nqf", " ", "=", " ", 
        RowBox[{"nq", " ", "+", " ", "nf"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"nqfb", " ", "=", " ", 
        RowBox[{"nqf", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{"solves", " ", "for", " ", "qdd"}], ",", " ", "f", ",", " ", 
         "u"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{"Ab", " ", "=", " ", "ZAb"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"formulate", " ", 
           RowBox[{"M", ".", "qdd"}]}], " ", "+", " ", "uJ"}], " ", "=", " ", 
         RowBox[{
          RowBox[{"B", ".", "uff"}], " ", "+", " ", "u", " ", "+", " ", 
          RowBox[{
           RowBox[{"J", "\[Transpose]"}], ".", "f"}]}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Ab", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "nq"}], ",", " ", 
          RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], " ", "=", 
        " ", "M"}], ";", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Ab", "\[LeftDoubleBracket]", 
         RowBox[{
          RowBox[{"1", ";;", "nq"}], ",", " ", "nqfb"}], 
         "\[RightDoubleBracket]"}], " ", "=", " ", 
        RowBox[{"M", ".", "qd"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"nf", " ", ">", "0"}], ",", " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{"1", ";;", "nq"}], ",", " ", 
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqf"}]}], 
            "\[RightDoubleBracket]"}], " ", "=", " ", 
           RowBox[{"-", 
            RowBox[{
             RowBox[{
             "J", "\[LeftDoubleBracket]", "pcons", "\[RightDoubleBracket]"}], 
             "\[Transpose]"}]}]}], ";", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"Ab", "\[LeftDoubleBracket]", 
            RowBox[{
             RowBox[{
              RowBox[{"nq", "+", "1"}], ";;", "nqf"}], ",", " ", 
             RowBox[{"1", ";;", "nq"}]}], "\[RightDoubleBracket]"}], " ", "=",
            " ", 
           RowBox[{
           "J", "\[LeftDoubleBracket]", "pcons", "\[RightDoubleBracket]"}]}], 
          ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{
             RowBox[{"nv", " ", ">", " ", "0"}], " ", "&&", " ", 
             RowBox[{"nv", " ", "\[Equal]", " ", "nf"}]}], ",", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"for", " ", "implementing", " ", "non"}], "-", 
               RowBox[{"plastic", " ", "collisions"}]}], ",", " ", 
              RowBox[{"could", " ", "also", " ", "add", " ", 
               RowBox[{
               "\[Phi]", "\[LeftDoubleBracket]", "vcons", 
                "\[RightDoubleBracket]"}]}]}], " ", "*)"}], 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"Ab", "\[LeftDoubleBracket]", 
               RowBox[{
                RowBox[{
                 RowBox[{"nq", "+", "1"}], ";;", "nqf"}], ",", " ", "nqfb"}], 
               "\[RightDoubleBracket]"}], " ", "=", " ", 
              RowBox[{"-", 
               RowBox[{
                RowBox[{
                "J", "\[LeftDoubleBracket]", "vcons", 
                 "\[RightDoubleBracket]"}], ".", "qd"}]}]}], ";"}]}], 
           "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
        "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"H", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"nqf", ",", " ", "nqfb", ",", " ", "fosim", ",", " ", "xpost"}],
       "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "set", " ", "up", " ", "lengths", " ", "of", " ", "the", " ", 
       "different", " ", "constraints"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"nqf", " ", "=", " ", 
       RowBox[{"nq", " ", "+", " ", "nf"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nqfb", " ", "=", " ", 
       RowBox[{"nqf", " ", "+", " ", "1"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"fosim", " ", "=", " ", 
       RowBox[{"LinearSolve", "[", 
        RowBox[{
         RowBox[{"Ab", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"1", ";;", "nqf"}], ",", " ", 
           RowBox[{"1", ";;", "nqf"}]}], "\[RightDoubleBracket]"}], ",", " ", 
         RowBox[{"Ab", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"1", ";;", "nqf"}], ",", " ", "nqfb"}], 
          "\[RightDoubleBracket]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"xpost", " ", "=", " ", 
       RowBox[{"Join", "[", 
        RowBox[{"q", ",", " ", 
         RowBox[{"fosim", "\[LeftDoubleBracket]", 
          RowBox[{"1", ";;", "nq"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"Flatten", "[", 
       RowBox[{"{", "xpost", "}"}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}],
   ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e4be5585-fa18-41fa-881b-d3fc09f99f83"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Virtual and Physical Constraints", \
"Section",ExpressionUUID->"71ae3798-fde0-4f91-9df9-6fa81c7e9add"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"\[Eta]MbJ", " ", "=", " ", 
    RowBox[{"<|", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"\"\<name\>\"", " ", "\[Rule]", " ", "\"\<\[Eta]\>\""}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<f\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", 
        RowBox[{
        "MbJQtys", ",", " ", "V", ",", " ", "X0", ",", " ", "rs0", ",", " ", 
         "JOSIM"}], "}"}]}], ",", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"\"\<lcls\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", 
        RowBox[{
        "q", ",", " ", "qd", ",", " ", "qdd", ",", " ", "u", ",", " ", "uJ", 
         ",", " ", "ag", ",", " ", "fext0", ",", " ", "\[Phi]", ",", " ", "s",
          ",", " ", "sdot", ",", " ", "v", ",", " ", "a", ",", " ", "f", ",", 
         " ", "fext", ",", " ", "r", ",", " ", "rdot", ",", " ", "sj", ",", 
         " ", "ro", ",", " ", "sjdot", ",", " ", "rodot", ",", " ", "posXco", 
         ",", " ", "M", ",", " ", "\[DoubleStruckCapitalI]", ",", " ", "XL", 
         ",", " ", "Tcb", ",", " ", "XL0", ",", " ", "X0L", ",", " ", "RL0", 
         ",", " ", "R0L", ",", " ", "sj", ",", " ", "sjdot", ",", " ", "ro", 
         ",", " ", "rodot", ",", " ", "Xo0", ",", " ", "J", ",", " ", 
         "\[Phi]", ",", " ", "\[Eta]", ",", " ", "K", ",", " ", "Ab", ",", 
         " ", "b", ",", " ", "o", ",", " ", "nq", ",", " ", "nx", ",", " ", 
         "nf", ",", " ", "nv", ",", " ", "nu"}], "}"}]}], ",", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<v\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"\[DoubleStruckX]", ",", " ", "_Real", ",", " ", "1"}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"\[DoubleStruckC]", ",", " ", "_Real", ",", " ", "1"}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"ufun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"agfun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"\[Phi]fun", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",",
          " ", 
         RowBox[{"{", 
          RowBox[{"sfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"sdotfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"fext0fun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"rfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"rdotfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"Jfun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"\[Eta]fun", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",",
          " ", 
         RowBox[{"{", 
          RowBox[{"Kfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{
          "\[DoubleStruckCapitalI]fun", ",", " ", "_Real", ",", " ", "3"}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"XLfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"Tcbfun", ",", " ", "_Real", ",", " ", "3"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"z3", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"z6", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"zq", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"zpos", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"zspat", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"Z3", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"ZM", ",", " ", "_Real", ",", " ", "2"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"ZAb", ",", " ", "_Real", ",", " ", "2"}], "}"}]}], "}"}]}],
       ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<d\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"parent", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",",
          " ", 
         RowBox[{"{", 
          RowBox[{"bx", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"bs", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"bo", ",", " ", "_Integer", ",", " ", "2"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"ba", ",", " ", "_Integer", ",", " ", "3"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"pcons", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"vcons", ",", " ", "_Integer", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"ucons", ",", " ", "_Integer", ",", " ", "1"}], "}"}]}], 
        "}"}]}], ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<I\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"mxv", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
             " ", 
             RowBox[{"{", 
              RowBox[{"v", ",", " ", "_Real", ",", " ", "nm"}], "}"}]}], 
            "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"mxstarf", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
             " ", 
             RowBox[{"{", 
              RowBox[{"v", ",", " ", "_Real", ",", " ", "nm"}], "}"}]}], 
            "}"}]}], "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"posX", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"X", ",", " ", "_Real", ",", " ", 
               RowBox[{"{", 
                RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}], ",", " ", 
             RowBox[{"{", 
              RowBox[{"Y", ",", " ", "_Real", ",", " ", 
               RowBox[{"{", 
                RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}]}], "}"}]}], 
          "}"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"mxX", ",", " ", 
           RowBox[{"{", 
            RowBox[{
             RowBox[{"{", 
              RowBox[{"m", ",", " ", "_Real", ",", " ", "nm"}], "}"}], ",", 
             " ", 
             RowBox[{"{", 
              RowBox[{"X", ",", " ", "_Real", ",", " ", 
               RowBox[{"{", 
                RowBox[{"nm", ",", " ", "nm"}], "}"}]}], "}"}]}], "}"}]}], 
          "}"}]}], "\[IndentingNewLine]", "}"}]}], ",", "\[IndentingNewLine]",
       "\[IndentingNewLine]", 
      RowBox[{"\"\<O\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{"mxv", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"mxstarf", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", 
         " ", 
         RowBox[{"{", 
          RowBox[{"posX", ",", " ", "_Real", ",", " ", "1"}], "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"mxX", ",", " ", "_Real", ",", " ", "2"}], "}"}]}], "}"}]}],
       ",", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"\"\<C\>\"", " ", "\[RuleDelayed]", " ", 
       RowBox[{"{", "}"}]}]}], "\[IndentingNewLine]", "|>"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"Eta", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"Flatten", "[", 
      RowBox[{"{", "\[Eta]", "}"}], "]"}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"94250285-4e2a-4ad4-811f-ff37dc4b6cd5"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"bd416742-0fca-4abf-9e40-9469cd9c9781"],

Cell[BoxData[{
 RowBox[{
  RowBox[{"End", "[", "]"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"7428c663-54a3-4c9a-9c81-d2aa40d23b12"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{958, 980},
WindowMargins->{{Automatic, -7}, {Automatic, 0}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"12.3 for Microsoft Windows (64-bit) (July 9, 2021)",
StyleDefinitions->"Default.nb",
ExpressionUUID->"c2acf875-9d45-4d84-b152-b2fe3022ed23"
]

