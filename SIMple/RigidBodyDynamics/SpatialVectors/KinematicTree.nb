Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"RigidBodySystem", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{"High", "-", 
      RowBox[{
      "level", " ", "functions", " ", "used", " ", "to", " ", "define", " ", 
       "a", " ", "rigid", " ", 
       RowBox[{"body", ".", "\n", "Copyright"}], " ", 
       RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
       
       RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", 
       " ", "free", " ", "software"}]}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->
  True,ExpressionUUID->"c9ace131-5d4c-4ace-bb35-b13857154674"],

Cell[CellGroupData[{

Cell["TODO", "Section",ExpressionUUID->"f486e300-efa0-4a17-aba6-c663751b4bc4"],

Cell["\<\
multi-dof joints only return last index, should fix.
ex:  for Test - AngularMomentum.nb in \
BipedalLocomotion/.../Models/KneedWalker folder
RBDGetPositionIndex[{\[OpenCurlyDoubleQuote]hip\[CloseCurlyDoubleQuote], \
\[OpenCurlyDoubleQuote]left shank\[CloseCurlyDoubleQuote], \
\[OpenCurlyDoubleQuote]right shank\[CloseCurlyDoubleQuote]}]
returns {2, 5, 6} but in this case hip is 1 and 2.  should have option to \
return {1, 2, 5, 6}\
\>", "Text",ExpressionUUID->"8eee5e81-1527-4fa2-a501-5083044af063"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"d826a602-14aa-4b57-a86e-f8f86a87ab7e"],

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{
  "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"ni", ";"}], "  ", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "list", " ", "of", " ", "dof", " ", "of", " ", "each", " ", "joint"}], 
    ";", " ", 
    RowBox[{"nq", " ", "=", " ", 
     RowBox[{"sum", 
      RowBox[{"(", "ni", ")"}]}]}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nb", ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"#", " ", "of", " ", "rigid", " ", "bodies"}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"rigid", "-", 
    RowBox[{"body", " ", "connectivity"}]}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"parent", ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"parent", " ", "array"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"map", ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{
   "map", " ", "from", " ", "original", " ", "to", " ", "extended", " ", 
    "body"}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"nca", ";"}], " ", 
  RowBox[{"(*", " ", 
   RowBox[{"nearest", " ", "common", " ", "ancestor", " ", "map"}], " ", 
   "*)"}]}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"865d59d8-94fc-4640-a7dd-e8b8d4794941"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Kinematic Tree", \
"Section",ExpressionUUID->"1c79a023-5933-4467-a67f-99c9f6093877"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"GetTree", "[", "]"}], ":=", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", "t", ",", "tind"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{"get", " ", "parent"}], "-", 
        RowBox[{"child", " ", "relationships"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"KeySelect", "[", 
         RowBox[{"rb", ",", " ", 
          RowBox[{
           RowBox[{
            RowBox[{"StringQ", "[", "#", "]"}], " ", "&&", " ", 
            RowBox[{"AssociationQ", "@", 
             RowBox[{"rb", "[", "#", "]"}]}]}], "&"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"Length", "@", "p"}], " ", "\[Equal]", " ", "0"}], ",", " ",
          "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"KeyDropFrom", "[", 
           RowBox[{"rb", ",", " ", 
            RowBox[{"{", 
             RowBox[{"ParentList", ",", " ", "TreeForm", ",", " ", "Links"}], 
             "}"}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"Return", "[", 
           RowBox[{"<|", "|>"}], "]"}]}]}], "\[IndentingNewLine]", "]"}], ";",
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"KeyValueMap", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"#2", "[", "\"\<p\>\"", "]"}], "\[Rule]", "#1"}], "&"}], 
          ",", "p"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"Merge", "[", 
         RowBox[{"p", ",", "Identity"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"get", " ", "tree", " ", "structure", " ", 
         RowBox[{"w", "/", " ", "names"}]}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{
         RowBox[{"Flatten", "@", 
          RowBox[{"Lookup", "[", 
           RowBox[{"p", ",", "#", ",", 
            RowBox[{"{", "}"}]}], "]"}]}], "&"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"NestList", "[", 
         RowBox[{"t", ",", 
          RowBox[{"p", "[", "Root", "]"}], ",", 
          RowBox[{
           RowBox[{"Length", "@", "p"}], "-", "1"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"Flatten", "@", "t"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"get", " ", "tree", " ", "structure", " ", 
         RowBox[{"w", "/", " ", "#s"}]}], " ", "*)"}], 
       RowBox[{"tind", " ", "=", " ", 
        RowBox[{"AssociationThread", "[", 
         RowBox[{
          RowBox[{"Join", "[", 
           RowBox[{
            RowBox[{"{", "Root", "}"}], ",", "t"}], "]"}], "\[Rule]", 
          RowBox[{"Range", "[", 
           RowBox[{"0", ",", 
            RowBox[{"Length", "@", "t"}]}], "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{
         RowBox[{
          RowBox[{"tind", "[", 
           RowBox[{"rb", "\[LeftDoubleBracket]", 
            RowBox[{"#", ",", "\"\<p\>\""}], "\[RightDoubleBracket]"}], "]"}],
           "&"}], " ", "/@", " ", "t"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"p", " ", "=", " ", 
        RowBox[{"AssociationThread", "[", 
         RowBox[{"t", "\[Rule]", "p"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"t", " ", "=", " ", 
        RowBox[{"KeyDrop", "[", 
         RowBox[{"tind", ",", "Root"}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"AssociateTo", "[", 
         RowBox[{"rb", ",", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{"ParentList", "\[Rule]", "p"}], ",", 
            RowBox[{"TreeForm", "\[Rule]", "t"}]}], "}"}]}], "]"}], "[", 
        "TreeForm", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetExpandedTree", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"f", ",", " ", "p", ",", " ", "j"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"j", " ", "=", " ", 
       RowBox[{"RBDGetLinkInfo", "[", 
        RowBox[{"\"\<joint\>\"", ",", " ", "True"}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "@", "j"}], " ", "\[Equal]", " ", "0"}], ",", " ", 
        
        RowBox[{"Return", "@", "j"}]}], "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"j", " ", "=", " ", 
       RowBox[{
        RowBox[{
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{"StringQ", "[", 
            RowBox[{"joint", "\[LeftDoubleBracket]", 
             RowBox[{"#1", ",", "1"}], "\[RightDoubleBracket]"}], "]"}], ",", 
           " ", 
           RowBox[{
           "joint", "\[LeftDoubleBracket]", "#1", "\[RightDoubleBracket]"}], 
           ",", " ", 
           RowBox[{"{", "#1", "}"}]}], "]"}], "&"}], " ", "/@", " ", "j"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"p", " ", "=", " ", 
       RowBox[{"Values", "@", 
        RowBox[{"rb", "[", "ParentList", "]"}]}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"nb", " ", "=", " ", 
       RowBox[{"Length", "@", "j"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"ni", " ", "=", " ", 
       RowBox[{"Length", " ", "/@", " ", "j"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{"nq", " ", "=", " ", 
       RowBox[{"Total", "[", "ni", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nx", " ", "=", " ", 
       RowBox[{"2", "nq"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"nc", " ", "=", " ", 
       RowBox[{"Lookup", "[", 
        RowBox[{"rb", ",", " ", "\"\<nc\>\"", ",", " ", "0"}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"allocate", " ", "mem"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"parent", " ", "=", " ", 
       RowBox[{
        RowBox[{"Range", "[", "nq", "]"}], " ", "-", " ", "1"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"map", " ", "=", " ", 
       RowBox[{"ConstantArray", "[", 
        RowBox[{"0", ",", " ", "nb"}], "]"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"zq", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", " ", "nq"}], "]"}]}], ";", " ", 
      RowBox[{"(*", " ", "RNEA", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"zspat", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", " ", "nq", ",", " ", "nm"}], "]"}]}], ";", " ", 
      RowBox[{"(*", " ", "RNEA", " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"ZM", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{"0", ",", " ", "nq", ",", " ", "nq"}], "]"}]}], ";", " ", 
      RowBox[{"(*", " ", "CRB", " ", "*)"}], "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "create", " ", "mapping", " ", "from", " ", "original", " ", "to", " ",
         "extended", " ", "tree"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"map", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], 
       " ", "=", " ", 
       RowBox[{"ni", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}],
       ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{
         "map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
         "=", " ", 
         RowBox[{
          RowBox[{"map", "\[LeftDoubleBracket]", 
           RowBox[{"i", "-", "1"}], "\[RightDoubleBracket]"}], "+", 
          RowBox[{
          "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
        ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "2", ",", " ", "nb"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
       "create", " ", "extended", " ", "tree", " ", "and", " ", "body", " ", 
        "arrays"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
       "parent", "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}], " ", 
       "=", " ", "0"}], ";", "\[IndentingNewLine]", 
      RowBox[{"Do", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"parent", "\[LeftDoubleBracket]", 
          RowBox[{
           RowBox[{"map", "\[LeftDoubleBracket]", 
            RowBox[{"i", "-", "1"}], "\[RightDoubleBracket]"}], "+", "1"}], 
          "\[RightDoubleBracket]"}], " ", "=", " ", 
         RowBox[{"If", "[", 
          RowBox[{
           RowBox[{
            RowBox[{
            "p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
            "\[NotEqual]", " ", "0"}], ",", " ", 
           RowBox[{"map", "\[LeftDoubleBracket]", 
            RowBox[{
            "p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "\[RightDoubleBracket]"}], ",", " ", "0"}], "]"}]}], ",", " ", 
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "2", ",", " ", "nb"}], "}"}]}], "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"update", " ", "nca"}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"MakeNearestCommonAncestor", "[", 
       RowBox[{"parent", ",", " ", "nq"}], "]"}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"get", " ", "tree", " ", "structure", " ", 
        RowBox[{"w", "/", " ", "joints"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"j", " ", "=", " ", 
       RowBox[{"Flatten", "@", 
        RowBox[{"Table", "[", 
         RowBox[{
          RowBox[{"i", " ", "<>", " ", "\"\<-\>\"", " ", "<>", " ", "k"}], 
          ",", " ", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", 
            RowBox[{"Keys", "@", "j"}]}], "}"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"k", ",", " ", 
            RowBox[{"j", "[", "i", "]"}]}], "}"}]}], "]"}]}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"j", " ", "=", " ", 
       RowBox[{"AssociationThread", "[", 
        RowBox[{"j", " ", "\[Rule]", " ", 
         RowBox[{"Range", "@", "nq"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
      
      RowBox[{
       RowBox[{"AssociateTo", "[", 
        RowBox[{"rb", ",", 
         RowBox[{"Links", "\[Rule]", 
          RowBox[{"<|", " ", 
           RowBox[{
            RowBox[{"ParentList", "\[Rule]", "parent"}], ",", 
            RowBox[{"TreeForm", "\[Rule]", "j"}]}], " ", "|>"}]}]}], "]"}], 
       "[", "Links", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"e75fc780-62af-484d-9104-e8a26a29ddd1"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"MakeNearestCommonAncestor", "[", 
     RowBox[{"parent_", ",", " ", "n_"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "p", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"nearest", " ", "common", " ", "ancestor", " ", 
        RowBox[{"(", "nca", ")"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"nca", " ", "=", " ", 
        RowBox[{"ConstantArray", "[", 
         RowBox[{"0", ",", " ", 
          RowBox[{"{", 
           RowBox[{"n", ",", " ", "n"}], "}"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{
           RowBox[{"nca", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", " ", "i"}], "\[RightDoubleBracket]"}], " ", "=",
            " ", "i"}], ";", "\[IndentingNewLine]", 
          RowBox[{"(*", " ", 
           RowBox[{"your", " ", 
            RowBox[{"parent", "'"}], "s", " ", "ncas", " ", "are", " ", 
            "your", " ", "ncas"}], " ", "*)"}], "\[IndentingNewLine]", 
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", "\[NotEqual]", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{"(*", " ", 
             RowBox[{
              RowBox[{
               RowBox[{"parent", "'"}], "s", " ", "ancestors"}], " ", "+", 
              " ", "siblings"}], " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", " ", 
                RowBox[{"1", ";;", "p"}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"p", ",", " ", 
                RowBox[{"1", ";;", "p"}]}], "\[RightDoubleBracket]"}]}], ";", 
             "\[IndentingNewLine]", "\[IndentingNewLine]", 
             RowBox[{"(*", " ", 
              RowBox[{
               RowBox[{
                RowBox[{"parent", "'"}], "s", " ", "siblings"}], " ", "+", 
               " ", "kids"}], " ", "*)"}], "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", " ", 
                RowBox[{
                 RowBox[{"p", "+", "1"}], ";;", 
                 RowBox[{"i", "-", "1"}]}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{"nca", "\[LeftDoubleBracket]", 
               RowBox[{
                RowBox[{
                 RowBox[{"p", "+", "1"}], ";;", 
                 RowBox[{"i", "-", "1"}]}], ",", " ", "p"}], 
               "\[RightDoubleBracket]"}]}], ";"}]}], "\[IndentingNewLine]", 
           "]"}], ";"}], "\[IndentingNewLine]", ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "n"}], "}"}]}], "\[IndentingNewLine]", "]"}],
        ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"nca", " ", "=", " ", 
        RowBox[{"nca", " ", "+", " ", 
         RowBox[{
          RowBox[{"LowerTriangularize", "[", 
           RowBox[{"nca", ",", " ", 
            RowBox[{"-", "1"}]}], "]"}], "\[Transpose]"}]}]}], ";"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"SetAttributes", "[", 
   RowBox[{"GetPath", ",", " ", "Listable"}], "]"}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"GetPath", "[", 
    RowBox[{"i_", ",", " ", 
     RowBox[{"j_:", "0"}]}], "]"}], " ", ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"a", ",", " ", "i2a", ",", " ", "j2a"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
      "returns", " ", "the", " ", "path", " ", "from", " ", "i", " ", "to", 
       " ", "j"}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{
       "this", " ", "can", " ", "also", " ", "be", " ", "used", " ", "to", 
        " ", "return", " ", "the", " ", "children", " ", "on", " ", "a", " ", 
        "path", " ", "if", " ", "a"}], " ", "\[Element]", " ", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{"i", ",", " ", "j"}], "}"}], "."}]}], " ", "*)"}], 
     "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"a", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"i", " ", "\[Equal]", " ", "0"}], " ", "||", " ", 
          RowBox[{"j", " ", "\[Equal]", " ", "0"}]}], ",", " ", "0", ",", " ", 
         RowBox[{"nca", "\[LeftDoubleBracket]", 
          RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}]}], "]"}]}], 
      ";", "\[IndentingNewLine]", 
      RowBox[{"i2a", " ", "=", " ", 
       RowBox[{"NestWhileList", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "parent", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
          "&"}], ",", " ", "i", ",", " ", 
         RowBox[{
          RowBox[{"#", "\[NotEqual]", " ", "a"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"j2a", " ", "=", " ", 
       RowBox[{"NestWhileList", "[", 
        RowBox[{
         RowBox[{
          RowBox[{
          "parent", "\[LeftDoubleBracket]", "#", "\[RightDoubleBracket]"}], 
          "&"}], ",", " ", "j", ",", " ", 
         RowBox[{
          RowBox[{"#", "\[NotEqual]", " ", "a"}], "&"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Join", "[", 
       RowBox[{"i2a", ",", " ", 
        RowBox[{"Rest", "@", 
         RowBox[{"Reverse", "@", "j2a"}]}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"d29474ed-b4db-46b2-8298-e98825be38a6"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Visualize Tree", \
"Section",ExpressionUUID->"ac3409df-bc11-4c24-a0f3-1a5ebbff91ce"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"RBDTree", "[", 
    RowBox[{
     RowBox[{"expanded_:", "True"}], ",", " ", 
     RowBox[{"opts", ":", 
      RowBox[{"OptionsPattern", "[", "TreePlot", "]"}]}]}], "]"}], " ", ":=", 
   " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{"n", ",", " ", "p"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"If", "[", 
       RowBox[{"expanded", ",", " ", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"extended", " ", "tree"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"GetExpandedTree", "[", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"p", " ", "=", " ", 
          RowBox[{"n", "[", "ParentList", "]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"Keys", "@", 
           RowBox[{"n", "[", "TreeForm", "]"}]}]}], ";"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"original", " ", "tree"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"p", " ", "=", " ", 
          RowBox[{"rb", "[", "ParentList", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"RBDGetLinkInfo", "[", "\"\<joint\>\"", "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"KeyValueMap", "[", 
           RowBox[{
            RowBox[{
             RowBox[{
             "#1", " ", "<>", " ", "\"\<-\>\"", " ", "<>", " ", "#2"}], "&"}],
             ",", "n"}], "]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"n", " ", "=", " ", 
       RowBox[{"Table", "[", 
        RowBox[{
         RowBox[{"{", 
          RowBox[{
           RowBox[{
            RowBox[{
            "p", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "\[Rule]", " ", "i"}], ",", " ", 
           RowBox[{
           "n", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
          "}"}], ",", " ", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", 
           RowBox[{"Length", "@", "n"}]}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"TreePlot", "[", 
       RowBox[{
       "n", ",", " ", "Automatic", ",", " ", "0", ",", " ", "opts", ",", " ", 
        
        RowBox[{"VertexLabeling", "\[Rule]", "True"}]}], "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->
  True,ExpressionUUID->"21555fdb-4581-46f5-932d-7adee438c986"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Expanded Tree Index of States and Parameters", \
"Section",ExpressionUUID->"7f0fef03-d0f9-4263-a51a-c1eb1123ecca"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"SetAttributes", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "RBDGetIndex", ",", " ", "RBDGetPositionIndex", ",", " ", 
       "RBDGetValue"}], "}"}], ",", " ", "Listable"}], "]"}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "x"}], " ", "=", " ", "\[IndentingNewLine]", 
   "\"\<Cannot use a string as an index for \[DoubleStruckX]; indices 1...`1` \
are valid.\>\""}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "dof"}], " ", "=", " ", 
   "\[IndentingNewLine]", 
   "\"\<Invalid index `1` for body `2`; the body only has `3` degrees of \
freedom.\>\""}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "n"}], " ", "=", " ", "\[IndentingNewLine]", 
   "\"\<`2` is not a valid index for `1`; indices 1...`3` are valid.\>\""}], 
  ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "var"}], " ", "=", " ", 
   "\[IndentingNewLine]", 
   "\"\<`1` is not a valid parameter; valid parameters are \[DoubleStruckQ], \
\[DoubleStruckV], \[DoubleStruckX], and \[DoubleStruckC].\>\""}], ";"}], "\n", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "s"}], " ", "=", " ", "\[IndentingNewLine]", 
   "\"\<`1` is not a valid link name; links `2` are valid.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "::", "jnt"}], " ", "=", " ", 
   "\[IndentingNewLine]", 
   "\"\<`1` is not a valid joint name; links `2` are valid.\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetIndex", "::", "arg"}], " ", "=", " ", 
    "\"\<`1` is an invalid argument.\>\""}], ";"}], "\[IndentingNewLine]", 
  "\n", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"replaces", " ", "q", " ", "or", " ", "v"}], ",", " ", 
    RowBox[{"not", " ", 
     RowBox[{"x", "."}]}]}], " ", "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetIndex", "[", 
    RowBox[{"f_", "[", 
     RowBox[{
      RowBox[{"Root", "|", "0"}], ",", " ", "_"}], "]"}], "]"}], " ", ":=", 
   " ", "0"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetIndex", "[", 
     RowBox[{"f_", "[", 
      RowBox[{"i_String", ",", " ", "j_"}], "]"}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "b", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"rb", ",", " ", "TreeForm", ",", " ", 
          RowBox[{"GetTree", "[", "]"}]}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"b", " ", "=", " ", 
        RowBox[{"Lookup", "[", 
         RowBox[{"b", ",", " ", "i", ",", " ", 
          RowBox[{"StringRiffle", "[", 
           RowBox[{
            RowBox[{"Keys", "@", "b"}], ",", " ", "\"\<, \>\""}], "]"}]}], 
         "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"If", "[", 
        RowBox[{
         RowBox[{"IntegerQ", "[", "b", "]"}], ",", " ", 
         RowBox[{"RBDGetIndex", "[", 
          RowBox[{"f", "[", 
           RowBox[{"b", ",", " ", "j"}], "]"}], "]"}], ",", " ", 
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"RBDGetIndex", "::", "s"}], ",", " ", "i", ",", " ", "b"}],
           "]"}]}], "]"}]}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetIndex", "[", 
     RowBox[{"f_", "[", 
      RowBox[{"i_String", ",", " ", "j_String"}], "]"}], "]"}], " ", ":=", 
    " ", 
    RowBox[{"RBDGetIndex", "@", 
     RowBox[{"RBDGetDOF", "[", 
      RowBox[{"f", "[", 
       RowBox[{"i", ",", " ", "j"}], "]"}], "]"}]}]}], ";"}], 
  "\[IndentingNewLine]", "\n", 
  RowBox[{"(*", " ", 
   RowBox[{"x", " ", "is", " ", "undetermined", " ", 
    RowBox[{"w", "/", " ", "just"}], " ", "name"}], " ", 
   "*)"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetIndex", "[", 
     RowBox[{"\[DoubleStruckX]", "[", "i_String", "]"}], "]"}], " ", ":=", 
    " ", "\[IndentingNewLine]", 
    RowBox[{"Message", "[", 
     RowBox[{
      RowBox[{"RBDGetIndex", "::", "x"}], ",", " ", "i", ",", " ", "nx"}], 
     "]"}]}], ";"}], "\n"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetIndex", "[", 
     RowBox[{"f_", "[", 
      RowBox[{"i_Integer", ",", " ", "j___Integer"}], "]"}], "]"}], " ", ":=",
     " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "n", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"n", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"f", " ", "===", " ", "\[DoubleStruckV]"}], ",", " ", "nq", 
          ",", " ", "0"}], "]"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"Which", "[", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"f", " ", "===", " ", "\[DoubleStruckQ]"}], " ", "||", " ", 
          
          RowBox[{"f", " ", "===", " ", "\[DoubleStruckV]"}]}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Which", "[", 
          RowBox[{
           RowBox[{"!", 
            RowBox[{"(", 
             RowBox[{
             "0", " ", "<", " ", "i", " ", "\[LessEqual]", " ", "nb"}], 
             ")"}]}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
             "\"\<\[DoubleStruckQ] or \[DoubleStruckV]\>\"", ",", " ", "i", 
             ",", " ", "nb"}], "]"}], ",", " ", "\[IndentingNewLine]", 
           RowBox[{"!", 
            RowBox[{"(", 
             RowBox[{"0", "<", 
              RowBox[{"Abs", "[", "j", "]"}], " ", "\[LessEqual]", " ", 
              RowBox[{
              "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
             ")"}]}], ",", "\[IndentingNewLine]", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"RBDGetIndex", "::", "dof"}], ",", " ", "j", ",", " ", 
             "i", ",", " ", 
             RowBox[{
             "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}], 
            "]"}], ",", "\[IndentingNewLine]", 
           RowBox[{"j", " ", ">", " ", "0"}], ",", " ", 
           RowBox[{
            RowBox[{
            "map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "+", "j", " ", "-", " ", 
            RowBox[{
            "ni", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ",
             "+", " ", "n"}], ",", "\[IndentingNewLine]", "True", " ", 
           RowBox[{"(*", 
            RowBox[{"j", " ", "<", " ", "0"}], "*)"}], ",", " ", 
           RowBox[{
            RowBox[{
            "map", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "+", "j", " ", "+", " ", "1", " ", "+", " ", "n"}]}], 
          "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"f", " ", "===", " ", "\[DoubleStruckC]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"0", "<", "i", " ", "\[LessEqual]", " ", "nc"}], ",", " ", 
           "i", ",", " ", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"-", "nc"}], " ", "\[LessEqual]", " ", "i", " ", "<", " ",
             "0"}], ",", " ", 
           RowBox[{"nc", " ", "+", " ", "i", " ", "+", " ", "1"}], ",", 
           "\[IndentingNewLine]", "True", ",", " ", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
             "\"\<\[DoubleStruckC]\>\"", ",", " ", "i", ",", " ", "nc"}], 
            "]"}]}], "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]",
          "\[IndentingNewLine]", 
         RowBox[{"f", " ", "===", " ", "\[DoubleStruckX]"}], ",", 
         "\[IndentingNewLine]", 
         RowBox[{"Which", "[", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"0", "<", "i", " ", "\[LessEqual]", " ", "nx"}], ",", " ", 
           "i", ",", " ", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"-", "nx"}], " ", "\[LessEqual]", " ", "i", " ", "<", " ",
             "0"}], ",", " ", 
           RowBox[{"nx", " ", "+", " ", "i", " ", "+", " ", "1"}], ",", 
           "\[IndentingNewLine]", "True", ",", " ", 
           RowBox[{"Message", "[", 
            RowBox[{
             RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
             "\"\<\[DoubleStruckX]\>\"", ",", " ", "i", ",", " ", "nx"}], 
            "]"}]}], "\[IndentingNewLine]", "]"}], ",", "\[IndentingNewLine]",
          "\[IndentingNewLine]", "True", ",", 
         RowBox[{"Message", "[", 
          RowBox[{
           RowBox[{"RBDGetIndex", "::", "var"}], ",", " ", "f"}], "]"}]}], 
        "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetPositionIndex", "[", "b_", "]"}], " ", ":=", " ", 
    RowBox[{"Which", "[", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{
       RowBox[{"IntegerQ", "[", "b", "]"}], " ", "&&", " ", 
       RowBox[{
       "1", " ", "\[LessEqual]", " ", "b", " ", "\[LessEqual]", " ", "nq"}]}],
       ",", " ", "b", ",", " ", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"StringQ", "[", "b", "]"}], " ", "||", " ", 
       RowBox[{"b", " ", "===", " ", "Root"}]}], ",", " ", 
      RowBox[{"RBDGetIndex", "[", 
       RowBox[{"\[DoubleStruckQ]", "[", 
        RowBox[{"b", ",", " ", 
         RowBox[{"-", "1"}]}], "]"}], "]"}], ",", " ", "\[IndentingNewLine]", 
      
      RowBox[{
       RowBox[{"Head", "[", "b", "]"}], " ", "===", " ", "\[DoubleStruckQ]"}],
       ",", " ", 
      RowBox[{"RBDGetIndex", "[", "b", "]"}], ",", "\[IndentingNewLine]", 
      RowBox[{"IntegerQ", "[", "b", "]"}], ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
        "\"\<\[DoubleStruckQ]\>\"", ",", " ", "b", ",", " ", "nq"}], "]"}], 
      ",", "\[IndentingNewLine]", "True", ",", " ", 
      RowBox[{"Message", "[", 
       RowBox[{
        RowBox[{"RBDGetIndex", "::", "arg"}], ",", " ", "b"}], "]"}]}], 
     "\[IndentingNewLine]", "]"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "RBDGetValue", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<e\>\"", " ", "\[Rule]", " ", "True"}], ",", " ", 
      RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], "}"}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDGetValue", "[", 
     RowBox[{"i_Integer", ",", " ", "j_Integer", ",", " ", 
      RowBox[{"opts", ":", 
       RowBox[{"OptionsPattern", "[", "]"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"RBDGetValue", "[", 
     RowBox[{
      RowBox[{"Range", "[", 
       RowBox[{"i", ",", " ", "j"}], "]"}], ",", " ", "opts"}], "]"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDGetValue", "[", 
    RowBox[{"i_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "n", ",", " ", "k", ",", " ", "f", ",", " ", "exp", ",", " ", "nam"}], 
      "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{"body", " ", "index", " ", "or", " ", "expanded", " ", 
       RowBox[{"index", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"exp", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<e\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"numeric", " ", "or", " ", "string", " ", 
        RowBox[{"name", "?"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"nam", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<n\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Which", "[", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"state", " ", "index"}], " ", "*)"}], "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"exp", " ", "&&", " ", 
         RowBox[{"1", " ", "\[LessEqual]", " ", "i", " ", "\[LessEqual]", " ", 
          RowBox[{"3", "nq"}]}]}], ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"f", ",", " ", "n"}], "}"}], " ", "=", " ", 
          RowBox[{"Which", "[", 
           RowBox[{
            RowBox[{"i", " ", ">", " ", "nx"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckA]", ",", " ", 
              RowBox[{"i", "-", "nx"}]}], "}"}], ",", " ", 
            RowBox[{"i", " ", ">", " ", "nq"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckV]", ",", " ", 
              RowBox[{"i", "-", "nq"}]}], "}"}], ",", " ", "True", ",", " ", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckQ]", ",", " ", "i"}], "}"}]}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"k", " ", "=", " ", 
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"Range", "@", 
              RowBox[{"Length", "@", "map"}]}], ",", " ", 
             RowBox[{
              RowBox[{"n", " ", "\[LessEqual]", " ", 
               RowBox[{
               "map", "\[LeftDoubleBracket]", "#", 
                "\[RightDoubleBracket]"}]}], "&"}], ",", " ", "1"}], "]"}], 
           "\[LeftDoubleBracket]", "1", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"k", " ", "\[Equal]", " ", "1"}], ",", " ", "n", ",", " ", 
            RowBox[{"n", " ", "-", " ", 
             RowBox[{"map", "\[LeftDoubleBracket]", 
              RowBox[{"k", "-", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"k", " ", "=", " ", 
          RowBox[{
           RowBox[{"Keys", "[", 
            RowBox[{"Lookup", "[", 
             RowBox[{"rb", ",", " ", "TreeForm", ",", " ", 
              RowBox[{"GetTree", "[", "]"}]}], "]"}], "]"}], 
           "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{"nam", ",", " ", 
           RowBox[{"RBDGetDOF", "[", 
            RowBox[{"f", "[", 
             RowBox[{"k", ",", " ", "n"}], "]"}], "]"}], ",", " ", 
           RowBox[{"f", "[", 
            RowBox[{"k", ",", " ", "n"}], "]"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"body", " ", "index"}], " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
        "1", " ", "\[LessEqual]", " ", "i", " ", "\[LessEqual]", " ", "nb"}], 
        ",", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"{", 
           RowBox[{"f", ",", " ", "k"}], "}"}], " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"i", " ", ">", " ", "nb"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckV]", ",", " ", 
              RowBox[{"i", " ", "-", " ", "nb"}]}], "}"}], ",", " ", 
            RowBox[{"{", 
             RowBox[{"\[DoubleStruckQ]", ",", " ", "i"}], "}"}]}], "]"}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"k", " ", "\[Equal]", " ", "1"}], ",", " ", 
            RowBox[{
            "map", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
            ",", " ", 
            RowBox[{
             RowBox[{
             "map", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
             "-", 
             RowBox[{"map", "\[LeftDoubleBracket]", 
              RowBox[{"k", "-", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}],
          ";", "\[IndentingNewLine]", 
         RowBox[{"k", " ", "=", " ", 
          RowBox[{
           RowBox[{"Keys", "[", 
            RowBox[{"Lookup", "[", 
             RowBox[{"rb", ",", " ", "TreeForm", ",", " ", 
              RowBox[{"GetTree", "[", "]"}]}], "]"}], "]"}], 
           "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"If", "[", 
          RowBox[{"nam", ",", " ", 
           RowBox[{"RBDGetDOF", "[", 
            RowBox[{"f", "[", 
             RowBox[{"k", ",", " ", "n"}], "]"}], "]"}], ",", " ", 
           RowBox[{"f", "[", 
            RowBox[{"k", ",", " ", "n"}], "]"}]}], "]"}]}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"error", " ", "messages"}], " ", "*)"}], 
        "\[IndentingNewLine]", "exp", ",", " ", 
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
          "\"\<\[DoubleStruckX]\>\"", ",", " ", "i", ",", " ", "nx"}], "]"}], 
        ",", "\[IndentingNewLine]", "True", ",", " ", 
        RowBox[{"Message", "[", 
         RowBox[{
          RowBox[{"RBDGetIndex", "::", "n"}], ",", " ", 
          "\"\<\[DoubleStruckQ] or \[DoubleStruckV]\>\"", ",", " ", "i", ",", 
          " ", "nb"}], "]"}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"9233ae40-d42d-4e87-885b-5cf453f7009d"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"ConvertToXL", "[", "expr_", "]"}], " ", ":=", " ", 
    RowBox[{
     RowBox[{"RBDExpandExpression", "[", "expr", "]"}], " ", "/.", " ", 
     RowBox[{"{", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{
        RowBox[{"h_", " ", "/;", " ", 
         RowBox[{"MemberQ", "[", 
          RowBox[{
           RowBox[{"{", 
            RowBox[{
            "\[DoubleStruckQ]", ",", " ", "\[DoubleStruckV]", ",", " ", 
             "\[DoubleStruckX]"}], "}"}], ",", " ", 
           RowBox[{"Head", "[", "h", "]"}]}], "]"}]}], " ", "\[RuleDelayed]", 
        " ", 
        RowBox[{"\[DoubleStruckX]", "[", 
         RowBox[{"RBDGetIndex", "[", "h", "]"}], "]"}]}], ",", " ", 
       "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"h_", " ", "/;", " ", 
         RowBox[{
          RowBox[{"Head", "[", "h", "]"}], " ", "===", " ", 
          "\[DoubleStruckC]"}]}], " ", "\[RuleDelayed]", " ", 
        RowBox[{"\[DoubleStruckC]", "[", 
         RowBox[{"RBDGetIndex", "[", "h", "]"}], "]"}]}]}], 
      "\[IndentingNewLine]", "}"}]}]}], ";"}], 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"Options", "[", "ConvertToXLFunction", "]"}], " ", "=", " ", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"\"\<dot\>\"", " ", "\[Rule]", " ", "False"}], ",", " ", 
      RowBox[{"\"\<c\>\"", " ", "\[Rule]", " ", "Automatic"}], ",", " ", 
      RowBox[{"\"\<cdot\>\"", " ", "\[Rule]", " ", "Automatic"}]}], "}"}]}], 
   ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"ConvertToXLFunction", "[", 
    RowBox[{"expr_", ",", " ", 
     RowBox[{"OptionsPattern", "[", "]"}]}], "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "dot", ",", " ", "e", ",", " ", "edot", ",", " ", "f", ",", " ", "c", 
       ",", " ", "cdot"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"dot", " ", "=", " ", 
       RowBox[{"OptionValue", "[", "\"\<dot\>\"", "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"f", " ", "=", " ", 
       RowBox[{
        RowBox[{"With", "[", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{"a", " ", "=", " ", 
            RowBox[{"ConvertToXL", "@", "#"}]}], "}"}], ",", " ", 
          RowBox[{"a", "&"}]}], "]"}], "&"}]}], ";", "\[IndentingNewLine]", 
      "\[IndentingNewLine]", 
      RowBox[{"e", " ", "=", " ", 
       RowBox[{"f", "[", "expr", "]"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"edot", " ", "=", " ", 
       RowBox[{"If", "[", 
        RowBox[{"dot", ",", " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"c", " ", "=", " ", 
           RowBox[{"OptionValue", "[", "\"\<c\>\"", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"c", " ", "===", " ", "Automatic"}], ",", " ", 
            RowBox[{"c", " ", "=", " ", 
             RowBox[{"RBDGetValue", "[", 
              RowBox[{"1", ",", " ", "nq", ",", " ", 
               RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], 
              "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"cdot", " ", "=", " ", 
           RowBox[{"OptionValue", "[", "\"\<cdot\>\"", "]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"cdot", " ", "===", " ", "Automatic"}], ",", " ", 
            RowBox[{"cdot", " ", "=", " ", 
             RowBox[{"RBDGetValue", "[", 
              RowBox[{
               RowBox[{"nq", "+", "1"}], ",", " ", "nx", ",", " ", 
               RowBox[{"\"\<n\>\"", " ", "\[Rule]", " ", "False"}]}], 
              "]"}]}]}], "]"}], ";", "\[IndentingNewLine]", 
          RowBox[{"f", "[", 
           RowBox[{"Con", "[", 
            RowBox[{"expr", ",", " ", "c", ",", " ", "cdot"}], "]"}], "]"}]}],
          ",", " ", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
         RowBox[{"{", "}"}]}], "\[IndentingNewLine]", "]"}]}], ";", 
      "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"Block", "[", 
       RowBox[{
        RowBox[{"{", "Part", "}"}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"f", " ", "=", " ", 
          RowBox[{"{", 
           RowBox[{
            RowBox[{
             RowBox[{"\[DoubleStruckX]", "[", "i__", "]"}], " ", 
             "\[RuleDelayed]", " ", 
             RowBox[{"Part", "[", 
              RowBox[{
               RowBox[{"Slot", "[", "1", "]"}], ",", " ", "i"}], "]"}]}], ",",
             " ", 
            RowBox[{
             RowBox[{"\[DoubleStruckC]", "[", "i__", "]"}], " ", 
             "\[RuleDelayed]", " ", 
             RowBox[{"Part", "[", 
              RowBox[{
               RowBox[{"Slot", "[", "2", "]"}], ",", " ", "i"}], "]"}]}]}], 
           "}"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"If", "[", 
           RowBox[{"dot", ",", " ", 
            RowBox[{"{", 
             RowBox[{"e", ",", " ", "edot"}], "}"}], ",", " ", "e"}], "]"}], 
          "  ", "/.", " ", "f"}]}]}], "\[IndentingNewLine]", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"cb6d3249-c8f3-48b8-bbba-526d3c1196f3"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"2a6edcc4-088f-4665-b582-66fede76e8bf"],

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->
  True,ExpressionUUID->"b059c6f5-1e81-4f81-b380-8ec973d1bcf6"]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1373, 1505},
WindowMargins->{{Automatic, 0}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

