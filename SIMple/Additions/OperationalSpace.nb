Notebook[{
Cell[BoxData[
 RowBox[{"(*", "\n", 
  RowBox[{
   RowBox[{"OperationalSpace", ".", 
    RowBox[{"nb", ":", " ", 
     RowBox[{
     "An", " ", "implementation", " ", "of", " ", "the", " ", "OSIM", " ", 
      "algorithm", "\n", "and", " ", "its", " ", 
      RowBox[{"derivative", ".", "\n", "Copyright"}], " ", 
      RowBox[{"(", "C", ")"}], " ", "2014", " ", "Nelson", " ", "Rosa", " ", 
      RowBox[{"Jr", ".", "\n", "\n", "This"}], " ", "program", " ", "is", " ",
       "free", " ", "software"}], ":", " ", 
     RowBox[{"you", " ", "can", " ", "redistribute", " ", "it", " ", 
      RowBox[{"and", "/", "or"}], " ", "modify", "\n", "it", " ", "under", 
      " ", "the", " ", "terms", " ", "of", " ", "the", " ", "GNU", " ", 
      "General", " ", "Public", " ", "License", " ", "as", " ", "published", 
      " ", "by", "\n", 
      RowBox[{"the", " ", "Free", " ", "Software", " ", "Foundation"}]}]}]}], 
   ",", " ", 
   RowBox[{
   "either", " ", "version", " ", "3", " ", "of", " ", "the", " ", 
    "License"}], ",", " ", 
   RowBox[{"or", "\n", 
    RowBox[{"(", 
     RowBox[{"at", " ", "your", " ", "option"}], ")"}], " ", "any", " ", 
    "later", " ", 
    RowBox[{"version", ".", " ", "This"}], " ", "program", " ", "is", " ", 
    "distributed", " ", "in", " ", "the", " ", "\n", "hope", " ", "that", " ",
     "it", " ", "will", " ", "be", " ", "useful"}], ",", " ", 
   RowBox[{
    RowBox[{"but", " ", "WITHOUT", " ", "ANY", " ", "WARRANTY"}], ";", " ", 
    RowBox[{
    "without", " ", "even", " ", "the", " ", "\n", "implied", " ", "warranty",
      " ", "of", " ", "MERCHANTABILITY", " ", "or", " ", "FITNESS", " ", 
     "FOR", " ", "A", " ", "PARTICULAR", " ", 
     RowBox[{"PURPOSE", ".", "\n", "See"}], " ", "the", " ", "GNU", " ", 
     "General", " ", "Public", " ", "License", " ", "for", " ", "more", " ", 
     RowBox[{"details", ".", " ", "You"}], " ", "should", " ", "have", " ", 
     "\n", "received", " ", "a", " ", "copy", " ", "of", " ", "the", " ", 
     "GNU", " ", "General", " ", "Public", " ", "License", " ", "along", " ", 
     "with", " ", "this", " ", 
     RowBox[{"program", ".", "\n", "If"}], " ", "not"}]}], ",", " ", 
   RowBox[{
    RowBox[{"see", " ", "<", 
     RowBox[{"http", ":"}]}], "//", 
    RowBox[{
     RowBox[{
      RowBox[{
       RowBox[{"www", ".", "gnu", ".", "org"}], "/", "licenses"}], "/"}], ">",
      "."}]}]}], "\n", "*)"}]], "Code",
 InitializationCell->True,
 CellLabel->
  "In[655]:=",ExpressionUUID->"80d6764f-9ed1-4e45-b557-d6116ad20c1f"],

Cell[CellGroupData[{

Cell["Begin Package", \
"Section",ExpressionUUID->"2981765b-1ae0-4662-8c4b-44fc1173c359"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"BeginPackage", "[", 
  RowBox[{
  "\"\<RigidBodyDynamics`\>\"", ",", " ", "\"\<GlobalVariables`\>\""}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBDJ2", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"RBD\[Eta]2", "::", "usage"}], " ", "=", " ", "\"\<\>\""}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"Begin", "[", "\"\<`Private`\>\"", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[656]:=",ExpressionUUID->"3a398533-f5fe-4be6-9faf-3d6fb0b1f99c"],

Cell[BoxData["\<\"RigidBodyDynamics`\"\>"], "Output",
 CellLabel->
  "Out[656]=",ExpressionUUID->"c8fb60d0-759f-4c64-ac5d-7d755a55563e"],

Cell[BoxData["\<\"RigidBodyDynamics`Private`\"\>"], "Output",
 CellLabel->"Out[659]=",ExpressionUUID->"34a8ff03-ae52-457e-9c91-96f0124e8de1"]
}, Open  ]],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "Jacobian", " ", "maps", " ", "velocities", " ", "from", " ", "C"}], "-", 
     RowBox[{"space", " ", "to", " ", "O"}], "-", "space"}], ",", " ", 
    RowBox[{"J", " ", "=", " ", 
     RowBox[{"R", ".", "X", ".", "S"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "a", " ", "constraint", " ", "is", " ", "placed", " ", "somewhere", " ", 
    "on", " ", "body", " ", "b", " ", "represented", " ", "in", " ", "frame", 
    " ", "o"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
   "moving", " ", "the", " ", "frame", " ", "around", " ", "increases", " ", 
    "the", " ", "degrees", " ", "of", " ", "freedom", " ", "a"}], " ", "*)"}],
   "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"constraint", " ", 
     RowBox[{"has", ".", "  ", "for"}], " ", "example"}], ",", " ", 
    RowBox[{
     RowBox[{"a", " ", "constraint", " ", "where", " ", "o"}], " ", "=", " ", 
     
     RowBox[{"b", " ", "only", " ", "constrains"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
     "a", " ", "joint", " ", "space", " ", "variable", " ", "at", " ", "body",
       " ", "b", " ", "for", " ", "a", " ", "1"}], "-", 
     RowBox[{"dof", " ", "link"}]}], ";", " ", 
    RowBox[{"however", " ", "if"}]}], " ", "*)"}], " ", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"o", " ", "=", " ", "Root"}], ",", " ", 
    RowBox[{
    "then", " ", "all", " ", "joints", " ", "from", " ", "b", " ", "to", " ", 
     "Root", " ", "can", " ", "satisfy", " ", "the", " ", "constraint"}]}], 
   " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"at", " ", 
    RowBox[{"b", "."}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"b", " ", "=", " ", 
     RowBox[{"constraint", " ", "body", " ", "#"}]}], ",", " ", 
    RowBox[{
    "where", " ", "the", " ", "constraint", " ", "Xcb", " ", "is", " ", 
     "applied"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"a", " ", "=", " ", 
    RowBox[{"ancestor", " ", "of", " ", "b"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"w", " ", "=", " ", 
    RowBox[{"Root", " ", "=", " ", 
     RowBox[{"0", " ", "or", " ", "world", " ", "frame"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"o", " ", "=", " ", 
    RowBox[{"origin", " ", "frame"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"i", " ", "=", " ", 
    RowBox[{"constraint", " ", "number"}]}], " ", "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{"the", " ", "following", " ", "computes", " ", 
     RowBox[{"J", "[", 
      RowBox[{"i", ",", "j"}], "]"}]}], " ", "=", " ", 
    RowBox[{
     RowBox[{"r", "[", "c", "]"}], ".", 
     RowBox[{"W", "[", 
      RowBox[{"c", ",", "b"}], "]"}], ".", 
     RowBox[{"X", "[", 
      RowBox[{"b", ",", "j"}], "]"}], ".", 
     RowBox[{"s", "[", "j", "]"}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"where", " ", 
    RowBox[{"W", "[", 
     RowBox[{"c", ",", "b"}], "]"}], " ", "expresses", " ", 
    RowBox[{"v", "[", "b", "]"}], " ", "in", " ", "a", " ", "frame", " ", 
    "located", " ", "at"}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"c", " ", "=", " ", 
    RowBox[{
     RowBox[{"(", 
      RowBox[{"px", ",", " ", "py", ",", " ", "pz"}], ")"}], " ", "with", " ",
      "an", " ", "orientation", " ", 
     RowBox[{"(", 
      RowBox[{"rx", ",", " ", "ry", ",", " ", "rz"}], ")"}]}]}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"aligned", " ", "with", " ", "the", " ", "world", " ", "frame"}], 
   " ", "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{
      RowBox[{"d", "/", "dt"}], " ", "Xba"}], " ", "=", " ", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{"vba", " ", "-", " ", "vbb"}], ")"}], " ", "x", " ", "Xba"}]}],
     ",", " ", 
    RowBox[{
    "where", " ", "x", " ", "is", " ", "vector", " ", "cross", " ", 
     "product"}]}], " ", "*)"}], "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
    "for", " ", "our", " ", "purposes", " ", "this", " ", "reduces", " ", 
     "to"}], " ", "-", 
    RowBox[{"vbb", " ", "x", " ", "Xba", " ", 
     RowBox[{"b", "/", "c"}], " ", "of", " ", "the", " ", "world", " ", 
     "frame"}]}], "*)"}]}]], "Input",
 CellLabel->"In[660]:=",ExpressionUUID->"1bb6363c-e4f6-4a7f-9daa-b44b327d3d2d"]
}, Open  ]],

Cell[CellGroupData[{

Cell["Task Jacobian", \
"Section",ExpressionUUID->"c8ac8437-8d1b-420f-9b78-8453ee275e39"],

Cell[CellGroupData[{

Cell["\<\
The task Jacobian is a transformation from joint velocties to \
operational-space velocities.\
\>", "Subsection",ExpressionUUID->"98092051-af53-4c02-bdaa-eb9ca01366f2"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"user", " ", 
      RowBox[{"inputs", ":", " ", "none"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"zeroed", " ", 
      RowBox[{"inputs", ":", " ", "XL0"}]}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"model", " ", 
      RowBox[{"data", ":", " ", "XL"}]}]}], ",", " ", "XLdot", ",", " ", 
    "parent", ",", " ", 
    RowBox[{"nq", ";", "\[IndentingNewLine]", 
     RowBox[{"modifies", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"output", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", " ", 
     RowBox[{"(", 
      RowBox[{"transforms", " ", 
       RowBox[{"from", "/", "to"}], " ", "root"}], ")"}]}]}], 
   "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"X0", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p", ",", " ", "X", ",", " ", "R", ",", " ", "P"}], "}"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"timera", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"compute", " ", "transform", " ", 
          RowBox[{"X", "[", 
           RowBox[{"b", ",", " ", "0"}], "]"}], " ", "or", " ", 
          RowBox[{"X", "[", 
           RowBox[{"o", ",", " ", "0"}], "]"}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"XL0", " ", "=", " ", "XL"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{"p", " ", "=", " ", 
            RowBox[{
            "parent", "\[LeftDoubleBracket]", "i", 
             "\[RightDoubleBracket]"}]}], ";", "  ", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"p", " ", ">", " ", "0"}], ",", " ", 
             RowBox[{
              RowBox[{"X", " ", "=", " ", 
               RowBox[{
               "XL0", "\[LeftDoubleBracket]", "i", 
                "\[RightDoubleBracket]"}]}], ";", " ", 
              RowBox[{
               RowBox[{
               "XL0", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{"X", ".", 
                RowBox[{
                "XL0", "\[LeftDoubleBracket]", "p", 
                 "\[RightDoubleBracket]"}]}]}]}]}], "]"}], ";"}], ",", " ", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "bx"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{"compute", " ", "inverse", " ", "transform"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"X0L", " ", "=", " ", "XL0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"R", " ", "=", " ", 
            RowBox[{
             RowBox[{"X0L", "\[LeftDoubleBracket]", 
              RowBox[{"i", ",", 
               RowBox[{"1", ";;", "3"}], ",", 
               RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
             "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"P", " ", "=", " ", 
            RowBox[{"-", 
             RowBox[{"X0L", "\[LeftDoubleBracket]", 
              RowBox[{"i", ",", 
               RowBox[{"4", ";;", "6"}], ",", 
               RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}]}], ";",
            "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"X0L", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", 
              RowBox[{"1", ";;", "3"}], ",", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=",
             " ", "R"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"X0L", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", 
              RowBox[{"4", ";;", "6"}], ",", 
              RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], " ", "=",
             " ", "R"}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"X0L", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", 
              RowBox[{"4", ";;", "6"}], ",", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=",
             " ", 
            RowBox[{"R", ".", "P", ".", "R"}]}], ";"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "bx"}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "create", " ", "corresponding", " ", "rotation", " ", "matrices"}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{"RL0", " ", "=", " ", "XL0"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{"RL0", "\[LeftDoubleBracket]", 
             RowBox[{"i", ",", " ", 
              RowBox[{"4", ";;", "6"}], ",", " ", 
              RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=",
             " ", "Z3"}], ";"}], " ", ",", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "bx"}], "}"}]}], "]"}], ";", 
        "\[IndentingNewLine]", 
        RowBox[{"R0L", " ", "=", " ", 
         RowBox[{"Transpose", "[", 
          RowBox[{"RL0", ",", " ", 
           RowBox[{"{", 
            RowBox[{"1", ",", " ", "3", ",", " ", "2"}], "}"}]}], "]"}]}], 
        ";", "\[IndentingNewLine]", 
        RowBox[{"timerb", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<X0: \>\"", ",", " ", 
          RowBox[{"timerb", " ", "-", " ", "timera"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[661]:=",ExpressionUUID->"769e96cd-2080-4e10-b0ab-ef2499419334"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"Join", "[", 
       RowBox[{"z3", ",", " ", 
        RowBox[{"position", "[", "#", "]"}]}], "]"}], "&"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", " ", 
   RowBox[{"assuming", " ", "singularities", " ", 
    RowBox[{"won", "'"}], "t", " ", "occur"}], " ", "*)"}], 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"angX", " ", "=", " ", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"ArcTan", "[", 
         RowBox[{
          RowBox[{"#", "\[LeftDoubleBracket]", 
           RowBox[{"3", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
          RowBox[{"-", 
           RowBox[{"#", "\[LeftDoubleBracket]", 
            RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}]}]}], "]"}], 
        ",", " ", 
        RowBox[{"ArcSin", "[", 
         RowBox[{"#", "\[LeftDoubleBracket]", 
          RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], "]"}], ",", " ", 
        RowBox[{"ArcTan", "[", 
         RowBox[{
          RowBox[{"#", "\[LeftDoubleBracket]", 
           RowBox[{"1", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
          RowBox[{"-", 
           RowBox[{"#", "\[LeftDoubleBracket]", 
            RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}], 
       "}"}], "&"}]}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"position", "[", "#", "]"}], "&"}]}], ";"}], "*)"}], 
  "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{"posX", " ", "=", " ", 
     RowBox[{
      RowBox[{"Join", "[", 
       RowBox[{
        RowBox[{"{", 
         RowBox[{
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"#2", "\[LeftDoubleBracket]", 
             RowBox[{"3", ",", "3"}], "\[RightDoubleBracket]"}], ",", " ", 
            RowBox[{"-", 
             RowBox[{"#2", "\[LeftDoubleBracket]", 
              RowBox[{"3", ",", "2"}], "\[RightDoubleBracket]"}]}]}], "]"}], 
          ",", " ", 
          RowBox[{"ArcSin", "[", 
           RowBox[{"#2", "\[LeftDoubleBracket]", 
            RowBox[{"3", ",", "1"}], "\[RightDoubleBracket]"}], "]"}], ",", 
          " ", 
          RowBox[{"ArcTan", "[", 
           RowBox[{
            RowBox[{"#2", "\[LeftDoubleBracket]", 
             RowBox[{"1", ",", "1"}], "\[RightDoubleBracket]"}], ",", " ", 
            RowBox[{"-", 
             RowBox[{"#2", "\[LeftDoubleBracket]", 
              RowBox[{"2", ",", "1"}], "\[RightDoubleBracket]"}]}]}], "]"}]}],
          "}"}], ",", " ", 
        RowBox[{"position", "[", "#1", "]"}]}], "]"}], "&"}]}], ";"}], "*)"}],
   "\[IndentingNewLine]", "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"V", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{"p", ",", " ", "vJ"}], "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"timera", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"v", " ", "=", " ", "zspat"}], ";", "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"p", " ", "=", " ", 
            RowBox[{
            "parent", "\[LeftDoubleBracket]", "i", 
             "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"vJ", " ", "=", " ", 
            RowBox[{
             RowBox[{
             "s", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ", 
             RowBox[{
             "qd", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}],
            ";", "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"p", " ", "\[Equal]", " ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "=", " ", "vJ"}], ";"}], ",", " ", "\[IndentingNewLine]", 
             
             RowBox[{
              RowBox[{
               RowBox[{
               "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}],
                  ".", 
                 RowBox[{
                 "v", "\[LeftDoubleBracket]", "p", 
                  "\[RightDoubleBracket]"}]}], " ", "+", " ", "vJ"}]}], 
              ";"}]}], "\[IndentingNewLine]", "]"}], ";"}], ",", " ", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "nq"}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", 
        RowBox[{"timerb", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<V: \>\"", ",", " ", 
          RowBox[{"timerb", " ", "-", " ", "timera"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"rs0", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "Xdot", ",", " ", "va", ",", " ", "vb", ",", " ", "vo0", ",", " ", 
         "vX", ",", " ", "b", ",", " ", "o", ",", " ", "X", ",", " ", "R"}], 
        "}"}], ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"timera", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
         "move", " ", "joint", " ", "and", " ", "constraint", " ", "vectors", 
          " ", "into", " ", "world", " ", "frame"}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"sj", " ", "=", " ", "s"}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"move", " ", "s", " ", "into", " ", "world", " ", "frame"}],
           ",", " ", 
          RowBox[{"sj", " ", "=", " ", 
           RowBox[{
            RowBox[{"X", "[", 
             RowBox[{"0", ",", " ", "j"}], "]"}], ".", 
            RowBox[{"s", "[", 
             RowBox[{"j", ",", " ", "j"}], "]"}]}]}]}], " ", "*)"}], 
        "\[IndentingNewLine]", 
        RowBox[{"sjdot", " ", "=", " ", "sdot"}], ";", " ", 
        RowBox[{"(*", " ", 
         RowBox[{
         "move", " ", "sdot", " ", "into", " ", "world", " ", "frame"}], " ", 
         "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{
            RowBox[{
            "sj", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], " ",
             "=", " ", 
            RowBox[{
             RowBox[{
             "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             ".", 
             RowBox[{
             "s", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"vX", " ", "=", " ", 
            RowBox[{
             RowBox[{
             "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
             ".", 
             RowBox[{
             "v", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{"Xdot", " ", "=", " ", 
            RowBox[{"mxX", "[", 
             RowBox[{"vX", ",", " ", 
              RowBox[{
              "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
              "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "sjdot", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            " ", "=", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "X0L", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "sdot", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}]}], " ", "+", " ", 
             RowBox[{"Xdot", ".", 
              RowBox[{
              "s", "\[LeftDoubleBracket]", "i", 
               "\[RightDoubleBracket]"}]}]}]}], ";"}], ",", 
          "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"i", ",", " ", "bs"}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"Xo0", " ", "=", " ", "Tcb"}], ";", "\[IndentingNewLine]", 
        RowBox[{"ro", " ", "=", " ", "r"}], ";", "\[IndentingNewLine]", 
        RowBox[{"rodot", " ", "=", " ", "rdot"}], ";", "\[IndentingNewLine]", 
        
        RowBox[{"posXco", " ", "=", " ", "zpos"}], ";", "\[IndentingNewLine]",
         "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"b", " ", "=", " ", 
            RowBox[{"bo", "\[LeftDoubleBracket]", 
             RowBox[{"k", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], ";", 
           "\[IndentingNewLine]", 
           RowBox[{"o", " ", "=", " ", 
            RowBox[{"bo", "\[LeftDoubleBracket]", 
             RowBox[{"k", ",", " ", "2"}], "\[RightDoubleBracket]"}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "compute", " ", "X", " ", "transform", " ", "from", " ", "0", " ", 
             RowBox[{"(", 
              RowBox[{
               RowBox[{"root", "/", "world"}], " ", "frame"}], ")"}], " ", 
             "to", " ", "o"}], " ", "*)"}], "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
              RowBox[{"transforms", " ", "are", " ", "root"}], " ", "\[Rule]",
               " ", 
              RowBox[{"b", " ", "\[Rule]", " ", 
               RowBox[{"c", " ", "\[Rule]", " ", "0"}]}]}], ",", " ", 
             RowBox[{"i", ".", "e"}], ",", " ", 
             RowBox[{
              RowBox[{"X", "[", 
               RowBox[{"o", ",", " ", "c"}], "]"}], ".", 
              RowBox[{"X", "[", 
               RowBox[{"c", ",", " ", "b"}], "]"}], ".", 
              RowBox[{"X", "[", 
               RowBox[{"b", ",", " ", "0"}], "]"}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"o", " ", "\[Equal]", " ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "XL0", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"R", " ", "=", " ", 
               RowBox[{
               "RL0", "\[LeftDoubleBracket]", "b", 
                "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"X", " ", "=", " ", 
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", 
                "\[RightDoubleBracket]"}]}], ";"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{
               "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
               " ", "=", " ", 
               RowBox[{
                RowBox[{
                "RL0", "\[LeftDoubleBracket]", "o", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "XL0", "\[LeftDoubleBracket]", "b", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"R", " ", "=", " ", 
               RowBox[{
                RowBox[{
                "RL0", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "R0L", "\[LeftDoubleBracket]", "o", 
                 "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
              RowBox[{"X", " ", "=", " ", 
               RowBox[{
                RowBox[{
                "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 ".", 
                RowBox[{
                "X0L", "\[LeftDoubleBracket]", "o", 
                 "\[RightDoubleBracket]"}]}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
            "spatial", " ", "position", " ", "of", " ", "constraint", " ", 
             "in", " ", "o", " ", "frame"}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "posXco", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
            " ", "=", " ", 
            RowBox[{
             RowBox[{
             "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], ".", 
             RowBox[{"posX", "[", 
              RowBox[{"X", ",", " ", "R"}], "]"}]}]}], ";", 
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "move", " ", "r", " ", "into", " ", "world", " ", "frame"}], ",",
              " ", 
             RowBox[{"ro", " ", "=", " ", 
              RowBox[{
               RowBox[{"r", "[", 
                RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
               RowBox[{"X", "[", 
                RowBox[{"o", ",", " ", "0"}], "]"}]}]}]}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "ro", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], " ",
             "=", " ", 
            RowBox[{
             RowBox[{
             "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], ".", 
             RowBox[{
             "Xo0", "\[LeftDoubleBracket]", "k", 
              "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{
             "move", " ", "rdot", " ", "into", " ", "world", " ", "frame"}], 
             ",", " ", 
             RowBox[{"rodot", " ", "=", " ", 
              RowBox[{
               RowBox[{"d", "/", "dt"}], 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"r", "[", 
                  RowBox[{"o", ",", " ", "o"}], "]"}], ".", 
                 RowBox[{"X", "[", 
                  RowBox[{"o", ",", " ", "0"}], "]"}]}], ")"}]}]}]}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"va", " ", "=", " ", 
            RowBox[{
            "v", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}]}], 
           ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"va", "\[LeftDoubleBracket]", 
             RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", "=", 
            " ", "z3"}], ";", " ", 
           RowBox[{"(*", " ", 
            RowBox[{
            "only", " ", "angular", " ", "vel", " ", "of", " ", "vb"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"vo0", " ", "=", " ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
              ".", "va"}], "-", 
             RowBox[{
              RowBox[{
              "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "v", "\[LeftDoubleBracket]", "b", 
               "\[RightDoubleBracket]"}]}]}]}], ";", " ", 
           RowBox[{"(*", " ", 
            RowBox[{
             RowBox[{"vel", " ", 
              RowBox[{"w", "/", " ", "o"}]}], " ", "=", " ", "0"}], " ", 
            "*)"}], "\[IndentingNewLine]", 
           RowBox[{"If", "[", 
            RowBox[{
             RowBox[{"o", " ", "\[NotEqual]", "  ", "0"}], ",", " ", 
             "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"va", " ", "=", " ", 
               RowBox[{
               "v", "\[LeftDoubleBracket]", "o", "\[RightDoubleBracket]"}]}], 
              ";", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"va", "\[LeftDoubleBracket]", 
                RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", "=",
                " ", "z3"}], ";", " ", 
              RowBox[{"(*", " ", 
               RowBox[{
               "only", " ", "angular", " ", "vel", " ", "of", " ", "vo"}], 
               " ", "*)"}], "\[IndentingNewLine]", 
              RowBox[{"vb", " ", "=", " ", 
               RowBox[{
                RowBox[{
                "RL0", "\[LeftDoubleBracket]", "o", "\[RightDoubleBracket]"}],
                 ".", "vo0"}]}], ";", " ", 
              RowBox[{"(*", " ", 
               RowBox[{"avoid", " ", "multiplication", " ", "bug"}], " ", 
               "*)"}], "\[IndentingNewLine]", 
              RowBox[{"vo0", " ", "=", " ", 
               RowBox[{"vb", " ", "-", " ", "va"}]}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
           RowBox[{"Xdot", " ", "=", " ", 
            RowBox[{"mxX", "[", 
             RowBox[{"vo0", ",", " ", 
              RowBox[{
              "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}],
              "]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{
            "rodot", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
            " ", "=", "  ", 
            RowBox[{
             RowBox[{
              RowBox[{
              "rdot", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", 
              RowBox[{
              "Xo0", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}],
              " ", "+", " ", 
             RowBox[{
              RowBox[{
              "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], 
              ".", "Xdot"}]}]}], ";"}], ",", " ", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"k", ",", " ", 
            RowBox[{"Length", "@", "bo"}]}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{"timerb", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";", "\[IndentingNewLine]", 
        RowBox[{"Print", "[", 
         RowBox[{"\"\<rs0: \>\"", ",", " ", 
          RowBox[{"timerb", " ", "-", " ", "timera"}]}], "]"}], ";"}]}], 
      "\[IndentingNewLine]", "]"}]}], ";"}], "*)"}]}]], "Input",
 InitializationCell->True,
 CellLabel->"In[662]:=",ExpressionUUID->"4f11343e-9caf-4b31-bb64-e922ec7ae3a3"]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["New JOSIM", \
"Section",ExpressionUUID->"82054c9b-ebf0-43ca-9f59-9485a6efd07a"],

Cell[BoxData[
 RowBox[{
  RowBox[{"(*", " ", "\[IndentingNewLine]", 
   RowBox[{
    RowBox[{
     RowBox[{"user", " ", 
      RowBox[{"inputs", ":", " ", "none"}]}], ";", "\[IndentingNewLine]", 
     RowBox[{"zeroed", " ", 
      RowBox[{"inputs", ":", " ", "XL0"}]}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"model", " ", 
      RowBox[{"data", ":", " ", "XL"}]}]}], ",", " ", "XLdot", ",", " ", 
    "parent", ",", " ", 
    RowBox[{"nq", ";", "\[IndentingNewLine]", 
     RowBox[{"modifies", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", ";", "\[IndentingNewLine]", 
     RowBox[{"output", ":", " ", "XL0"}]}], ",", " ", "X0L", ",", " ", 
    "XL0dot", ",", " ", 
    RowBox[{"X0Ldot", " ", 
     RowBox[{"(", 
      RowBox[{"transforms", " ", 
       RowBox[{"from", "/", "to"}], " ", "root"}], ")"}]}]}], 
   "\[IndentingNewLine]", "*)"}], "\[IndentingNewLine]", 
  "\[IndentingNewLine]", 
  RowBox[{
   RowBox[{
    RowBox[{"R0", "[", "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", " ", "R0L"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{"(*", 
       RowBox[{
        RowBox[{"timera", " ", "=", " ", 
         RowBox[{"AbsoluteTime", "[", "]"}]}], ";"}], "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compute", " ", "transform", " ", 
        RowBox[{"R", "[", 
         RowBox[{"0", ",", " ", "b"}], "]"}]}], " ", "*)"}], 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"R0L", " ", "=", " ", "XL"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Do", "[", "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{"XL", "[", 
           RowBox[{"i", ",", " ", "p"}], "]"}], " ", "=", " ", 
          RowBox[{
           RowBox[{"(", 
            RowBox[{
             RowBox[{"R", "[", 
              RowBox[{"i", ",", " ", "p"}], "]"}], ",", " ", 
             RowBox[{"p", "[", 
              RowBox[{"i", ",", " ", "p"}], "]"}]}], ")"}], " ", "=", 
           RowBox[{
            RowBox[{">", " ", 
             RowBox[{"R0L", "[", 
              RowBox[{"0", ",", " ", "i"}], "]"}]}], " ", "=", " ", 
            RowBox[{
             RowBox[{"R0L", "[", 
              RowBox[{"0", ",", " ", "p"}], "]"}], ".", 
             RowBox[{
              RowBox[{"R", "[", 
               RowBox[{"i", ",", " ", "p"}], "]"}], "\[Transpose]"}]}]}]}]}], 
         " ", "*)"}], "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{
          RowBox[{"p", " ", "=", " ", 
           RowBox[{
           "parent", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}]}],
           ";", "\[IndentingNewLine]", 
          RowBox[{"If", "[", 
           RowBox[{
            RowBox[{"p", " ", ">", " ", "0"}], ",", " ", 
            "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"R0L", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", " ", 
                RowBox[{"1", ";;", "3"}], ",", " ", 
                RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{
               RowBox[{"R0L", "\[LeftDoubleBracket]", 
                RowBox[{"p", ",", " ", 
                 RowBox[{"1", ";;", "3"}], ",", " ", 
                 RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], ".", 
               RowBox[{
                RowBox[{"XL", "\[LeftDoubleBracket]", 
                 RowBox[{"i", ",", " ", 
                  RowBox[{"1", ";;", "3"}], ",", " ", 
                  RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
                "\[Transpose]"}]}]}], ";"}], ",", "\[IndentingNewLine]", 
            RowBox[{"(*", " ", "else", " ", "*)"}], "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{
              RowBox[{"R0L", "\[LeftDoubleBracket]", 
               RowBox[{"i", ",", 
                RowBox[{"1", ";;", "3"}], ",", 
                RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", 
              "=", " ", 
              RowBox[{
               RowBox[{"XL", "\[LeftDoubleBracket]", 
                RowBox[{"i", ",", " ", 
                 RowBox[{"1", ";;", "3"}], ",", " ", 
                 RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], 
               "\[Transpose]"}]}], ";"}]}], "\[IndentingNewLine]", "]"}], ";",
           "\[IndentingNewLine]", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"4", ";;", "6"}], ",", 
             RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", 
           RowBox[{"R0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"1", ";;", "3"}], ",", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}]}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{"R0L", "\[LeftDoubleBracket]", 
            RowBox[{"i", ",", 
             RowBox[{"4", ";;", "6"}], ",", 
             RowBox[{"1", ";;", "3"}]}], "\[RightDoubleBracket]"}], " ", "=", 
           " ", "Z3"}], ";"}], ",", "\[IndentingNewLine]", 
         RowBox[{"{", 
          RowBox[{"i", ",", " ", "bx"}], "}"}]}], " ", 
        RowBox[{"(*", " ", 
         RowBox[{
         "bx", " ", "must", " ", "be", " ", "ordered", " ", "so", " ", "that",
           " ", "parent", " ", "comes", " ", "before", " ", "child"}], " ", 
         "*)"}], "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]",
      "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"Print", "[", 
        RowBox[{"\"\<R0: \>\"", ",", " ", 
         RowBox[{
          RowBox[{"AbsoluteTime", "[", "]"}], " ", "-", " ", "timera"}]}], 
        "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "]"}]}], 
   ";"}]}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[663]:=",ExpressionUUID->"be203c07-e595-49ff-bf9d-7ca9689b60f9"],

Cell[BoxData[
 RowBox[{"(*", " ", 
  RowBox[{
  "\[Eta]", " ", "is", " ", "also", " ", "useful", " ", "for", " ", 
   "constraint", " ", "stabilization"}], " ", "*)"}]], "Input",
 CellLabel->
  "In[664]:=",ExpressionUUID->"3df2b961-1d9e-4934-a1f0-3be89eb04ac1"],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"Josim", "[", "]"}], " ", ":=", " ", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "Xcj", ",", " ", "b", ",", " ", "k", ",", " ", "n", ",", " ", "jj", ",",
        " ", "aa", ",", " ", "vv", ",", " ", "ii", ",", " ", "kk", ",", " ", 
       "nn", ",", " ", "j", ",", " ", "ja", ",", " ", "i", ",", " ", "X", ",",
        " ", "vc", ",", " ", "vrel", ",", " ", "Xdot", ",", " ", "sc", " ", 
       ",", "scdot", ",", " ", "p", ",", " ", "pos"}], "}"}], ",", 
     "\[IndentingNewLine]", 
     RowBox[{"(*", 
      RowBox[{
       RowBox[{"timera", " ", "=", " ", 
        RowBox[{"AbsoluteTime", "[", "]"}]}], ";"}], "*)"}], 
     "\[IndentingNewLine]", "\[IndentingNewLine]", 
     RowBox[{"(*", " ", 
      RowBox[{
       RowBox[{"let", " ", 
        RowBox[{"{", 
         RowBox[{"c", "'"}], "}"}], " ", "be", " ", "a", " ", "frame", " ", 
        "at", " ", 
        RowBox[{"{", "c", "}"}]}], ",", " ", 
       RowBox[{"but", " ", "with", " ", "axes", " ", "aligned", " ", 
        RowBox[{"w", "/", " ", 
         RowBox[{"{", "0", "}"}]}]}]}], " ", "*)"}], "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"Xcj", " ", "=", " ", "Tcb"}], ";", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{"compute", " ", "X", " ", "transform", " ", "from", " ", 
        RowBox[{"{", "b", "}"}], " ", "to", " ", 
        RowBox[{"{", 
         RowBox[{"c", "'"}], "}"}]}], " ", "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"b", " ", "=", " ", 
          RowBox[{"bo", "\[LeftDoubleBracket]", 
           RowBox[{"k", ",", " ", "1"}], "\[RightDoubleBracket]"}]}], ";", 
         " ", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
          "Xcj", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}], " ", 
          "=", " ", 
          RowBox[{
           RowBox[{
           "R0L", "\[LeftDoubleBracket]", "b", "\[RightDoubleBracket]"}], ".", 
           RowBox[{
           "Tcb", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}]}]}], 
         ";"}], ",", " ", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"k", ",", " ", 
          RowBox[{"Length", "@", "bo"}]}], "}"}]}], "\[IndentingNewLine]", 
       "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
      RowBox[{"(*", " ", 
       RowBox[{
        RowBox[{
         RowBox[{
         "compute", " ", "J", " ", "and", " ", "\[Phi]", " ", "in", " ", 
          RowBox[{"J", ".", "a"}]}], " ", "+", " ", "\[Phi]"}], " ", "=", " ",
         "0"}], "*)"}], "\[IndentingNewLine]", 
      RowBox[{"Do", "[", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{
         RowBox[{"n", " ", "=", " ", 
          RowBox[{"Length", "@", 
           RowBox[{
           "ba", "\[LeftDoubleBracket]", "c", "\[RightDoubleBracket]"}]}]}], 
         ";", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"{", 
           RowBox[{
           "jj", ",", " ", "aa", ",", " ", "vv", ",", " ", "ii", ",", " ", 
            "kk"}], "}"}], " ", "=", " ", 
          RowBox[{
           RowBox[{"Select", "[", 
            RowBox[{
             RowBox[{"ba", "\[LeftDoubleBracket]", 
              RowBox[{"c", ",", " ", 
               RowBox[{"1", ";;", "n"}]}], "\[RightDoubleBracket]"}], ",", 
             " ", 
             RowBox[{
              RowBox[{
               RowBox[{
               "#", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], 
               " ", "\[NotEqual]", " ", "0"}], "&"}]}], "]"}], 
           "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"nn", " ", "=", " ", 
          RowBox[{"Length", "@", "ii"}]}], ";", "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"all", " ", 
           RowBox[{
            RowBox[{
            "ba", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
            "'"}], "s", " ", "have", " ", "same", " ", "b", " ", 
           RowBox[{"(", 
            RowBox[{"=", " ", "j"}], ")"}], " ", "and", " ", "a", " ", "in", 
           " ", "their", " ", "arrays"}], " ", "*)"}], "\[IndentingNewLine]", 
         
         RowBox[{"j", " ", "=", " ", 
          RowBox[{"ba", "\[LeftDoubleBracket]", 
           RowBox[{"c", ",", " ", "1", ",", " ", "1"}], 
           "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"ja", " ", "=", " ", 
          RowBox[{"ba", "\[LeftDoubleBracket]", 
           RowBox[{"c", ",", " ", "1", ",", " ", "2"}], 
           "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
         RowBox[{"p", " ", "=", " ", 
          RowBox[{
          "parent", "\[LeftDoubleBracket]", "j", "\[RightDoubleBracket]"}]}], 
         ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"get", " ", "all", " ", "constraint", " ", 
           RowBox[{"i", "'"}], "s", " ", "and", " ", "corresponding", " ", 
           RowBox[{"k", "'"}], "s", " ", "that", " ", "would", " ", 
           "traverse"}], " ", "*)"}], 
         RowBox[{"(*", " ", 
          RowBox[{
          "the", " ", "same", " ", "path", " ", "up", " ", "the", " ", 
           "tree"}], " ", "*)"}], "\[IndentingNewLine]", 
         "\[IndentingNewLine]", 
         RowBox[{"(*", " ", 
          RowBox[{"perform", " ", 
           RowBox[{"(", 
            RowBox[{"branch", "-", "induced"}], ")"}], " ", "sparse", " ", 
           "matrix", " ", "multiplication"}], " ", "*)"}], 
         "\[IndentingNewLine]", 
         RowBox[{"While", "[", 
          RowBox[{
           RowBox[{"j", " ", ">", " ", "ja"}], ",", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"Do", "[", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{
               RowBox[{"i", " ", "=", " ", 
                RowBox[{
                "ii", "\[LeftDoubleBracket]", "cc", 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"k", " ", "=", " ", 
                RowBox[{
                "kk", "\[LeftDoubleBracket]", "cc", 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"c", "'"}], "}"}], " ", "=", 
                 RowBox[{">", " ", 
                  RowBox[{
                   RowBox[{"{", "c", "}"}], " ", "in", " ", 
                   RowBox[{"{", "b", "}"}], " ", "with", " ", "axes", " ", 
                   "aligned", " ", "with", " ", 
                   RowBox[{"{", "0", "}"}]}]}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"X", " ", "=", " ", 
                RowBox[{
                "Xcj", "\[LeftDoubleBracket]", "k", 
                 "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"vc", " ", "=", " ", 
                RowBox[{
                 RowBox[{"X", "\[LeftDoubleBracket]", 
                  RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], ".", 
                 RowBox[{
                 "v", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}], ";", "  ", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"{", 
                  RowBox[{"c", "'"}], "}"}], " ", "is", " ", "not", " ", 
                 "rotating"}], " ", "*)"}], "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{"compute", " ", 
                 RowBox[{"d", "/", "dt"}], " ", "Xc"}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"vrel", " ", "=", " ", 
                RowBox[{"X", ".", 
                 RowBox[{
                 "v", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"vrel", "\[LeftDoubleBracket]", 
                 RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", 
                "=", " ", 
                RowBox[{
                 RowBox[{"vrel", "\[LeftDoubleBracket]", 
                  RowBox[{"4", ";;", "6"}], "\[RightDoubleBracket]"}], " ", 
                 "-", " ", "vc"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"Xdot", " ", "=", " ", 
                RowBox[{"mxX", "[", 
                 RowBox[{"vrel", ",", " ", "X"}], "]"}]}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{"compute", " ", "s", " ", "in", " ", 
                 RowBox[{"{", "c", "}"}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"sc", " ", "=", " ", 
                RowBox[{"X", ".", 
                 RowBox[{
                 "s", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"scdot", " ", "=", " ", 
                RowBox[{
                 RowBox[{"Xdot", ".", 
                  RowBox[{
                  "s", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}], " ", "+", " ", 
                 RowBox[{"X", ".", 
                  RowBox[{
                  "sdot", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}]}]}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{"compute", " ", "J"}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"J", "\[LeftDoubleBracket]", 
                 RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], " ",
                 "=", " ", 
                RowBox[{
                 RowBox[{"J", "\[LeftDoubleBracket]", 
                  RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], 
                 " ", "+", " ", 
                 RowBox[{
                  RowBox[{
                  "r", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                   ".", "sc"}]}]}], ";", "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"compute", " ", "\[Phi]"}], " ", "=", " ", 
                 RowBox[{"\[Phi]", " ", "+", " ", 
                  RowBox[{"Jdot", " ", "qd"}]}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                "\[Phi]", "\[LeftDoubleBracket]", "i", 
                 "\[RightDoubleBracket]"}], " ", "=", " ", 
                RowBox[{
                 RowBox[{
                 "\[Phi]", "\[LeftDoubleBracket]", "i", 
                  "\[RightDoubleBracket]"}], " ", "+", " ", 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{
                    RowBox[{
                    "rdot", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], ".", "sc"}], " ", "+", " ", 
                    RowBox[{
                    RowBox[{
                    "r", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], ".", "scdot"}]}], ")"}], " ", 
                  RowBox[{
                  "qd", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}]}]}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"compute", " ", "hdot"}], ",", " ", 
                 RowBox[{"\[Eta]", " ", "=", " ", 
                  RowBox[{"(", 
                   RowBox[{"h", ",", " ", "hdot"}], ")"}]}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                "also", " ", "useful", " ", "for", " ", "constraint", " ", 
                 "stabilization"}], " ", "*)"}], "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{
                  "vv", "\[LeftDoubleBracket]", "k", 
                   "\[RightDoubleBracket]"}], " ", "\[LessEqual]", " ", "1"}],
                  ",", " ", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                   " ", "=", " ", 
                   RowBox[{
                    RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"2", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                    " ", "+", " ", 
                    RowBox[{
                    RowBox[{"J", "\[LeftDoubleBracket]", 
                    RowBox[{"i", ",", " ", "j"}], "\[RightDoubleBracket]"}], 
                    " ", 
                    RowBox[{
                    "qd", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}]}], ";"}]}], "]"}], ";", 
               "\[IndentingNewLine]", "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{"continue", " ", "up", " ", "the", " ", "path"}], " ",
                 "*)"}], "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                "Xcj", "\[LeftDoubleBracket]", "k", "\[RightDoubleBracket]"}],
                 " ", "=", " ", 
                RowBox[{"X", ".", 
                 RowBox[{
                 "XL", "\[LeftDoubleBracket]", "j", 
                  "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]", 
               "\[IndentingNewLine]", 
               RowBox[{"(*", " ", 
                RowBox[{
                 RowBox[{"compute", " ", "h"}], ",", " ", 
                 RowBox[{"\[Eta]", " ", "=", " ", 
                  RowBox[{"(", 
                   RowBox[{"h", ",", " ", "hdot"}], ")"}]}]}], " ", "*)"}], 
               "\[IndentingNewLine]", 
               RowBox[{"If", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"p", " ", "\[Equal]", " ", "ja"}], " ", "&&", " ", 
                  RowBox[{
                   RowBox[{
                   "vv", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], " ", "\[LessEqual]", " ", 
                   "0"}]}], ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"pos", " ", "=", " ", 
                   RowBox[{"position", "[", 
                    RowBox[{
                    "Xcj", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], "]"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"1", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                   " ", "=", " ", 
                   RowBox[{
                    RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"1", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                    " ", "+", " ", 
                    RowBox[{
                    RowBox[{"r", "\[LeftDoubleBracket]", 
                    RowBox[{"k", ",", " ", 
                    RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], 
                    ".", "pos"}]}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
               ";"}], ",", "\[IndentingNewLine]", 
              RowBox[{"{", 
               RowBox[{"cc", ",", " ", "nn"}], "}"}]}], "\[IndentingNewLine]",
              "]"}], ";", "\[IndentingNewLine]", "\[IndentingNewLine]", 
            RowBox[{"j", " ", "=", " ", "p"}], ";", "\[IndentingNewLine]", 
            RowBox[{"If", "[", 
             RowBox[{
              RowBox[{"j", " ", ">", " ", "0"}], ",", " ", 
              RowBox[{
               RowBox[{"p", " ", "=", " ", 
                RowBox[{
                "parent", "\[LeftDoubleBracket]", "j", 
                 "\[RightDoubleBracket]"}]}], ";"}]}], "]"}], ";"}]}], 
          "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
        RowBox[{"{", 
         RowBox[{"c", ",", " ", 
          RowBox[{"Length", "@", "ba"}]}], "}"}]}], "\[IndentingNewLine]", 
       "]"}], ";"}]}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
    RowBox[{"(*", 
     RowBox[{
      RowBox[{"Print", "[", 
       RowBox[{"\"\<JOSIM2: \>\"", ",", " ", 
        RowBox[{
         RowBox[{"AbsoluteTime", "[", "]"}], " ", "-", " ", "timera"}]}], 
       "]"}], ";"}], "*)"}], "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 InitializationCell->True,
 CellLabel->
  "In[665]:=",ExpressionUUID->"9def98bf-69e3-47c9-bbe8-062477341c74"],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBDJ2", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"p", ",", " ", "vJ"}], "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"s", " ", "=", " ", 
        RowBox[{"sfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"sdot", " ", "=", " ", 
        RowBox[{"sdotfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"XL", " ", "=", " ", 
        RowBox[{"XLfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"r", " ", "=", " ", 
        RowBox[{"rfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"rdot", " ", "=", " ", 
        RowBox[{"rdotfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Tcb", " ", "=", " ", 
        RowBox[{"Tcbfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"J", " ", "=", " ", 
        RowBox[{"Jfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Phi]", " ", "=", " ", 
        RowBox[{"\[Phi]fun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"\[Eta]", " ", "=", " ", 
        RowBox[{"\[Eta]fun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"K", " ", "=", " ", 
        RowBox[{"Kfun", "[", 
         RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"bo", " ", "=", " ", 
        RowBox[{"rb", "[", 
         RowBox[{"C", ",", " ", "\"\<bo\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"ba", " ", "=", " ", 
        RowBox[{"rb", "[", 
         RowBox[{"C", ",", " ", "\"\<ba\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"bs", " ", "=", " ", 
        RowBox[{"rb", "[", 
         RowBox[{"C", ",", " ", "\"\<bs\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"bx", " ", "=", " ", 
        RowBox[{"rb", "[", 
         RowBox[{"C", ",", " ", "\"\<bx\>\""}], "]"}]}], ";", 
       "\[IndentingNewLine]", "\[IndentingNewLine]", 
       RowBox[{"(*", " ", 
        RowBox[{"for", " ", "computing", " ", "Xdot"}], " ", "*)"}], 
       "\[IndentingNewLine]", 
       RowBox[{"qd", " ", "=", " ", 
        RowBox[{"If", "[", 
         RowBox[{
          RowBox[{"x", " ", "===", " ", 
           RowBox[{"{", "}"}]}], ",", " ", 
          RowBox[{"Array", "[", 
           RowBox[{"\[DoubleStruckX]", ",", " ", "nq", ",", " ", 
            RowBox[{"nq", "+", "1"}]}], "]"}], ",", " ", 
          RowBox[{"x", "\[LeftDoubleBracket]", 
           RowBox[{
            RowBox[{"nq", "+", "1"}], ";;", "nx"}], 
           "\[RightDoubleBracket]"}]}], "]"}]}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"V", "[", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"R0", "[", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"Josim", "[", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"{", 
        RowBox[{"J", ",", " ", "\[Phi]"}], "}"}]}]}], "\[IndentingNewLine]", 
     "]"}]}], ";"}], "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{
    RowBox[{"RBD\[Eta]2", "[", 
     RowBox[{
      RowBox[{"x_:", 
       RowBox[{"{", "}"}]}], ",", " ", 
      RowBox[{"\[Lambda]_:", 
       RowBox[{"{", "}"}]}]}], "]"}], " ", ":=", " ", 
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"RBDJ2", "[", 
        RowBox[{"x", ",", " ", "\[Lambda]"}], "]"}], ";", 
       "\[IndentingNewLine]", "\[Eta]"}]}], "\[IndentingNewLine]", "]"}]}], 
   ";"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
  "\[IndentingNewLine]"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{
    RowBox[{
     RowBox[{"Josim", "[", "]"}], " ", ":=", " ", 
     RowBox[{"Module", "[", 
      RowBox[{
       RowBox[{"{", 
        RowBox[{
        "Xcj", ",", " ", "b", ",", " ", "k", ",", " ", "n", ",", " ", "jj", 
         ",", " ", "aa", ",", " ", "vv", ",", " ", "ii", ",", " ", "kk", ",", 
         " ", "nn", ",", " ", "j", ",", " ", "ja", ",", " ", "i", ",", " ", 
         "X", ",", " ", "vc", ",", " ", "vrel", ",", " ", "Xdot", ",", " ", 
         "sc", " ", ",", "scdot", ",", " ", "p", ",", " ", "pos"}], "}"}], 
       ",", "\[IndentingNewLine]", 
       RowBox[{
        RowBox[{"Xcj", " ", "=", " ", "Tcb"}], ";", "\[IndentingNewLine]", 
        "\[IndentingNewLine]", 
        RowBox[{"(*", " ", 
         RowBox[{
          RowBox[{
           RowBox[{
           "compute", " ", "J", " ", "and", " ", "\[Phi]", " ", "in", " ", 
            RowBox[{"J", ".", "a"}]}], " ", "+", " ", "\[Phi]"}], " ", "=", 
          " ", "0"}], "*)"}], "\[IndentingNewLine]", 
        RowBox[{"Do", "[", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{
           RowBox[{"n", " ", "=", " ", 
            RowBox[{"Length", "@", 
             RowBox[{
             "ba", "\[LeftDoubleBracket]", "c", "\[RightDoubleBracket]"}]}]}],
            ";", "\[IndentingNewLine]", 
           RowBox[{
            RowBox[{"{", 
             RowBox[{
             "jj", ",", " ", "aa", ",", " ", "vv", ",", " ", "ii", ",", " ", 
              "kk"}], "}"}], " ", "=", " ", 
            RowBox[{
             RowBox[{"Select", "[", 
              RowBox[{
               RowBox[{"ba", "\[LeftDoubleBracket]", 
                RowBox[{"c", ",", " ", 
                 RowBox[{"1", ";;", "n"}]}], "\[RightDoubleBracket]"}], ",", 
               " ", 
               RowBox[{
                RowBox[{
                 RowBox[{
                 "#", "\[LeftDoubleBracket]", "4", "\[RightDoubleBracket]"}], 
                 " ", "\[NotEqual]", " ", "0"}], "&"}]}], "]"}], 
             "\[Transpose]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"nn", " ", "=", " ", 
            RowBox[{"Length", "@", "ii"}]}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"all", " ", 
             RowBox[{
              RowBox[{
              "ba", "\[LeftDoubleBracket]", "i", "\[RightDoubleBracket]"}], 
              "'"}], "s", " ", "have", " ", "same", " ", "b", " ", 
             RowBox[{"(", 
              RowBox[{"=", " ", "j"}], ")"}], " ", "and", " ", "a", " ", "in",
              " ", "their", " ", "arrays"}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"j", " ", "=", " ", 
            RowBox[{"ba", "\[LeftDoubleBracket]", 
             RowBox[{"c", ",", " ", "1", ",", " ", "1"}], 
             "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"ja", " ", "=", " ", 
            RowBox[{"ba", "\[LeftDoubleBracket]", 
             RowBox[{"c", ",", " ", "1", ",", " ", "2"}], 
             "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
           RowBox[{"p", " ", "=", " ", 
            RowBox[{
            "parent", "\[LeftDoubleBracket]", "j", 
             "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"get", " ", "all", " ", "constraint", " ", 
             RowBox[{"i", "'"}], "s", " ", "and", " ", "corresponding", " ", 
             RowBox[{"k", "'"}], "s", " ", "that", " ", "would", " ", 
             "traverse"}], " ", "*)"}], 
           RowBox[{"(*", " ", 
            RowBox[{
            "the", " ", "same", " ", "path", " ", "up", " ", "the", " ", 
             "tree"}], " ", "*)"}], "\[IndentingNewLine]", 
           "\[IndentingNewLine]", 
           RowBox[{"(*", " ", 
            RowBox[{"perform", " ", 
             RowBox[{"(", 
              RowBox[{"branch", "-", "induced"}], ")"}], " ", "sparse", " ", 
             "matrix", " ", "multiplication"}], " ", "*)"}], 
           "\[IndentingNewLine]", 
           RowBox[{"While", "[", 
            RowBox[{
             RowBox[{"j", " ", ">", " ", "ja"}], ",", "\[IndentingNewLine]", 
             RowBox[{
              RowBox[{"Do", "[", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{
                 RowBox[{"i", " ", "=", " ", 
                  RowBox[{
                  "ii", "\[LeftDoubleBracket]", "cc", 
                   "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                 RowBox[{"k", " ", "=", " ", 
                  RowBox[{
                  "kk", "\[LeftDoubleBracket]", "cc", 
                   "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                 "\[IndentingNewLine]", 
                 RowBox[{"(*", " ", 
                  RowBox[{
                   RowBox[{"{", 
                    RowBox[{"c", "'"}], "}"}], " ", "=", 
                   RowBox[{">", " ", 
                    RowBox[{
                    RowBox[{"{", "c", "}"}], " ", "in", " ", 
                    RowBox[{"{", "b", "}"}], " ", "with", " ", "axes", " ", 
                    "aligned", " ", "with", " ", 
                    RowBox[{"{", "0", "}"}]}]}]}], " ", "*)"}], 
                 "\[IndentingNewLine]", 
                 RowBox[{"X", " ", "=", " ", 
                  RowBox[{
                  "Xcj", "\[LeftDoubleBracket]", "k", 
                   "\[RightDoubleBracket]"}]}], ";", "\[IndentingNewLine]", 
                 RowBox[{"(*", " ", 
                  RowBox[{"continue", " ", "up", " ", "the", " ", "path"}], 
                  " ", "*)"}], "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{
                  "Xcj", "\[LeftDoubleBracket]", "k", 
                   "\[RightDoubleBracket]"}], " ", "=", " ", 
                  RowBox[{"X", ".", 
                   RowBox[{
                   "XL", "\[LeftDoubleBracket]", "j", 
                    "\[RightDoubleBracket]"}]}]}], ";", "\[IndentingNewLine]",
                  "\[IndentingNewLine]", 
                 RowBox[{"(*", " ", 
                  RowBox[{
                   RowBox[{"compute", " ", "h"}], ",", " ", 
                   RowBox[{"\[Eta]", " ", "=", " ", 
                    RowBox[{"(", 
                    RowBox[{"h", ",", " ", "hdot"}], ")"}]}]}], " ", "*)"}], 
                 "\[IndentingNewLine]", 
                 RowBox[{"If", "[", 
                  RowBox[{
                   RowBox[{
                    RowBox[{"p", " ", "\[Equal]", " ", "ja"}], " ", "&&", " ", 
                    RowBox[{
                    RowBox[{
                    "vv", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], " ", "\[LessEqual]", " ", 
                    "0"}]}], ",", "\[IndentingNewLine]", 
                   RowBox[{
                    RowBox[{"pos", " ", "=", " ", 
                    RowBox[{"position", "[", 
                    RowBox[{
                    "Xcj", "\[LeftDoubleBracket]", "k", 
                    "\[RightDoubleBracket]"}], "]"}]}], ";", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"1", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                    " ", "=", " ", 
                    RowBox[{
                    RowBox[{"\[Eta]", "\[LeftDoubleBracket]", 
                    RowBox[{"1", ",", " ", "i"}], "\[RightDoubleBracket]"}], 
                    " ", "+", " ", 
                    RowBox[{
                    RowBox[{"r", "\[LeftDoubleBracket]", 
                    RowBox[{"k", ",", " ", 
                    RowBox[{"4", ";;", "6"}]}], "\[RightDoubleBracket]"}], 
                    ".", "pos"}]}]}], ";"}]}], "\[IndentingNewLine]", "]"}], 
                 ";"}], ",", "\[IndentingNewLine]", 
                RowBox[{"{", 
                 RowBox[{"cc", ",", " ", "nn"}], "}"}]}], 
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
              "\[IndentingNewLine]", 
              RowBox[{"j", " ", "=", " ", "p"}], ";", "\[IndentingNewLine]", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"j", " ", ">", " ", "0"}], ",", " ", 
                RowBox[{
                 RowBox[{"p", " ", "=", " ", 
                  RowBox[{
                  "parent", "\[LeftDoubleBracket]", "j", 
                   "\[RightDoubleBracket]"}]}], ";"}]}], "]"}], ";"}]}], 
            "\[IndentingNewLine]", "]"}], ";"}], ",", "\[IndentingNewLine]", 
          RowBox[{"{", 
           RowBox[{"c", ",", " ", 
            RowBox[{"Length", "@", "ba"}]}], "}"}]}], "\[IndentingNewLine]", 
         "]"}], ";"}]}], "\[IndentingNewLine]", "]"}]}], ";"}], 
   "*)"}]}]}], "Input",
 InitializationCell->True,
 CellLabel->"In[666]:=",ExpressionUUID->"83e6d268-cd5b-45e3-b210-600c45ab35be"]
}, Open  ]],

Cell[CellGroupData[{

Cell["End Package", \
"Section",ExpressionUUID->"e7c13ee3-781c-4fda-82e2-df2d0817ec72"],

Cell[CellGroupData[{

Cell[BoxData[{
 RowBox[{"End", "[", "]"}], "\[IndentingNewLine]", 
 RowBox[{"EndPackage", "[", "]"}]}], "Input",
 InitializationCell->True,
 CellLabel->
  "In[668]:=",ExpressionUUID->"4d3abfac-2b5e-4279-8475-ac09ba58c6ba"],

Cell[BoxData["\<\"RigidBodyDynamics`Private`\"\>"], "Output",
 CellLabel->"Out[668]=",ExpressionUUID->"853926dd-1479-49e8-bd88-6ac771a1842d"]
}, Open  ]]
}, Open  ]]
},
AutoGeneratedPackage->Automatic,
Evaluator->"Local",
WindowSize->{1244, 1376},
WindowMargins->{{72, Automatic}, {0, Automatic}},
PrivateNotebookOptions->{"FileOutlineCache"->False},
CellContext->"Global`",
TrackCellChangeTimes->False,
FrontEndVersion->"11.3 for Linux x86 (64-bit) (March 6, 2018)",
StyleDefinitions->"Default.nb"
]

